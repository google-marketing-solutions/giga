<!--
Copyright 2025 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<html>
  <head>
    <title>GIGA</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js & React Chart.js 2 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- We'll use raw Chart.js in React for simplicity with CDN, or we can try react-chartjs-2 if we load it right.
         For stability in CDN usage, direct Chart.js usage inside useEffect is often safer/easier than configuring UMD for react-chartjs-2. -->

    <style>
      :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --secondary: #64748b;
        --bg-color: #f8fafc;
        --surface-color: #ffffff;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
        --success: #10b981;
        --error: #ef4444;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Outfit', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
      }

      #root {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Premium UI Components */
      .card {
        background: var(--surface-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-lg);
      }

      h1, h2, h3 {
        margin-top: 0;
        font-weight: 600;
        color: var(--text-main);
      }

      h1 { font-size: 3rem; letter-spacing: -0.025em; background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.5rem; }
      h2 { font-size: 1.5rem; margin-bottom: 1rem; }
      h3 { font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-secondary); }

      /* Inputs */
      .input-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--text-secondary);
      }

      input[type="text"], textarea, select {
        width: 100%;
        padding: 10px 14px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s;
        box-sizing: border-box;
      }

      input[type="text"]:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        background: white;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.4);
      }

      .btn-primary:active:not(:disabled) {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        filter: grayscale(1);
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: rgba(255, 255, 255, 0.5);
        padding: 6px;
        border-radius: var(--radius-lg);
        backdrop-filter: blur(8px);
        border: 1px solid var(--border-color);
        overflow-x: auto;
      }

      .tab-btn {
        padding: 10px 20px;
        border-radius: var(--radius-md);
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .tab-btn.active {
        background: white;
        color: var(--primary);
        box-shadow: var(--shadow-sm);
        font-weight: 600;
      }

      .tab-btn:hover:not(.active) {
        background: rgba(255, 255, 255, 0.8);
        color: var(--text-main);
      }

      /* Loading & Status */
      .status-msg {
        margin-top: 12px;
        padding: 12px;
        border-radius: var(--radius-md);
        background: #eff6ff;
        color: #1e40af;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Helper classes */
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
      .mt-4 { margin-top: 1rem; }
      .mb-4 { margin-bottom: 1rem; }
      .text-sm { font-size: 0.875rem; }
      .text-muted { color: var(--text-secondary); }

      /* Chart Container */
      .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-top: 20px;
      }
      .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease-out;
      }
      .modal-content {
        background: var(--surface-color);
        padding: 2rem;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-lg);
        width: 90%; max-width: 500px;
        animation: slideUp 0.2s ease-out;
      }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

      /* Spinner */
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
      .modal-header h3 { margin: 0; font-size: 1.25rem; }
      .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- Backend Proxy -->
    <script>
      const googleScriptRun = new Proxy({}, {
        get: (target, prop) => (...args) => {
          console.log(`Running ${prop} in AppsScript backend...`);
          return new Promise((resolve, reject) => {
            if (!google.script.run) {
               // Mock for local dev if needed, or just fail
               reject(new Error("google.script.run not available"));
               return;
            }
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              [prop](...args);
          });
        }
      });
    </script>

    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo } = React;

      // --- Constants & Data ---
      const COLOR_PALETTE = ['#4f6d7a', '#c0d6df', '#dbe9ee', '#4a6fa5', '#166088'];

      const LANGUAGES = [
        { id: '1000', name: 'English' }, { id: '1001', name: 'German' }, { id: '1002', name: 'French' },
        { id: '1003', name: 'Spanish' }, { id: '1004', name: 'Italian' }, { id: '1009', name: 'Danish' },
        { id: '1010', name: 'Dutch' }, { id: '1011', name: 'Finnish' }, { id: '1015', name: 'Swedish' },
        { id: '1020', name: 'Bulgarian' }, { id: '1021', name: 'Czech' }, { id: '1022', name: 'Greek' },
        { id: '1024', name: 'Hungarian' }, { id: '1028', name: 'Latvian' }, { id: '1029', name: 'Lithuanian' },
        { id: '1030', name: 'Polish' }, { id: '1031', name: 'Russian' }, { id: '1032', name: 'Romanian' },
        { id: '1033', name: 'Slovak' }, { id: '1034', name: 'Slovenian' }, { id: '1036', name: 'Ukrainian' },
        { id: '1038', name: 'Catalan' }, { id: '1039', name: 'Croatian' }, { id: '1043', name: 'Estonian' },
        { id: '1064', name: 'Persian' }
      ];

      const COUNTRIES = [
        { id: '', name: 'Worldwide' },
        { id: '2276', name: 'Germany' }, { id: '2826', name: 'UK' }, { id: '2250', name: 'France' },
        { id: '2380', name: 'Italy' }, { id: '2756', name: 'Switzerland' }, { id: '2724', name: 'Spain' },
        { id: '2616', name: 'Poland' }, { id: '2642', name: 'Romania' }, { id: '2528', name: 'Netherlands' },
        { id: '2056', name: 'Belgium' }, { id: '2203', name: 'Czechia' }, { id: '2300', name: 'Greece' },
        { id: '2620', name: 'Portugal' }, { id: '2752', name: 'Sweden' }, { id: '2348', name: 'Hungary' },
        { id: '2040', name: 'Austria' }, { id: '2100', name: 'Bulgaria' }, { id: '2208', name: 'Denmark' },
        { id: '2703', name: 'Slovakia' }, { id: '2246', name: 'Finland' }, { id: '2372', name: 'Ireland' },
        { id: '2191', name: 'Croatia' }, { id: '2440', name: 'Lithuania' }, { id: '2705', name: 'Slovenia' },
        { id: '2428', name: 'Latvia' }, { id: '2233', name: 'Estonia' }, { id: '2196', name: 'Cyprus' },
        { id: '2442', name: 'Luxembourg' }, { id: '2470', name: 'Malta' }
      ];

      const DEFAULT_PROMPT = `You are given a list of Google Ads keyword ideas.
Your task is to create 10 clusters. For each cluster use only up to 20 keywords that are most representative of that cluster.
Make sure to only assign the keywords provided to the cluster and do not invent new keywords.
All keywords assigned to a cluster must be exactly the same (e.g. same case, same spacing, same accents).

The Google Ads keyword ideas are:
`;

      // --- Components ---

      // eslint-disable-next-line no-unused-vars
      const TabButton = ({ active, onClick, children }) => (
        <button className={`tab-btn ${active ? 'active' : ''}`} onClick={onClick}>
          {children}
        </button>
      );

      // eslint-disable-next-line no-unused-vars
      const InputField = ({ label, type = "text", value, onChange, placeholder, rows, helpText, onKeyDown }) => (
        <div className="input-group">
          <label>{label}</label>
          {type === 'textarea' ? (
            <textarea rows={rows || 4} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} onKeyDown={onKeyDown} />
          ) : (
            <input type={type} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} onKeyDown={onKeyDown} />
          )}
          {helpText && <div className="text-sm text-muted mt-1">{helpText}</div>}
        </div>
      );

      // eslint-disable-next-line no-unused-vars
      const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
              <div className="modal-header">
                <h3>{title}</h3>
                <button className="btn" onClick={onClose} style={{padding: '4px 8px'}}>&times;</button>
              </div>
              {children}
            </div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const SelectField = ({ label, value, onChange, options, onCustomOption }) => {
        const handleChange = (e) => {
          if (e.target.value === 'custom') {
            onCustomOption();
          } else {
            onChange(e.target.value);
          }
        };
        return (
          <div className="input-group">
            <label>{label}</label>
            <div className="select-wrapper">
              <select value={value} onChange={handleChange}>
                {options.map(opt => (
                  <option key={opt.id} value={opt.id}>{opt.name}</option>
                ))}
                {onCustomOption && <option value="custom">Custom ID...</option>}
              </select>
            </div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ChartComponent = ({ type, data, options }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
          if (canvasRef.current) {
            if (chartRef.current) chartRef.current.destroy();
            chartRef.current = new Chart(canvasRef.current, { type, data, options });
          }
          return () => { if (chartRef.current) chartRef.current.destroy(); };
        }, [type, data, options]);

        return <div className="chart-container"><canvas ref={canvasRef} /></div>;
      };

      // --- Hooks ---
      function useStickyState(defaultValue, key) {
        const [value, setValue] = useState(() => {
          try {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          } catch (error) {
            console.warn(`Error reading localStorage key "${key}":`, error);
            return defaultValue;
          }
        });
        useEffect(() => {
          try {
            window.localStorage.setItem(key, JSON.stringify(value));
          } catch (error) {
            console.warn(`Error writing localStorage key "${key}":`, error);
          }
        }, [key, value]);
        return [value, setValue];
      }

      // --- Main App ---

      // eslint-disable-next-line no-unused-vars
      const GigaApp = ({ onReset }) => {
        const [activeTab, setActiveTab] = useStickyState('explore', 'giga_activeTab');

        // Explore State
        const [keywords, setKeywords] = useStickyState('', 'giga_keywords');
        const [language, setLanguage] = useStickyState('1000', 'giga_language');
        const [country, setCountry] = useStickyState('', 'giga_country');
        const [customLanguages, setCustomLanguages] = useStickyState([], 'giga_customLanguages');
        const [customCountries, setCustomCountries] = useStickyState([], 'giga_customCountries');
        const [promptTemplate, setPromptTemplate] = useStickyState(DEFAULT_PROMPT, 'giga_promptTemplate');
        const [exploreStatus, setExploreStatus] = useState('');
        const [isExploring, setIsExploring] = useState(false);
        const [ideasData, setIdeasData] = useStickyState(null, 'giga_ideasData');
        const [clusters, setClusters] = useStickyState(null, 'giga_clusters');
        const [relevantIdeas, setRelevantIdeas] = useStickyState({}, 'giga_relevantIdeas');
        const [selectedCluster, setSelectedCluster] = useState(null);
        const [chartLabels, setChartLabels] = useStickyState([], 'giga_chartLabels');
        const [minSearchVolume, setMinSearchVolume] = useStickyState(100, 'giga_minSearchVolume');

        // Insights State
        const [insights, setInsights] = useStickyState('', 'giga_insights');
        const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);
        const [insightsStatus, setInsightsStatus] = useState('');

        // Campaigns State
        const [adsAccountId, setAdsAccountId] = useStickyState('', 'giga_adsAccountId');
        const [brandName, setBrandName] = useStickyState('', 'giga_brandName');
        const [campaignSuggestions, setCampaignSuggestions] = useStickyState('', 'giga_campaignSuggestions');
        const [isGeneratingCampaigns, setIsGeneratingCampaigns] = useState(false);
        const [campaignStatus, setCampaignStatus] = useState('');

        // Campaign Creation State
        const [creationAccountId, setCreationAccountId] = useStickyState('111-222-3333', 'giga_creationAccountId');
        const [creationPromptTemplate, setCreationPromptTemplate] = useStickyState('', 'giga_creationPromptTemplate');
        const [creationStyleGuide, setCreationStyleGuide] = useStickyState('<?= DEFAULT_STYLE_GUIDE ?>', 'giga_creationStyleGuide');
        const [creationInstructions, setCreationInstructions] = useStickyState('Created ads must be in German.', 'giga_creationInstructions');
        const [creationKeywords, setCreationKeywords] = useStickyState('', 'giga_creationKeywords');
        const [growthMetric, setGrowthMetric] = useStickyState('yoy', 'growthMetric');
        const [creationResult, setCreationResult] = useStickyState('', 'giga_creationResult');
        const [isCreatingCampaign, setIsCreatingCampaign] = useState(false);

        const GROWTH_METRICS = [
          { id: 'yoy', name: 'Year over Year' },
          { id: 'mom', name: 'Month over Month' },
          { id: 'latest_vs_avg', name: 'Latest vs Average' },
          { id: 'latest_vs_max', name: 'Last Month vs Max' }
        ];

        const clearCache = () => {
          if (confirm('Are you sure you want to clear all cached data? This will reset the application state.')) {
            localStorage.clear();
            onReset();
          }
        };

        // Handlers
        const [modalConfig, setModalConfig] = useState({ isOpen: false, type: '', value: '' });

        const handleCustomOption = (type) => {
          setModalConfig({ isOpen: true, type, value: '' });
        };

        const submitModal = () => {
          const { type, value } = modalConfig;
          if (value && !isNaN(Number(value))) {
            if (type === 'language') {
              setCustomLanguages([...customLanguages, { id: value, name: value }]);
              setLanguage(value);
            } else {
              setCustomCountries([...customCountries, { id: value, name: value }]);
              setCountry(value);
            }
            setModalConfig({ isOpen: false, type: '', value: '' });
          } else {
            alert('Only Number IDs are allowed.');
          }
        };

        const runExplore = async () => {
          if (!keywords.trim()) {
            alert('Please enter at least one seed keyword.');
            return;
          }
          const seedKeywords = keywords.split(',').map(k => k.trim()).filter(Boolean);
          if (seedKeywords.length > 20) {
            alert('Maximum 20 keywords allowed.');
            return;
          }

          setIsExploring(true);
          setExploreStatus('Getting keyword ideas...');
          setIdeasData(null);
          setClusters(null);
          setSelectedCluster(null);

          try {
            const ideas = await googleScriptRun.generateKeywordIdeas(
              seedKeywords, country || undefined, language || undefined, 5000
            );

            const validIdeas = ideas.filter(res => res.keywordIdeaMetrics !== undefined);

            const processedIdeas = validIdeas.flatMap(idea =>
              (idea.closeVariants || []).concat(idea.text).map(k => [k, idea])
            ).map(([k, res]) => ({
              text: k,
              searchVolume: res.keywordIdeaMetrics.monthlySearchVolumes.map(item => Number(item.monthlySearches)),
              months: res.keywordIdeaMetrics.monthlySearchVolumes.map(item => `${item.month} ${item.year}`)
            }));

            if (processedIdeas.length > 0) {
              setChartLabels(processedIdeas[0].months.slice());
            }

            setIdeasData(processedIdeas);

            // Filter relevant ideas
            const relevant = {};
            processedIdeas.forEach(idea => {
              if (idea.searchVolume.at(0) >= minSearchVolume) { // Check latest (index 0 usually)
                relevant[idea.text] = idea.searchVolume;
              }
            });
            setRelevantIdeas(relevant);

            setExploreStatus(`Clustering ${processedIdeas.length} ideas...`);

            const clusterResult = await googleScriptRun.getClusters(relevant, promptTemplate, growthMetric);
            setClusters(clusterResult);
            setExploreStatus(`Done. Clustered ${processedIdeas.length} keywords.`);

          } catch (e) {
            console.error(e);
            setExploreStatus(`Error: ${e.message}`);
            alert(e.message);
          } finally {
            setIsExploring(false);
          }
        };

        const generateInsights = async () => {
          if (Object.keys(relevantIdeas).length === 0) {
            alert('Please generate keywords in Explore tab first.');
            return;
          }
          setIsGeneratingInsights(true);
          setInsightsStatus('Generating insights...');
          try {
            const seedKeywords = keywords.split(',').map(k => k.trim()).filter(Boolean);
            const result = await googleScriptRun.getInsights(relevantIdeas, seedKeywords, growthMetric);
            setInsights(result);
            setInsightsStatus('');
          } catch (e) {
            setInsightsStatus(`Error: ${e.message}`);
          } finally {
            setIsGeneratingInsights(false);
          }
        };

        const generateCampaignSuggestions = async () => {
          if (!insights) {
            alert('Please generate insights first.');
            return;
          }
          setIsGeneratingCampaigns(true);
          setCampaignStatus('Generating suggestions...');
          try {
            let adExamples = '';
            if (adsAccountId) {
               const ads = await googleScriptRun.getTopPerformingAdsAndKeywords(adsAccountId.replaceAll('-', '').trim(), 10);
               adExamples = ads.map(ad => JSON.stringify(ad)).join('\n');
            }
            const langName = [...LANGUAGES, ...customLanguages].find(l => l.id === language)?.name || language;
            const result = await googleScriptRun.getCampaigns(insights, langName, brandName, adExamples);
            setCampaignSuggestions(result);
            setCampaignStatus('');
          } catch (e) {
            setCampaignStatus(`Error: ${e.message}`);
          } finally {
            setIsGeneratingCampaigns(false);
          }
        };

        const generatePrompt = async () => {
           const id = creationAccountId.replaceAll('-', '').trim();
           if (!id) {
             alert('Please enter a Google Ads Account ID.');
             return;
           }
           setIsCreatingCampaign(true);
           setCreationResult('Generating prompt...');
           try {
             const result = await googleScriptRun.createCampaignPrompt(
               id, creationPromptTemplate, creationStyleGuide, creationInstructions, creationKeywords
             );
             setCreationResult(result);
           } catch (e) {
             setCreationResult(`Error: ${e.message}`);
           } finally {
             setIsCreatingCampaign(false);
           }
        };

        const generateNewCampaigns = async () => {
           setIsCreatingCampaign(true);
           setCreationResult('Generating ad...');
           try {
             const kws = creationKeywords.split(',').map(k => k.trim()).filter(Boolean);
             const prompt = `${creationStyleGuide}\n${creationInstructions}\n${creationPromptTemplate}`;
             const result = await googleScriptRun.createAdSuggestion(prompt, kws);
             setCreationResult(JSON.stringify(result, null, 2));
           } catch (e) {
             setCreationResult(`Error: ${e.message}`);
           } finally {
             setIsCreatingCampaign(false);
           }
        };

        // Charts Data Preparation
        const clustersChartData = useMemo(() => {
          if (!clusters) return null;
          const maxVol = Math.max(...clusters.map(c => c.searchVolume), 1);

          return {
            datasets: clusters.map((c, i) => {
              let yValue = 0;

              if (growthMetric === 'yoy') {
                yValue = c.growthYoY || c.yearOverYearGrowth || 0;
              } else if (growthMetric === 'mom') {
                yValue = c.growthMoM || 0;
              } else if (growthMetric === 'latest_vs_avg') {
                yValue = c.growthLatestVsAvg || 0;
              } else if (growthMetric === 'latest_vs_max') {
                yValue = c.growthLatestVsMax || 0;
              }

              return {
                label: c.topic,
                data: [{
                  x: c.searchVolume || 0,
                  y: yValue,
                  r: 5 + ((c.searchVolume || 0) / maxVol) * 45
                }],
                backgroundColor: COLOR_PALETTE[i % COLOR_PALETTE.length]
              };
            })
          };
        }, [clusters, growthMetric]);

        const selectedClusterChartData = useMemo(() => {
          if (!selectedCluster || !chartLabels.length) return null;
          // searchVolumeHistory is likely New->Old (index 0 is latest).
          // We want Old->New (Left->Right), so we MUST reverse.
          const data = selectedCluster.searchVolumeHistory.slice();

          return {
            labels: chartLabels,
            datasets: [
              {
                label: `Search Volume: ${selectedCluster.topic}`,
                data: data,
                borderColor: COLOR_PALETTE[4],
                backgroundColor: COLOR_PALETTE[4] + '1A',
                fill: true,
                tension: 0.3
              }
            ]
          };
        }, [selectedCluster, chartLabels]);

        const seedChartData = useMemo(() => {
          if (!ideasData || !keywords || !chartLabels.length) return null;
          const seeds = keywords.split(',').map(k => k.trim().toLowerCase()).filter(Boolean);
          const seedIdeas = ideasData.filter(idea => seeds.includes(idea.text.toLowerCase()));

          if (seedIdeas.length === 0) return null;

          return {
            labels: chartLabels,
            datasets: seedIdeas.map((idea, index) => {
              const color = COLOR_PALETTE[index % COLOR_PALETTE.length];

              return {
                label: idea.text,
                data: idea.searchVolume, // Already in correct order? Check runExplore. Yes, processedIdeas maps monthlySearchVolumes.
                borderColor: color,
                backgroundColor: color, // Same as border for legend
                fill: false, // No fill
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6
              };
            })
          };
        }, [ideasData, keywords, chartLabels]);

        const bubbleChartOptions = useMemo(() => ({
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: 'Search Volume' } },
            y: {
              title: { display: true, text: GROWTH_METRICS.find(m => m.id === growthMetric)?.name || 'Growth' },
              ticks: {
                callback: (value) => (value > 0 ? '+' : '') + (value * 100).toFixed(0) + '%'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: Vol ${ctx.raw.x}, Growth ${(ctx.raw.y > 0 ? '+' : '') + (ctx.raw.y * 100).toFixed(1)}%`
              }
            }
          },
          onClick: (evt, elements) => {
            if (elements.length > 0) {
              const index = elements[0].datasetIndex;
              // We need to access the current clusters state here.
              // Since this function is inside useMemo, it will capture 'clusters' from the dependency array.
              if (clusters && clusters[index]) {
                 setSelectedCluster(clusters[index]);
                 setTimeout(() => {
                     document.getElementById('cluster-details')?.scrollIntoView({ behavior: 'smooth' });
                 }, 100);
              }
            }
          }
        }), [growthMetric, clusters]);

        // --- Render ---

        const languageModal = (
          <Modal isOpen={modalConfig.isOpen && modalConfig.type === 'language'} onClose={() => setModalConfig({ ...modalConfig, isOpen: false })} title="Add Custom Language">
            <div className="modal-body">
              <p className="text-sm text-muted mb-4">
                Enter the numeric Language ID from Google Ads API.
                <a href="https://developers.google.com/google-ads/api/reference/data/codes-formats#languages" target="_blank" rel="noopener noreferrer" style={{marginLeft: '4px', verticalAlign: 'middle'}}>
                  <span className="material-icons-round" style={{fontSize: '16px'}}>info</span>
                </a>
              </p>
              <div className="input-group">
                <label>Language ID</label>
                <input
                  type="text"
                  value={modalConfig.value}
                  onChange={e => setModalConfig({ ...modalConfig, value: e.target.value })}
                  placeholder="e.g. 1000"
                  autoFocus
                />
              </div>
              <div className="modal-actions">
                <button className="btn" onClick={() => setModalConfig({ ...modalConfig, isOpen: false })}>Cancel</button>
                <button className="btn btn-primary" onClick={submitModal}>Add</button>
              </div>
            </div>
          </Modal>
        );

        const locationModal = (
          <Modal isOpen={modalConfig.isOpen && modalConfig.type === 'country'} onClose={() => setModalConfig({ ...modalConfig, isOpen: false })} title="Add Custom Location">
            <div className="modal-body">
              <p className="text-sm text-muted mb-4">
                Enter the numeric Location ID from Google Ads API.
                <a href="https://developers.google.com/google-ads/api/reference/data/geotargets" target="_blank" rel="noopener noreferrer" style={{marginLeft: '4px', verticalAlign: 'middle'}}>
                  <span className="material-icons-round" style={{fontSize: '16px'}}>info</span>
                </a>
              </p>
              <div className="input-group">
                <label>Location ID</label>
                <input
                  type="text"
                  value={modalConfig.value}
                  onChange={e => setModalConfig({ ...modalConfig, value: e.target.value })}
                  placeholder="e.g. 2840"
                  autoFocus
                />
              </div>
              <div className="modal-actions">
                <button className="btn" onClick={() => setModalConfig({ ...modalConfig, isOpen: false })}>Cancel</button>
                <button className="btn btn-primary" onClick={submitModal}>Add</button>
              </div>
            </div>
          </Modal>
        );

        return (
          <div className="app">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
              <h1>GIGA</h1>
              <button className="btn" onClick={clearCache} style={{background: 'transparent', color: 'var(--text-secondary)', border: '1px solid var(--border-color)'}}>
                <span className="material-icons-round" style={{fontSize: '1.2rem', marginRight: '4px'}}>delete_outline</span>
                Clear Cache
              </button>
            </div>

            <div className="tabs">
              <TabButton active={activeTab === 'explore'} onClick={() => setActiveTab('explore')}>Explore</TabButton>
              <TabButton active={activeTab === 'insights'} onClick={() => setActiveTab('insights')}>Insights</TabButton>
              <TabButton active={activeTab === 'campaigns'} onClick={() => setActiveTab('campaigns')}>Campaign Suggestions</TabButton>
              <TabButton active={activeTab === 'creation'} onClick={() => setActiveTab('creation')}>Campaign Creation</TabButton>
            </div>

            {activeTab === 'explore' && (
              <div className="card fade-in">
                <h2>Explore Keywords</h2>
                <InputField
                    label="Seed Keywords"
                    value={keywords}
                    onChange={setKeywords}
                    placeholder="e.g. shoes, running shoes"
                    helpText="Comma separated, up to 20"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        runExplore();
                      }
                    }}
                  />
                <div className="grid-2">
                  <SelectField
                    label="Language"
                    value={language}
                    onChange={setLanguage}
                    options={[...LANGUAGES, ...customLanguages]}
                    onCustomOption={() => handleCustomOption('language')}
                  />
                  <SelectField
                    label="Location"
                    value={country}
                    onChange={setCountry}
                    options={[...COUNTRIES, ...customCountries]}
                    onCustomOption={() => handleCustomOption('country')}
                  />
                </div>



                <details className="mb-4">
                  <summary className="cursor-pointer text-sm font-medium text-primary">Advanced Config</summary>
                  <div className="mt-4">
                    <InputField
                      label="Min Search Volume"
                      type="number"
                      value={minSearchVolume}
                      onChange={setMinSearchVolume}
                      placeholder="100"
                    />
                    <div className="mt-4">
                      <InputField type="textarea" label="Clustering Prompt" value={promptTemplate} onChange={setPromptTemplate} rows={6} />
                    </div>
                  </div>
                </details>

                <button className="btn btn-primary" onClick={runExplore} disabled={isExploring}>
                  {isExploring ? <><div className="spinner"></div> {exploreStatus || 'Running...'}</> : <><span className="material-icons-round">rocket_launch</span> Start Exploration</>}
                </button>

                {seedChartData && (
                  <div className="mt-4 card" style={{border: '1px solid var(--primary)'}}>
                    <h3>Seed Keywords Search Volume</h3>
                    <div style={{height: '400px'}}>
                      <ChartComponent
                        type="line"
                        data={seedChartData}
                        options={{
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10 } },
                            tooltip: { mode: 'index', intersect: false }
                          },
                          interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                          },
                          scales: {
                            y: { beginAtZero: true }
                          }
                        }}
                      />
                    </div>
                  </div>
                )}

                <div className="mt-4" style={{maxWidth: '300px'}}>
                  <SelectField
                    label="Growth Metric"
                    value={growthMetric}
                    onChange={setGrowthMetric}
                    options={GROWTH_METRICS}
                  />
                </div>

                {clustersChartData && (
                  <div className="mt-4">
                    <h3>Clusters</h3>
                    <div className="text-sm text-muted mb-2">Click on a bubble to view details</div>
                    <ChartComponent
                      type="bubble"
                      data={clustersChartData}
                      options={bubbleChartOptions}
                    />
                  </div>
                )}

                {selectedCluster && selectedClusterChartData && (
                  <div id="cluster-details" className="mt-4 card" style={{border: '1px solid var(--primary)'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                       <h3>Details: {selectedCluster.topic}</h3>
                       <button onClick={() => setSelectedCluster(null)} className="btn" style={{padding: '4px 8px'}}>&times;</button>
                    </div>
                    <div className="grid-2">
                       <div>
                          <strong>Total Volume:</strong> {selectedCluster.searchVolume.toLocaleString()}
                       </div>
                       <div>
                          <strong>{GROWTH_METRICS.find(m => m.id === growthMetric)?.name || 'Growth'}:</strong> {
                            (() => {
                              let val = 0;
                              if (growthMetric === 'yoy') val = selectedCluster.growthYoY || selectedCluster.yearOverYearGrowth || 0;
                              else if (growthMetric === 'mom') val = selectedCluster.growthMoM || 0;
                              else if (growthMetric === 'latest_vs_avg') val = selectedCluster.growthLatestVsAvg || 0;
                              else if (growthMetric === 'latest_vs_max') val = selectedCluster.growthLatestVsMax || 0;
                              return (val * 100).toFixed(1);
                            })()
                          }%
                       </div>
                    </div>
                    <div className="mt-4">
                       <h4>Cluster Search Volume</h4>
                       <ChartComponent
                         type="line"
                         data={selectedClusterChartData}
                         options={{
                           responsive: true,
                           maintainAspectRatio: false,
                           plugins: {
                             legend: { display: false }
                           }
                         }}
                       />
                    </div>
                    <div className="mt-4">
                       <h4>Keyword Search Volume</h4>
                       <div style={{height: '400px'}}>
                         <ChartComponent
                           type="line"
                           data={{
                             labels: chartLabels,
                             datasets: selectedCluster.keywords.map((k, i) => {
                               const volHistory = relevantIdeas[k] ? relevantIdeas[k] : [];
                               const color = COLOR_PALETTE[i % COLOR_PALETTE.length];
                               return {
                                 label: k,
                                 data: volHistory.slice(),
                                 borderColor: color,
                                 backgroundColor: color,
                                 fill: false,
                                 tension: 0.3,
                                 pointRadius: 2,
                                 pointHoverRadius: 5
                               };
                             })
                           }}
                           options={{
                             responsive: true,
                             maintainAspectRatio: false,
                             plugins: {
                               legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10 } },
                               tooltip: { mode: 'index', intersect: false }
                             },
                             interaction: {
                               mode: 'nearest',
                               axis: 'x',
                               intersect: false
                             },
                             scales: {
                               y: { beginAtZero: true }
                             }
                           }}
                         />
                       </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'insights' && (
              <div className="card fade-in">
                <h2>Insights</h2>
                <div className="mb-4" dangerouslySetInnerHTML={{ __html: insights }} />
                <button className="btn btn-primary" onClick={generateInsights} disabled={isGeneratingInsights}>
                  {isGeneratingInsights ? <><div className="spinner"></div> Generating...</> : <><span className="material-icons-round">lightbulb</span> Generate Insights</>}
                </button>
                {insightsStatus && <div className="status-msg">{insightsStatus}</div>}
              </div>
            )}

            {activeTab === 'campaigns' && (
              <div className="card fade-in">
                <h2>Campaign Suggestions</h2>
                <div className="grid-2">
                  <InputField label="Google Ads Account ID" value={adsAccountId} onChange={setAdsAccountId} placeholder="123-456-7890" />
                  <InputField label="Brand Name" value={brandName} onChange={setBrandName} placeholder="My Brand" />
                </div>
                <div className="mb-4 mt-4" dangerouslySetInnerHTML={{ __html: campaignSuggestions }} />
                <button className="btn btn-primary" onClick={generateCampaignSuggestions} disabled={isGeneratingCampaigns}>
                  {isGeneratingCampaigns ? <><div className="spinner"></div> Generating...</> : <><span className="material-icons-round">campaign</span> Generate Suggestions</>}
                </button>
                {campaignStatus && <div className="status-msg">{campaignStatus}</div>}
              </div>
            )}

            {activeTab === 'creation' && (
              <div className="card fade-in">
                <h2>Campaign Creation</h2>
                <InputField label="Google Ads Account ID" value={creationAccountId} onChange={setCreationAccountId} />

                <div className="grid-2">
                   <div className="mt-4">
                      <button className="btn btn-primary" onClick={generatePrompt}>Generate Pre-Prompt</button>
                   </div>
                </div>

                <InputField type="textarea" label="Prompt Template" value={creationPromptTemplate} onChange={setCreationPromptTemplate} rows={6} />
                <InputField type="textarea" label="Style Guide" value={creationStyleGuide} onChange={setCreationStyleGuide} rows={6} />
                <InputField type="textarea" label="Instructions" value={creationInstructions} onChange={setCreationInstructions} rows={3} />
                <InputField label="Campaign Keywords" value={creationKeywords} onChange={setCreationKeywords} placeholder="keyword1, keyword2" />

                <div className="mt-4">
                  <button className="btn btn-primary" onClick={generateNewCampaigns} disabled={isCreatingCampaign}>
                    {isCreatingCampaign ? 'Creating...' : 'Generate Ad'}
                    <span className="material-icons-round">add_circle</span>
                  </button>
                </div>

                {creationResult && (
                  <pre className="mt-4 p-4 bg-gray-100 rounded overflow-auto">
                    {creationResult}
                  </pre>
                )}
              </div>
            )}

            {languageModal}
            {locationModal}
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        const [resetKey, setResetKey] = useState(0);
        const handleReset = () => setResetKey(prev => prev + 1);
        return <GigaApp key={resetKey} onReset={handleReset} />;
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
