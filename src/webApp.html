<!--
Copyright 2025 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!doctype html>
<html>
  <head>
    <title>GIGA</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js & React Chart.js 2 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- We'll use raw Chart.js in React for simplicity with CDN, or we can try react-chartjs-2 if we load it right.
         For stability in CDN usage, direct Chart.js usage inside useEffect is often safer/easier than configuring UMD for react-chartjs-2. -->

    <style>
      :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --secondary: #64748b;
        --bg-color: #f8fafc;
        --surface-color: #ffffff;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
        --success: #10b981;
        --error: #ef4444;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md:
          0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg:
          0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Outfit', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
      }

      #root {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Premium UI Components */
      .card {
        background: var(--surface-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-lg);
      }

      h1,
      h2,
      h3 {
        margin-top: 0;
        font-weight: 600;
        color: var(--text-main);
      }

      h1 {
        font-size: 3rem;
        letter-spacing: -0.025em;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 1.5rem;
      }
      h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }
      h3 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
      }

      /* Inputs */
      .input-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--text-secondary);
      }

      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        padding: 10px 14px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s;
        box-sizing: border-box;
      }

      input[type='text']:focus,
      input[type='number']:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        background: white;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.4);
      }

      .btn-primary:active:not(:disabled) {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        filter: grayscale(1);
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: rgba(255, 255, 255, 0.5);
        padding: 6px;
        border-radius: var(--radius-lg);
        backdrop-filter: blur(8px);
        border: 1px solid var(--border-color);
        overflow-x: auto;
      }

      .tab-btn {
        padding: 10px 20px;
        border-radius: var(--radius-md);
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .tab-btn.active {
        background: white;
        color: var(--primary);
        box-shadow: var(--shadow-sm);
        font-weight: 600;
      }

      .tab-btn:hover:not(.active) {
        background: rgba(255, 255, 255, 0.8);
        color: var(--text-main);
      }

      /* Loading & Status */
      .status-msg {
        margin-top: 12px;
        padding: 12px;
        border-radius: var(--radius-md);
        background: #eff6ff;
        color: #1e40af;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Helper classes */
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .text-sm {
        font-size: 0.875rem;
      }
      .text-muted {
        color: var(--text-secondary);
      }

      /* Chart Container */
      .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-top: 20px;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease-out;
      }
      .modal-content {
        background: var(--surface-color);
        padding: 2rem;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-lg);
        width: 90%;
        max-width: 500px;
        animation: slideUp 0.2s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .error-details {
        font-family: monospace;
        font-size: 0.875rem;
        white-space: pre-wrap;
        word-break: break-word;
        color: #991b1b;
        max-height: 200px;
        overflow-y: auto;
      }

      .error-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: auto;
      }

      .error-actions .btn {
        height: 42px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      /* Spinner */
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      @keyframes bounceHorizontal {
        0%,
        100% {
          transform: translateX(0) translateY(-50%);
        }
        50% {
          transform: translateX(-10px) translateY(-50%);
        }
      }

      /* Toggle Switch */
      .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: '';
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--primary);
      }
      input:focus + .slider {
        box-shadow: 0 0 1px var(--primary);
      }
      input:checked + .slider:before {
        transform: translateX(16px);
      }

      /* Warning Footer */
      .warning-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #ef5350;
        color: white;
        text-align: center;
        padding: 10px;
        font-weight: bold;
        z-index: 2000;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- Backend Proxy -->
    <script>
      const googleScriptRun = new Proxy(
        {},
        {
          get:
            (target, prop) =>
            (...args) => {
              console.log(`Running ${prop} in AppsScript backend...`);
              return new Promise((resolve, reject) => {
                if (!google.script.run) {
                  // Mock for local dev if needed, or just fail
                  reject(new Error('google.script.run not available'));
                  return;
                }
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  [prop](...args);
              });
            },
        }
      );
    </script>

    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo } = React;

      // --- Constants & Data ---
      const COLOR_PALETTE = [
        '#4f6d7a',
        '#c0d6df',
        '#dbe9ee',
        '#4a6fa5',
        '#166088',
      ];

      const LANGUAGES = [
        { id: '1000', name: 'English' },
        { id: '1001', name: 'German' },
        { id: '1002', name: 'French' },
        { id: '1003', name: 'Spanish' },
        { id: '1004', name: 'Italian' },
        { id: '1009', name: 'Danish' },
        { id: '1010', name: 'Dutch' },
        { id: '1011', name: 'Finnish' },
        { id: '1015', name: 'Swedish' },
        { id: '1020', name: 'Bulgarian' },
        { id: '1021', name: 'Czech' },
        { id: '1022', name: 'Greek' },
        { id: '1024', name: 'Hungarian' },
        { id: '1028', name: 'Latvian' },
        { id: '1029', name: 'Lithuanian' },
        { id: '1030', name: 'Polish' },
        { id: '1031', name: 'Russian' },
        { id: '1032', name: 'Romanian' },
        { id: '1033', name: 'Slovak' },
        { id: '1034', name: 'Slovenian' },
        { id: '1036', name: 'Ukrainian' },
        { id: '1038', name: 'Catalan' },
        { id: '1039', name: 'Croatian' },
        { id: '1043', name: 'Estonian' },
        { id: '1064', name: 'Persian' },
      ];

      const COUNTRIES = [
        { id: '', name: 'Worldwide' },
        { id: '2276', name: 'Germany' },
        { id: '2826', name: 'UK' },
        { id: '2250', name: 'France' },
        { id: '2380', name: 'Italy' },
        { id: '2756', name: 'Switzerland' },
        { id: '2724', name: 'Spain' },
        { id: '2616', name: 'Poland' },
        { id: '2642', name: 'Romania' },
        { id: '2528', name: 'Netherlands' },
        { id: '2056', name: 'Belgium' },
        { id: '2203', name: 'Czechia' },
        { id: '2300', name: 'Greece' },
        { id: '2620', name: 'Portugal' },
        { id: '2752', name: 'Sweden' },
        { id: '2348', name: 'Hungary' },
        { id: '2040', name: 'Austria' },
        { id: '2100', name: 'Bulgaria' },
        { id: '2208', name: 'Denmark' },
        { id: '2703', name: 'Slovakia' },
        { id: '2246', name: 'Finland' },
        { id: '2372', name: 'Ireland' },
        { id: '2191', name: 'Croatia' },
        { id: '2440', name: 'Lithuania' },
        { id: '2705', name: 'Slovenia' },
        { id: '2428', name: 'Latvia' },
        { id: '2233', name: 'Estonia' },
        { id: '2196', name: 'Cyprus' },
        { id: '2442', name: 'Luxembourg' },
        { id: '2470', name: 'Malta' },
      ];

      const DEFAULT_PROMPT = `You are given a list of Google Ads keyword ideas.
Your task is to create 10 clusters. For each cluster use only up to 20 keywords that are most representative of that cluster.
Make sure to only assign the keywords provided to the cluster and do not invent new keywords.
All keywords assigned to a cluster must be exactly the same (e.g. same case, same spacing, same accents).

The Google Ads keyword ideas are:
`;

      const DEFAULT_TRENDS_PROMPT = `Provide a list of around 100 Google Ads broad match keywords that represent trends regarding the topics/keywords mentioned below.`;

      const LANGUAGE_INFO_URL =
        'https://developers.google.com/google-ads/api/reference/data/codes-formats#languages';
      const LOCATION_INFO_URL =
        'https://developers.google.com/google-ads/api/reference/data/geotargets';
      const GOOGLE_ADS_ID_HELP_URL =
        'https://support.google.com/google-ads/answer/1704344?hl=en';

      // --- Components ---

      // eslint-disable-next-line no-unused-vars
      const TabButton = ({ active, onClick, children }) => (
        <button
          className={`tab-btn ${active ? 'active' : ''}`}
          onClick={onClick}
        >
          {children}
        </button>
      );

      // eslint-disable-next-line no-unused-vars
      const InputField = ({
        label,
        type = 'text',
        value,
        onChange,
        placeholder,
        rows,
        helpText,
        onKeyDown,
      }) => (
        <div className="input-group">
          <label>{label}</label>
          {type === 'textarea' ? (
            <textarea
              rows={rows || 4}
              value={value}
              onChange={e => onChange(e.target.value)}
              placeholder={placeholder}
              onKeyDown={onKeyDown}
            />
          ) : (
            <input
              type={type}
              value={value}
              onChange={e => onChange(e.target.value)}
              placeholder={placeholder}
              onKeyDown={onKeyDown}
            />
          )}
          {helpText && (
            <div className="text-sm text-muted mt-1">{helpText}</div>
          )}
        </div>
      );

      // eslint-disable-next-line no-unused-vars
      const Modal = ({
        isOpen,
        onClose,
        title,
        children,
        className = '',
        showCloseButton = true,
      }) => {
        if (!isOpen) return null;
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className={`modal-content ${className}`}
              onClick={e => e.stopPropagation()}
            >
              <div className="modal-header">
                <h2>{title}</h2>
                {showCloseButton && (
                  <button className="close-btn" onClick={onClose}>
                    <span className="material-symbols-outlined">close</span>
                  </button>
                )}
              </div>
              {children}
            </div>
          </div>
        );
      };

      const ErrorModal = ({ isOpen, onClose, error }) => {
        if (!isOpen || !error) return null;

        const copyToClipboard = () => {
          const text = `Error: ${error.title}\nMessage: ${error.message}\n\nStack Trace:\n${error.stack || 'N/A'}`;
          navigator.clipboard.writeText(text).then(() => {
            // Optional: Show a temporary "Copied!" tooltip or state
          });
        };

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div
              className="modal-content error-modal-content"
              onClick={e => e.stopPropagation()}
            >
              <div className="error-header">
                <span className="material-symbols-outlined error-icon">
                  error_outline
                </span>
                <h2 className="error-title">
                  {error.title || 'An error occurred'}
                </h2>
              </div>

              <div className="error-body">
                <p className="error-message">{error.message}</p>
                {error.stack && (
                  <div className="error-details">{error.stack}</div>
                )}
              </div>

              <div className="error-actions">
                <button className="btn btn-secondary" onClick={copyToClipboard}>
                  <span className="material-symbols-outlined">
                    content_copy
                  </span>
                  Copy Details
                </button>
                <button className="btn btn-primary" onClick={onClose}>
                  Close
                </button>
              </div>
            </div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const SelectField = ({
        label,
        value,
        onChange,
        options,
        onCustomOption,
      }) => {
        const handleChange = e => {
          if (e.target.value === 'custom') {
            onCustomOption();
          } else {
            onChange(e.target.value);
          }
        };
        return (
          <div className="input-group">
            <label>{label}</label>
            <div className="select-wrapper">
              <select value={value} onChange={handleChange}>
                {options.map(opt => (
                  <option key={opt.id} value={opt.id}>
                    {opt.name}
                  </option>
                ))}
                {onCustomOption && <option value="custom">Custom ID...</option>}
              </select>
            </div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const ChartComponent = ({ type, data, options }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
          if (canvasRef.current) {
            if (chartRef.current) chartRef.current.destroy();
            chartRef.current = new Chart(canvasRef.current, {
              type,
              data,
              options,
            });
          }
          return () => {
            if (chartRef.current) chartRef.current.destroy();
          };
        }, [type, data, options]);

        return (
          <div className="chart-container">
            <canvas ref={canvasRef} />
          </div>
        );
      };

      // --- Hooks ---
      function useStickyState(defaultValue, key, isReadOnly = false) {
        const [value, setValue] = useState(() => {
          if (isReadOnly) return defaultValue;
          try {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null
              ? JSON.parse(stickyValue)
              : defaultValue;
          } catch (error) {
            console.warn(`Error reading localStorage key "${key}":`, error);
            window.localStorage.removeItem(key);
            return defaultValue;
          }
        });
        useEffect(() => {
          if (isReadOnly) return;
          try {
            window.localStorage.setItem(key, JSON.stringify(value));
          } catch (error) {
            console.warn(`Error writing localStorage key "${key}":`, error);
          }
        }, [key, value, isReadOnly]);
        return [value, setValue];
      }

      // eslint-disable-next-line no-unused-vars
      const SettingsModal = ({
        isOpen,
        onClose,
        modalConfig,
        geminiConfig,
        minSearchVolume,
        configStatus,
        onSave,
        onClearCache,
      }) => {
        const [localGeminiConfig, setLocalGeminiConfig] =
          useState(geminiConfig);
        const [localMinSearchVolume, setLocalMinSearchVolume] =
          useState(minSearchVolume);
        const [localAdsId, setLocalAdsId] = useState(
          configStatus.adsAccountId || ''
        );
        const [localDevToken, setLocalDevToken] = useState('');
        const [localSpreadsheetUrl, setLocalSpreadsheetUrl] = useState('');
        const [isSaving, setIsSaving] = useState(false);
        const adsInputRef = useRef(null);

        // Sync with props when modal opens
        useEffect(() => {
          if (isOpen) {
            setLocalGeminiConfig(geminiConfig);
            setLocalMinSearchVolume(minSearchVolume);
            setLocalSpreadsheetUrl(modalConfig.spreadsheetUrl || '');
            setLocalAdsId(configStatus.adsAccountId || '');
            setLocalDevToken('');
          }
        }, [
          isOpen,
          geminiConfig,
          minSearchVolume,
          configStatus,
          modalConfig.spreadsheetUrl,
        ]);

        // Focus Ads Account ID if highlighted
        useEffect(() => {
          if (
            isOpen &&
            (modalConfig.highlight === 'ADS_ACCOUNT_ID' ||
              modalConfig.highlight === 'BOTH') &&
            adsInputRef.current
          ) {
            setTimeout(() => {
              adsInputRef.current.focus();
            }, 100);
          }
        }, [isOpen, modalConfig.highlight]);

        // Close on ESC
        useEffect(() => {
          const handleEsc = event => {
            if (event.key === 'Escape') {
              onClose();
            }
          };
          if (isOpen) {
            window.addEventListener('keydown', handleEsc);
          }
          return () => {
            window.removeEventListener('keydown', handleEsc);
          };
        }, [isOpen, onClose]);

        const handleSave = async () => {
          setIsSaving(true);
          try {
            await onSave({
              geminiConfig: localGeminiConfig,
              minSearchVolume: localMinSearchVolume,
              adsAccountId: localAdsId,
              devToken: localDevToken,
              spreadsheetUrl: localSpreadsheetUrl,
            });
          } catch (error) {
            console.error('Failed to save settings', error);
          } finally {
            setIsSaving(false);
          }
        };

        return (
          <Modal
            isOpen={isOpen}
            onClose={onClose}
            title="Settings"
            showCloseButton={false}
          >
            <div className="modal-body">
              {modalConfig.message && (
                <div
                  className="alert alert-warning mb-4"
                  style={{
                    color: '#dc2626',
                    background: '#fee2e2',
                    padding: '10px',
                    borderRadius: '6px',
                    fontSize: '0.9rem',
                    border: '1px solid #fca5a5',
                  }}
                >
                  {modalConfig.message}
                </div>
              )}
              <div className="input-group">
                <label>Gemini Model</label>
                <div className="select-wrapper">
                  <select
                    value={localGeminiConfig.modelId}
                    onChange={e =>
                      setLocalGeminiConfig({
                        ...localGeminiConfig,
                        modelId: e.target.value,
                      })
                    }
                  >
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                  </select>
                </div>
              </div>
              <div className="grid-2">
                <div className="input-group">
                  <label>Temperature: {localGeminiConfig.temperature}</label>
                  <input
                    type="range"
                    step="0.1"
                    min="0"
                    max="2"
                    value={localGeminiConfig.temperature}
                    onChange={e =>
                      setLocalGeminiConfig({
                        ...localGeminiConfig,
                        temperature: parseFloat(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="input-group">
                  <label>Top P: {localGeminiConfig.topP}</label>
                  <input
                    type="range"
                    step="0.1"
                    min="0"
                    max="1"
                    value={localGeminiConfig.topP}
                    onChange={e =>
                      setLocalGeminiConfig({
                        ...localGeminiConfig,
                        topP: parseFloat(e.target.value),
                      })
                    }
                  />
                </div>
              </div>

              <hr
                style={{
                  margin: '20px 0',
                  border: '0',
                  borderTop: '1px solid var(--border-color)',
                }}
              />
              <div className="input-group">
                <label>Min Search Volume</label>
                <input
                  type="number"
                  value={localMinSearchVolume}
                  onChange={e =>
                    setLocalMinSearchVolume(Number(e.target.value))
                  }
                  placeholder="100"
                />
              </div>

              <hr
                style={{
                  margin: '20px 0',
                  border: '0',
                  borderTop: '1px solid var(--border-color)',
                }}
              />
              <div className="input-group">
                <label>Export Spreadsheet URL</label>
                <input
                  type="text"
                  value={localSpreadsheetUrl}
                  onChange={e => setLocalSpreadsheetUrl(e.target.value)}
                  placeholder="https://docs.google.com/spreadsheets/d/..."
                />
              </div>

              <hr
                style={{
                  margin: '20px 0',
                  border: '0',
                  borderTop: '1px solid var(--border-color)',
                }}
              />
              <div className="input-group">
                <label>Application Data</label>
                <div
                  style={{ display: 'flex', alignItems: 'center', gap: '10px' }}
                >
                  <button
                    className="btn"
                    onClick={() => {
                      onClearCache();
                      onClose();
                    }}
                    style={{
                      width: '40px',
                      height: '40px',
                      padding: '0',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      background: '#f3f4f6',
                      color: '#4b5563',
                      border: '1px solid #e5e7eb',
                      borderRadius: '8px',
                      flexShrink: 0,
                    }}
                    title="Clear Cache"
                  >
                    <span
                      className="material-symbols-outlined"
                      style={{ fontSize: '1.2rem' }}
                    >
                      delete_outline
                    </span>
                  </button>
                  <div className="text-sm text-muted">
                    Removes all locally saved data and resets the application
                    state.
                  </div>
                </div>
              </div>

              <hr
                style={{
                  margin: '20px 0',
                  border: '0',
                  borderTop: '1px solid var(--border-color)',
                }}
              />

              <details
                className="advanced-settings"
                open={!!modalConfig.highlight}
                style={{
                  background: '#f8fafc',
                  padding: '15px',
                  borderRadius: '8px',
                  border: '1px solid #e2e8f0',
                }}
              >
                <summary
                  style={{
                    color: '#475569',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    fontSize: '1rem',
                    fontWeight: 'bold',
                  }}
                >
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '1.2rem' }}
                  >
                    expand_more
                  </span>
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '1.2rem' }}
                  >
                    settings
                  </span>
                  Advanced Settings
                </summary>
                <div className="mt-4">
                  <div className="input-group">
                    <label>Ads Account ID</label>
                    <div
                      style={
                        modalConfig.highlight === 'ADS_ACCOUNT_ID' ||
                        modalConfig.highlight === 'BOTH'
                          ? {
                              border: '2px solid #dc2626',
                              borderRadius: '8px',
                              padding: '4px',
                              position: 'relative',
                            }
                          : {}
                      }
                    >
                      <input
                        ref={adsInputRef}
                        type="text"
                        value={localAdsId}
                        onChange={e => setLocalAdsId(e.target.value)}
                        placeholder="e.g. 123-456-7890"
                        style={{ width: '100%', boxSizing: 'border-box' }}
                      />
                      {(modalConfig.highlight === 'ADS_ACCOUNT_ID' ||
                        modalConfig.highlight === 'BOTH') && (
                        <div
                          style={{
                            position: 'absolute',
                            right: '-40px',
                            top: '50%',
                            color: '#dc2626',
                            fontSize: '32px',
                            fontWeight: 'bold',
                            animation:
                              'bounceHorizontal 1s infinite ease-in-out',
                          }}
                        >
                          ←
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="input-group">
                    <label>Developer Token</label>
                    <div
                      style={
                        modalConfig.highlight === 'DEVELOPER_TOKEN' ||
                        modalConfig.highlight === 'BOTH'
                          ? {
                              border: '2px solid #dc2626',
                              borderRadius: '8px',
                              padding: '4px',
                              position: 'relative',
                            }
                          : {}
                      }
                    >
                      <input
                        type="text"
                        value={localDevToken}
                        onChange={e => setLocalDevToken(e.target.value)}
                        placeholder={
                          configStatus.hasDeveloperToken
                            ? 'Token is set (hidden for safety). Type to update.'
                            : 'Enter Developer Token'
                        }
                        style={{ width: '100%', boxSizing: 'border-box' }}
                      />
                      {(modalConfig.highlight === 'DEVELOPER_TOKEN' ||
                        modalConfig.highlight === 'BOTH') && (
                        <div
                          style={{
                            position: 'absolute',
                            right: '-40px',
                            top: '50%',
                            color: '#dc2626',
                            fontSize: '32px',
                            fontWeight: 'bold',
                            animation:
                              'bounceHorizontal 1s infinite ease-in-out',
                          }}
                        >
                          ←
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </details>
              <div className="modal-actions">
                <button className="btn" onClick={onClose} disabled={isSaving}>
                  Cancel
                </button>
                <button
                  className="btn btn-primary"
                  onClick={handleSave}
                  disabled={isSaving}
                >
                  {isSaving ? 'Saving...' : 'Save'}
                </button>
              </div>
            </div>
          </Modal>
        );
      };

      // --- Main App ---

      // eslint-disable-next-line no-unused-vars
      const GigaApp = ({ onReset, isDemoMode }) => {
        const [activeTab, setActiveTab] = useStickyState(
          'explore',
          'giga_activeTab'
        );

        // Explore State
        const [keywords, setKeywords] = useStickyState('', 'giga_keywords');
        const [trendsKeywords, setTrendsKeywords] = useStickyState(
          '',
          'giga_trendsKeywords'
        );
        const [isTrendsRunning, setIsTrendsRunning] = useState(false);
        const [trendsResults, setTrendsResults] = useStickyState(
          [],
          'giga_trendsResults',
          isDemoMode
        );
        const [trendsStatus, setTrendsStatus] = useState('');
        const [trendsPromptTemplate, setTrendsPromptTemplate] = useStickyState(
          DEFAULT_TRENDS_PROMPT,
          'giga_trendsPromptTemplate'
        );
        const [language, setLanguage] = useStickyState('1000', 'giga_language');
        const [country, setCountry] = useStickyState('', 'giga_country');
        const [customLanguages, setCustomLanguages] = useStickyState(
          [],
          'giga_customLanguages'
        );
        const [customCountries, setCustomCountries] = useStickyState(
          [],
          'giga_customCountries'
        );
        const [promptTemplate, setPromptTemplate] = useStickyState(
          DEFAULT_PROMPT,
          'giga_promptTemplate'
        );
        const [exploreStatus, setExploreStatus] = useState('');
        const [isExploring, setIsExploring] = useState(false);
        const [ideasData, setIdeasData] = useStickyState(
          null,
          'giga_ideasData',
          isDemoMode
        );
        const [clusters, setClusters] = useStickyState(
          null,
          'giga_clusters',
          isDemoMode
        );
        const [relevantIdeas, setRelevantIdeas] = useStickyState(
          {},
          'giga_relevantIdeas',
          isDemoMode
        );
        const [selectedCluster, setSelectedCluster] = useState(null);
        const [selectedTrend, setSelectedTrend] = useState(null);
        const [chartLabels, setChartLabels] = useStickyState(
          [],
          'giga_chartLabels',
          isDemoMode
        );
        const [minSearchVolume, setMinSearchVolume] = useStickyState(
          100,
          'giga_minSearchVolume'
        );

        const [spreadsheetUrl, setSpreadsheetUrl] = useStickyState(
          '',
          'giga_spreadsheetUrl'
        );

        // Insights State
        const [insights, setInsights] = useStickyState(
          '',
          'giga_insights',
          isDemoMode
        );
        const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);
        const [insightsStatus, setInsightsStatus] = useState('');

        // Campaigns State
        const [adsAccountId, setAdsAccountId] = useStickyState(
          '',
          'giga_adsAccountId'
        );
        const [brandName, setBrandName] = useStickyState('', 'giga_brandName');
        const [campaignSuggestions, setCampaignSuggestions] = useStickyState(
          '',
          'giga_campaignSuggestions'
        );
        const [isGeneratingCampaigns, setIsGeneratingCampaigns] =
          useState(false);
        const [campaignStatus, setCampaignStatus] = useState('');

        // Demo Mode Randomization
        const [isRandomized, setIsRandomized] = useState(true);

        // --- Sheet Export Helper ---
        const [isExporting, setIsExporting] = useState(false);

        const handleSheetExport = async (
          sheetName,
          header,
          rows,
          columnFormats = []
        ) => {
          setIsExporting(true);
          try {
            let targetUrl = spreadsheetUrl;
            let isNewSheet = false;
            if (!targetUrl) {
              targetUrl =
                await googleScriptRun.createSpreadsheet('Giga Export');
              setSpreadsheetUrl(targetUrl);
              isNewSheet = true;
            }
            await googleScriptRun.exportToSheet(
              targetUrl,
              sheetName,
              header,
              rows,
              isNewSheet,
              columnFormats
            );
            if (isNewSheet) {
              showAlert(
                'Successfully exported to a new spreadsheet. You can change the destination URL in Settings.',
                targetUrl
              );
            } else {
              showAlert('Successfully exported to:', targetUrl);
            }
          } catch (e) {
            showError('Export Failed', e);
          } finally {
            setIsExporting(false);
          }
        };

        const handleExportExploreToSheet = () => {
          if (!clusters) return;
          const headers = [
            'Cluster Topic',
            'Keyword',
            'Latest Search Volume',
            'Cluster Growth YoY',
            'Cluster Growth MoM',
          ];
          const rows = [];

          clusters.forEach(cluster => {
            cluster.keywords.forEach(kw => {
              const history = relevantIdeas[kw];
              const vol = history && history.length > 0 ? history[0] : 0;
              rows.push([
                cluster.topic,
                kw,
                vol,
                cluster.growthYoY,
                cluster.growthMoM,
              ]);
            });
          });

          const columnFormats = [
            { colIndex: 2, numberFormat: '#,##0' },
            { colIndex: 3, numberFormat: '0.00%' },
            { colIndex: 4, numberFormat: '0.00%' },
          ];

          handleSheetExport('Explore', headers, rows, columnFormats);
        };

        const handleExportTrendsToSheet = () => {
          if (!trendsResults || trendsResults.length === 0) return;
          const headers = [
            'Keyword',
            'Latest Volume',
            'Growth YoY',
            'Growth MoM',
            'Competition',
            'Low Bid (Micros)',
            'High Bid (Micros)',
            'Avg CPC (Micros)',
          ];

          const rows = sortedTrendsResults.map(t => [
            t.text,
            t.latestSearchVolume,
            t.growthYoY,
            t.growthMoM,
            t.competition,
            t.low_top_of_page_bid_micros,
            t.high_top_of_page_bid_micros,
            t.average_cpc_micros,
          ]);

          const columnFormats = [
            { colIndex: 1, numberFormat: '#,##0' },
            { colIndex: 2, numberFormat: '0.00%' },
            { colIndex: 3, numberFormat: '0.00%' },
            {
              colIndex: 5,
              numberFormat: '"$"#,##0.00',
              scale: 0.000001,
              headerRename: 'Low Bid (USD)',
            },
            {
              colIndex: 6,
              numberFormat: '"$"#,##0.00',
              scale: 0.000001,
              headerRename: 'High Bid (USD)',
            },
            {
              colIndex: 7,
              numberFormat: '"$"#,##0.00',
              scale: 0.000001,
              headerRename: 'Avg CPC (USD)',
            },
          ];

          handleSheetExport('Trends', headers, rows, columnFormats);
        };

        const handleExportInsightsToSheet = () => {
          if (!insights) return;
          // Just put the markdown text in one cell
          const rows = [[htmlToMarkdown(insights)]];
          handleSheetExport('Insights', ['Insights Content'], rows);
        };

        const handleExportCampaignsToSheet = () => {
          if (!campaignSuggestions) return;
          // Just put the markdown text in one cell
          const rows = [[htmlToMarkdown(campaignSuggestions)]];
          handleSheetExport('Campaign Suggestions', ['Campaign Content'], rows);
        };

        const handleDownloadCampaigns = () => {
          if (!campaignSuggestions) return;
          const md = htmlToMarkdown(campaignSuggestions);
          downloadFile(md, 'giga_campaign_suggestions.md', 'text/markdown');
        };

        const loadExploreDemoData = async (randomize, delay = 0) => {
          if (!isDemoMode) return false;
          try {
            const cachedIdeas = localStorage.getItem('giga_ideasData');
            const cachedClusters = localStorage.getItem('giga_clusters');
            const cachedRelevantIdeas =
              localStorage.getItem('giga_relevantIdeas');
            const cachedLaels = localStorage.getItem('giga_chartLabels');

            if (cachedIdeas && cachedClusters) {
              if (delay > 0) {
                await new Promise(resolve => setTimeout(resolve, delay));
              }

              let parsedIdeas = JSON.parse(cachedIdeas);
              let parsedClusters = JSON.parse(cachedClusters);
              let parsedRelevant = cachedRelevantIdeas
                ? JSON.parse(cachedRelevantIdeas)
                : {};

              if (randomize) {
                const generateSmoothSeries = originalSeries => {
                  const length = Array.isArray(originalSeries)
                    ? originalSeries.length
                    : 12;
                  const series = [];
                  // Start between 10 and 100
                  let current = Math.floor(Math.random() * 90) + 10;
                  series.push(current);

                  for (let i = 1; i < length; i++) {
                    // Change by -15% to +15% approx, or fixed step
                    // Let's use fixed step relative to current to simulate volatility
                    const volatility = Math.max(5, Math.round(current * 0.2));
                    const change =
                      Math.floor(Math.random() * (volatility * 2 + 1)) -
                      volatility;
                    current = Math.max(0, current + change);
                    series.push(current);
                  }

                  // 20% chance of a spike at the end (latest month)
                  if (Math.random() < 0.2) {
                    const lastIdx = series.length - 1;
                    series[lastIdx] = Math.round(
                      series[lastIdx] * (2 + Math.random() * 3)
                    ); // 2x to 5x spike
                  }
                  return series;
                };

                const randomizeGrowth = val =>
                  typeof val === 'number' ? val + (Math.random() - 0.5) : val;

                parsedIdeas = parsedIdeas.map(idea => ({
                  ...idea,
                  searchVolume: Array.isArray(idea.searchVolume)
                    ? generateSmoothSeries(idea.searchVolume)
                    : idea.searchVolume,
                }));

                parsedClusters = parsedClusters.map(c => {
                  const newHistory = Array.isArray(c.searchVolumeHistory)
                    ? generateSmoothSeries(c.searchVolumeHistory)
                    : c.searchVolumeHistory;
                  // Calculate avg for scalar volume
                  const avgVol =
                    Array.isArray(newHistory) && newHistory.length > 0
                      ? Math.round(
                          newHistory.reduce((a, b) => a + b, 0) /
                            newHistory.length
                        )
                      : 0;

                  return {
                    ...c,
                    searchVolume: avgVol,
                    searchVolumeHistory: newHistory,
                    growthYoY: randomizeGrowth(c.growthYoY),
                    growthMoM: randomizeGrowth(c.growthMoM),
                    growthLatestVsAvg: randomizeGrowth(c.growthLatestVsAvg),
                    growthLatestVsMax: randomizeGrowth(c.growthLatestVsMax),
                  };
                });

                Object.keys(parsedRelevant).forEach(k => {
                  if (Array.isArray(parsedRelevant[k])) {
                    parsedRelevant[k] = generateSmoothSeries(parsedRelevant[k]);
                  }
                });
              } else {
                // Explicitly reload original data to be safe
                parsedIdeas = JSON.parse(cachedIdeas);
                parsedClusters = JSON.parse(cachedClusters);
                parsedRelevant = cachedRelevantIdeas
                  ? JSON.parse(cachedRelevantIdeas)
                  : {};
              }

              setIdeasData(parsedIdeas);
              setClusters(parsedClusters);
              setRelevantIdeas(parsedRelevant);
              if (cachedLaels) setChartLabels(JSON.parse(cachedLaels));

              setExploreStatus('');
              setIsExploring(false);
              return true;
            }
          } catch (e) {
            console.warn('Failed to load demo cache', e);
          }
          return false;
        };

        const loadTrendsDemoData = async (randomize, delay = 0) => {
          if (!isDemoMode) return false;
          try {
            const c_trends = localStorage.getItem('giga_trendsResults');
            if (c_trends) {
              if (delay > 0) {
                await new Promise(resolve => setTimeout(resolve, delay));
              }

              const randomizeVol = val => Math.floor(Math.random() * 101);
              const randomizeMicros = () =>
                Math.floor(Math.random() * 10000000) + 100000; // $0.10 - $10.10
              const randomizeGrowth = val => Math.random() * 2 - 1; // -100% to +100%
              const COMPETITION_LEVELS = [
                'HIGH',
                'MEDIUM',
                'LOW',
                'UNSPECIFIED',
              ];

              let parsedTrends = JSON.parse(c_trends);

              if (randomize) {
                parsedTrends = parsedTrends.map(t => ({
                  ...t,
                  latestSearchVolume: randomizeVol(),
                  low_top_of_page_bid_micros: randomizeMicros(),
                  high_top_of_page_bid_micros: randomizeMicros(),
                  average_cpc_micros: randomizeMicros(),
                  competition:
                    COMPETITION_LEVELS[
                      Math.floor(Math.random() * COMPETITION_LEVELS.length)
                    ],
                  competition_index: Math.floor(Math.random() * 101),
                  growthYoY: randomizeGrowth(),
                  growthMoM: randomizeGrowth(),
                  growthLatestVsAvg: randomizeGrowth(),
                  growthLatestVsMax: randomizeGrowth(),
                }));
              }

              setTrendsResults(parsedTrends);
              setIsTrendsRunning(false);
              setTrendsStatus('');
              return true;
            }
          } catch (e) {
            console.warn(e);
          }
          return false;
        };

        const loadInsightsDemoData = async (randomize, delay = 0) => {
          if (!isDemoMode) return;
          try {
            const key = randomize ? 'giga_insights_random' : 'giga_insights';
            const cached = localStorage.getItem(key);

            if (delay > 0) {
              await new Promise(resolve => setTimeout(resolve, delay));
            }

            if (cached) {
              setInsights(JSON.parse(cached));
            } else {
              // If no specific cache exists, clear to avoid mismatch
              setInsights('');
            }
          } catch (e) {
            console.warn(e);
          }
        };

        useEffect(() => {
          const updateData = async () => {
            if (isDemoMode) {
              if (ideasData) {
                // setIsExploring(true);
                // setExploreStatus('Updating demo data...');
                await loadExploreDemoData(isRandomized, 0);
              }
              if (trendsResults && trendsResults.length > 0) {
                // setIsTrendsRunning(true);
                await loadTrendsDemoData(isRandomized, 0);
              }
              if (insights) {
                await loadInsightsDemoData(isRandomized, 0);
              }
            }
          };
          updateData();
        }, [isRandomized]);

        useEffect(() => {
          const handleKeyDown = e => {
            if (!isDemoMode) return;
            // Toggle on Shift + Alt + R
            if (e.shiftKey && e.altKey && e.code === 'KeyR') {
              console.log('Shortcut triggered: Toggling Randomization');
              e.preventDefault();
              setIsRandomized(prev => !prev);
            }
          };
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, [isDemoMode]);

        // Campaign Creation State
        const [creationAccountId, setCreationAccountId] = useStickyState(
          '111-222-3333',
          'giga_creationAccountId'
        );
        const [creationPromptTemplate, setCreationPromptTemplate] =
          useStickyState('', 'giga_creationPromptTemplate');
        const [creationStyleGuide, setCreationStyleGuide] = useStickyState(
          '<?= DEFAULT_STYLE_GUIDE ?>',
          'giga_creationStyleGuide'
        );
        const [creationInstructions, setCreationInstructions] = useStickyState(
          'Created ads must be in German.',
          'giga_creationInstructions'
        );
        const [creationKeywords, setCreationKeywords] = useStickyState(
          '',
          'giga_creationKeywords'
        );
        const [growthMetric, setGrowthMetric] = useStickyState(
          'yoy',
          'growthMetric'
        );

        // Gemini Configuration
        const [errorState, setErrorState] = useState({
          isOpen: false,
          title: '',
          message: '',
          stack: '',
        });

        const [configStatus, setConfigStatus] = useState({
          hasDeveloperToken: false,
          hasAdsAccountId: false,
          adsAccountId: '',
          checked: false,
        });

        // Sorting State
        const [sortConfig, setSortConfig] = useState({
          key: 'growth',
          direction: 'descending',
        });

        const processedTrendsData = useMemo(() => {
          if (!trendsResults) return [];
          return trendsResults.map(item => {
            if (typeof item === 'string') {
              return { text: item }; // minimal object
            }
            return item;
          });
        }, [trendsResults]);

        // Filter State
        const [trendsFilters, setTrendsFilters] = useState({
          keyword: '',
          minVolume: '',
        });

        const filteredTrendsResults = useMemo(() => {
          console.log('Filtering with:', trendsFilters);
          return processedTrendsData.filter(item => {
            const text = item.text || '';
            if (
              trendsFilters.keyword &&
              !text.toLowerCase().includes(trendsFilters.keyword.toLowerCase())
            ) {
              return false;
            }
            if (
              trendsFilters.minVolume !== '' &&
              (item.latestSearchVolume || 0) < Number(trendsFilters.minVolume)
            ) {
              return false;
            }
            return true;
          });
        }, [processedTrendsData, trendsFilters]);

        const sortedTrendsResults = useMemo(() => {
          let sortableItems = [...filteredTrendsResults];
          if (sortConfig.key) {
            sortableItems.sort((a, b) => {
              let aValue, bValue;

              // Handle Growth special case
              if (sortConfig.key === 'competition') {
                aValue =
                  a.competition_index != null
                    ? Number(a.competition_index)
                    : null;
                bValue =
                  b.competition_index != null
                    ? Number(b.competition_index)
                    : null;
              } else if (
                [
                  'low_top_of_page_bid_micros',
                  'high_top_of_page_bid_micros',
                  'average_cpc_micros',
                ].includes(sortConfig.key)
              ) {
                const rawA = a[sortConfig.key];
                const rawB = b[sortConfig.key];
                aValue = rawA != null ? Number(rawA) : null;
                bValue = rawB != null ? Number(rawB) : null;
              } else if (sortConfig.key === 'growth') {
                if (growthMetric === 'yoy') {
                  aValue = a.growthYoY;
                  bValue = b.growthYoY;
                } else if (growthMetric === 'mom') {
                  aValue = a.growthMoM;
                  bValue = b.growthMoM;
                } else if (growthMetric === 'latest_vs_avg') {
                  aValue = a.growthLatestVsAvg;
                  bValue = b.growthLatestVsAvg;
                } else if (growthMetric === 'latest_vs_max') {
                  aValue = a.growthLatestVsMax;
                  bValue = b.growthLatestVsMax;
                }
              } else {
                aValue = a[sortConfig.key];
                bValue = b[sortConfig.key];
              }

              // Handle nulls/undefined - usually push to bottom
              if (aValue == null) return 1;
              if (bValue == null) return -1;

              if (aValue < bValue) {
                return sortConfig.direction === 'ascending' ? -1 : 1;
              }
              if (aValue > bValue) {
                return sortConfig.direction === 'ascending' ? 1 : -1;
              }
              return 0;
            });
          }
          return sortableItems;
        }, [filteredTrendsResults, sortConfig, growthMetric]);

        const requestSort = key => {
          let direction = 'descending';
          if (sortConfig.key === key && sortConfig.direction === 'descending') {
            direction = 'ascending';
          }
          setSortConfig({ key, direction });
        };

        const getSortIndicator = key => {
          if (sortConfig.key !== key) return null;
          return sortConfig.direction === 'ascending' ? ' ↑' : ' ↓';
        };

        useEffect(() => {
          googleScriptRun
            .checkScriptProperties()
            .then(status => {
              setConfigStatus({ ...status, checked: true });
              if (status.adsAccountId) {
                setAdsAccountId(status.adsAccountId);
              }
              if (status.spreadsheetUrl) {
                setSpreadsheetUrl(status.spreadsheetUrl);
              }
            })
            .catch(console.error);
        }, []);

        const showError = (title, error) => {
          console.error(error);
          setErrorState({
            isOpen: true,
            title: title,
            message: error.message || String(error),
            stack: error.stack || '',
          });
        };

        const [geminiConfig, setGeminiConfig] = useStickyState(
          {
            projectId: '',
            modelId: 'gemini-2.5-pro',
            temperature: 0.7,
            topP: 0.9,
          },
          'giga_geminiConfig'
        );

        // Migration for renamed keys
        useEffect(() => {
          if (
            geminiConfig.modelID !== undefined ||
            geminiConfig.projectID !== undefined
          ) {
            console.log('Migrating legacy geminiConfig keys...');
            setGeminiConfig(prev => {
              const newConfig = { ...prev };
              if (prev.modelID !== undefined) {
                newConfig.modelId = prev.modelID;
                delete newConfig.modelID;
              }
              if (prev.projectID !== undefined) {
                newConfig.projectId = prev.projectID;
                delete newConfig.projectID;
              }
              return newConfig;
            });
          }
        }, [geminiConfig]);
        const [creationResult, setCreationResult] = useStickyState(
          '',
          'giga_creationResult'
        );
        const [isCreatingCampaign, setIsCreatingCampaign] = useState(false);
        const [pendingAction, setPendingAction] = useState(null);
        const [devTokenInput, setDevTokenInput] = useState('*****');

        const GROWTH_METRICS = [
          { id: 'yoy', name: 'Year over Year' },
          { id: 'mom', name: 'Month over Month' },
          { id: 'latest_vs_avg', name: 'Latest vs Average' },
          { id: 'latest_vs_max', name: 'Last Month vs Max' },
        ];

        const clearCache = () => {
          localStorage.clear();
          onReset();
        };

        // Handlers
        const [modalConfig, setModalConfig] = useState({
          isOpen: false,
          type: '',
          value: '',
          message: '',
          link: '',
        });

        const showAlert = (message, link = '') => {
          setModalConfig({
            isOpen: true,
            type: 'alert',
            message: message,
            value: '',
            link: link,
          });
        };

        const handleCustomOption = type => {
          setModalConfig({ isOpen: true, type, value: '' });
        };

        const submitModal = () => {
          const { type, value } = modalConfig;
          if (value && !isNaN(Number(value))) {
            if (type === 'language') {
              setCustomLanguages([
                ...customLanguages,
                { id: value, name: value },
              ]);
              setLanguage(value);
            } else {
              setCustomCountries([
                ...customCountries,
                { id: value, name: value },
              ]);
              setCountry(value);
            }
            setModalConfig({ isOpen: false, type: '', value: '' });
          } else {
            showAlert('Only Number IDs are allowed.');
          }
        };

        useEffect(() => {
          if (configStatus.checked) {
            setDevTokenInput('');
          }
        }, [configStatus]);

        const runExplore = async () => {
          if (!keywords.trim()) {
            showAlert('Please enter at least one seed keyword.');
            return;
          }
          const seedKeywords = keywords
            .split(',')
            .map(k => k.trim())
            .filter(Boolean);
          if (seedKeywords.length > 20) {
            showAlert('Maximum 20 keywords allowed.');
            return;
          }

          setIsExploring(true);

          if (isDemoMode) {
            setExploreStatus('Getting keyword ideas...');

            if (await loadExploreDemoData(isRandomized, 1500)) {
              return;
            }
          }

          setExploreStatus('Verifying configuration...');
          // Check properties on demand
          let currentStatus = configStatus;
          try {
            const status = await googleScriptRun.checkScriptProperties();
            setConfigStatus({ ...status, checked: true });
            if (status.adsAccountId) {
              setAdsAccountId(status.adsAccountId);
            }
            currentStatus = status;
          } catch (e) {
            console.error('Failed to check script properties:', e);
            // If we haven't checked successfully yet, we can't trust configStatus
            if (!configStatus.checked) {
              setIsExploring(false);
              showAlert(
                'Failed to verify configuration. Please check your connection and try again.'
              );
              return;
            }
            // If we have checked before, we use the cached status (currentStatus)
          }

          if (!currentStatus.hasDeveloperToken && !currentStatus.adsAccountId) {
            setIsExploring(false);
            setPendingAction(() => runExplore);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'BOTH',
              message:
                'Please configure your Developer Token and Ads Account ID to proceed.',
            });
            return;
          }

          if (!currentStatus.hasDeveloperToken) {
            setIsExploring(false);
            setPendingAction(() => runExplore);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'DEVELOPER_TOKEN',
              message: 'Please configure your Developer Token to proceed.',
            });
            return;
          }
          if (!currentStatus.adsAccountId) {
            setIsExploring(false);
            setPendingAction(() => runExplore);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'ADS_ACCOUNT_ID',
              message: 'Please configure your Ads Account ID to proceed.',
            });
            return;
          }

          setExploreStatus('Getting keyword ideas...');
          setIdeasData(null);
          setClusters(null);
          setSelectedCluster(null);

          try {
            const ideas = await googleScriptRun.generateKeywordIdeas(
              seedKeywords,
              country || undefined,
              language || undefined,
              5000
            );

            const validIdeas = ideas.filter(
              res => res.keywordIdeaMetrics !== undefined
            );

            const processedIdeas = validIdeas
              .flatMap(idea =>
                (idea.closeVariants || []).concat(idea.text).map(k => [k, idea])
              )
              .map(([k, res]) => ({
                text: k,
                searchVolume: res.keywordIdeaMetrics.monthlySearchVolumes.map(
                  item => Number(item.monthlySearches)
                ),
                months: res.keywordIdeaMetrics.monthlySearchVolumes.map(
                  item => `${item.month} ${item.year}`
                ),
              }));

            if (processedIdeas.length > 0) {
              setChartLabels(processedIdeas[0].months.slice());
            }

            setIdeasData(processedIdeas);

            // Filter relevant ideas
            const relevant = {};
            processedIdeas.forEach(idea => {
              if (idea.searchVolume.at(0) >= minSearchVolume) {
                // Check latest (index 0 usually)
                relevant[idea.text] = idea.searchVolume;
              }
            });
            setRelevantIdeas(relevant);

            setExploreStatus(`Clustering ${processedIdeas.length} ideas...`);

            const clusterResult = await googleScriptRun.getClusters(
              relevant,
              promptTemplate,
              geminiConfig
            );
            setClusters(clusterResult);
            setExploreStatus(
              `Done. Clustered ${processedIdeas.length} keywords.`
            );
          } catch (e) {
            console.error(e);
            setExploreStatus(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsExploring(false);
          }
        };

        const runTrends = async () => {
          if (!trendsKeywords.trim()) {
            showAlert('Please enter at least one seed keyword.');
            return;
          }
          setIsTrendsRunning(true);

          if (isDemoMode) {
            if (await loadTrendsDemoData(isRandomized, 1500)) {
              return;
            }
          }

          setTrendsStatus('Verifying configuration...');
          // Check properties on demand
          let currentStatus = configStatus;
          try {
            const status = await googleScriptRun.checkScriptProperties();
            setConfigStatus({ ...status, checked: true });
            if (status.adsAccountId) {
              setAdsAccountId(status.adsAccountId);
            }
            currentStatus = status;
          } catch (e) {
            console.error('Failed to check script properties:', e);
            // If we haven't checked successfully yet, we can't trust configStatus
            if (!configStatus.checked) {
              setIsTrendsRunning(false);
              showAlert(
                'Failed to verify configuration. Please check your connection and try again.'
              );
              return;
            }
            // If we have checked before, we use the cached status (currentStatus)
          }

          if (!currentStatus.hasDeveloperToken && !currentStatus.adsAccountId) {
            setIsTrendsRunning(false);
            setPendingAction(() => runTrends);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'BOTH',
              message:
                'Please configure your Developer Token and Ads Account ID to proceed.',
            });
            return;
          }

          if (!currentStatus.hasDeveloperToken) {
            setIsTrendsRunning(false);
            setPendingAction(() => runTrends);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'DEVELOPER_TOKEN',
              message: 'Please configure your Developer Token to proceed.',
            });
            return;
          }
          if (!currentStatus.adsAccountId) {
            setIsTrendsRunning(false);
            setPendingAction(() => runTrends);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'ADS_ACCOUNT_ID',
              message: 'Please configure your Ads Account ID to proceed.',
            });
            return;
          }

          setTrendsResults([]);
          try {
            setTrendsStatus('Generating trends keywords...');
            const keywords = trendsKeywords
              .split(',')
              .map(k => k.trim())
              .filter(Boolean);

            const trendKeywords = await googleScriptRun.generateTrendsKeywords(
              keywords,
              trendsPromptTemplate,
              geminiConfig
            );
            console.log('received trends result', trendKeywords);
            setTrendsStatus('Fetching historical metrics...');
            const criteriaId = undefined; // world
            const metrics = await googleScriptRun.getHistoricalMetrics(
              trendKeywords,
              criteriaId
            );

            const keywordData = metrics
              .filter(m => m && m.text && m.keywordMetrics)
              .map(metric => {
                const keywordText = metric.text;
                const historicalMetrics = metric.keywordMetrics;

                const volumes = (
                  historicalMetrics?.monthlySearchVolumes || []
                ).map(m => Number(m.monthlySearches));
                const latestSearchVolume = volumes[volumes.length - 1] || 0;
                const prevMonth = volumes[volumes.length - 2] || 0;
                const prevYear = volumes[volumes.length - 13] || 0;

                const growthYoY =
                  prevYear !== 0
                    ? (latestSearchVolume - prevYear) / prevYear
                    : 0;
                const growthMoM =
                  prevMonth !== 0
                    ? (latestSearchVolume - prevMonth) / prevMonth
                    : 0;

                const totalSum = volumes.reduce((a, b) => a + b, 0);
                const avg = volumes.length > 0 ? totalSum / volumes.length : 0;
                const growthLatestVsAvg =
                  avg !== 0 ? (latestSearchVolume - avg) / avg : 0;

                const max = Math.max(...volumes);
                const growthLatestVsMax =
                  max !== 0 ? (latestSearchVolume - max) / max : 0;

                return {
                  text: keywordText,
                  latestSearchVolume,
                  competition: historicalMetrics?.competition || null,
                  competition_index:
                    historicalMetrics?.competitionIndex || null,
                  low_top_of_page_bid_micros:
                    historicalMetrics?.lowTopOfPageBidMicros || null,
                  high_top_of_page_bid_micros:
                    historicalMetrics?.highTopOfPageBidMicros || null,
                  average_cpc_micros:
                    historicalMetrics?.averageCpcMicros || null,
                  growthYoY,
                  growthMoM,
                  growthLatestVsAvg,
                  growthLatestVsMax,
                  searchVolumeHistory: volumes,
                };
              });

            if (
              keywordData.length > 0 &&
              metrics[0]?.keywordMetrics?.monthlySearchVolumes
            ) {
              const firstMetric =
                metrics[0].keywordMetrics.monthlySearchVolumes;
              setChartLabels(
                firstMetric.map(item => `${item.month} ${item.year}`)
              );
            }

            setTrendsResults(keywordData);
            setTrendsStatus('');
          } catch (e) {
            console.error(e);
            setTrendsStatus(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsTrendsRunning(false);
          }
        };

        const generateInsights = async () => {
          if (Object.keys(relevantIdeas).length === 0) {
            showAlert('Please generate keywords in Explore tab first.');
            return;
          }
          setIsGeneratingInsights(true);

          if (isDemoMode) {
            const key = isRandomized ? 'giga_insights_random' : 'giga_insights';
            const cached = localStorage.getItem(key);

            if (cached) {
              await new Promise(resolve => setTimeout(resolve, 1500));
              setInsights(JSON.parse(cached));
              setIsGeneratingInsights(false);
              setInsightsStatus('');
              return;
            }
          }

          setInsightsStatus('');
          try {
            const seedKeywords = keywords
              .split(',')
              .map(k => k.trim())
              .filter(Boolean);
            const result = await googleScriptRun.getInsights(
              relevantIdeas,
              seedKeywords,
              growthMetric,
              geminiConfig
            );
            setInsights(result);

            if (isDemoMode) {
              const key = isRandomized
                ? 'giga_insights_random'
                : 'giga_insights';
              localStorage.setItem(key, JSON.stringify(result));
            }

            setInsightsStatus('');
          } catch (e) {
            setInsightsStatus(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsGeneratingInsights(false);
          }
        };

        const generateCampaignSuggestions = async () => {
          if (!insights) {
            showAlert('Please generate insights first.');
            return;
          }
          setIsGeneratingCampaigns(true);
          setCampaignStatus('Generating suggestions...');
          try {
            let adExamples = '';
            if (adsAccountId) {
              const ads = await googleScriptRun.getTopPerformingAdsAndKeywords(
                adsAccountId.replaceAll('-', '').trim(),
                10
              );
              adExamples = ads.map(ad => JSON.stringify(ad)).join('\n');
            }
            const langName =
              [...LANGUAGES, ...customLanguages].find(l => l.id === language)
                ?.name || language;
            const result = await googleScriptRun.getCampaigns(
              insights,
              langName,
              brandName,
              adExamples,
              geminiConfig
            );
            setCampaignSuggestions(result);
            setCampaignStatus('');
          } catch (e) {
            setCampaignStatus(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsGeneratingCampaigns(false);
          }
        };

        const generatePrompt = async () => {
          const id = creationAccountId.replaceAll('-', '').trim();
          if (!id) {
            showAlert('Please enter a Google Ads Account ID.');
            return;
          }
          setIsCreatingCampaign(true);
          setCreationResult('Generating prompt...');
          try {
            const result = await googleScriptRun.createCampaignPrompt(
              id,
              creationPromptTemplate,
              creationStyleGuide,
              creationInstructions,
              creationKeywords
            );
            setCreationResult(result);
          } catch (e) {
            setCreationResult(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsCreatingCampaign(false);
          }
        };

        const generateNewCampaigns = async () => {
          setIsCreatingCampaign(true);
          setCreationResult('Generating ad...');
          try {
            const kws = creationKeywords
              .split(',')
              .map(k => k.trim())
              .filter(Boolean);
            const prompt = `${creationStyleGuide}\n${creationInstructions}\n${creationPromptTemplate}`;
            const result = await googleScriptRun.createAdSuggestion(
              prompt,
              kws,
              geminiConfig
            );
            setCreationResult(JSON.stringify(result, null, 2));
          } catch (e) {
            setCreationResult(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsCreatingCampaign(false);
          }
        };

        // Charts Data Preparation
        const clustersChartData = useMemo(() => {
          if (!clusters) return null;
          const maxVol = Math.max(...clusters.map(c => c.searchVolume), 1);

          return {
            datasets: clusters.map((c, i) => {
              let yValue = 0;

              if (growthMetric === 'yoy') {
                yValue = c.growthYoY || c.yearOverYearGrowth || 0;
              } else if (growthMetric === 'mom') {
                yValue = c.growthMoM || 0;
              } else if (growthMetric === 'latest_vs_avg') {
                yValue = c.growthLatestVsAvg || 0;
              } else if (growthMetric === 'latest_vs_max') {
                yValue = c.growthLatestVsMax || 0;
              }

              return {
                label: c.topic,
                data: [
                  {
                    x: c.searchVolume || 0,
                    y: yValue,
                    r: 5 + ((c.searchVolume || 0) / maxVol) * 45,
                  },
                ],
                backgroundColor: COLOR_PALETTE[i % COLOR_PALETTE.length],
              };
            }),
          };
        }, [clusters, growthMetric]);

        const selectedClusterChartData = useMemo(() => {
          if (!selectedCluster || !chartLabels.length) return null;
          // searchVolumeHistory is likely New->Old (index 0 is latest).
          // We want Old->New (Left->Right), so we MUST reverse.
          const data = selectedCluster.searchVolumeHistory.slice();

          return {
            labels: chartLabels,
            datasets: [
              {
                label: `Search Volume: ${selectedCluster.topic}`,
                data: data,
                borderColor: COLOR_PALETTE[4],
                backgroundColor: COLOR_PALETTE[4] + '1A',
                fill: true,
                tension: 0.3,
              },
            ],
          };
        }, [selectedCluster, chartLabels]);

        const selectedTrendChartData = useMemo(() => {
          if (!selectedTrend || !chartLabels.length) return null;
          if (!Array.isArray(selectedTrend.searchVolumeHistory)) return null;

          const data = selectedTrend.searchVolumeHistory.slice();

          return {
            labels: chartLabels,
            datasets: [
              {
                label: `Search Volume: ${selectedTrend.text}`,
                data: data,
                borderColor: COLOR_PALETTE[3],
                backgroundColor: COLOR_PALETTE[3] + '1A',
                fill: true,
                tension: 0.3,
              },
            ],
          };
        }, [selectedTrend, chartLabels]);

        const seedChartData = useMemo(() => {
          if (!ideasData || !keywords || !chartLabels.length) return null;
          const seeds = keywords
            .split(',')
            .map(k => k.trim().toLowerCase())
            .filter(Boolean);
          const seedIdeas = ideasData.filter(idea =>
            seeds.includes(idea.text.toLowerCase())
          );

          if (seedIdeas.length === 0) return null;

          return {
            labels: chartLabels,
            datasets: seedIdeas.map((idea, index) => {
              const color = COLOR_PALETTE[index % COLOR_PALETTE.length];

              return {
                label: idea.text,
                data: idea.searchVolume, // Already in correct order? Check runExplore. Yes, processedIdeas maps monthlySearchVolumes.
                borderColor: color,
                backgroundColor: color, // Same as border for legend
                fill: false, // No fill
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
              };
            }),
          };
        }, [ideasData, keywords, chartLabels]);

        const bubbleChartOptions = useMemo(
          () => ({
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { title: { display: true, text: 'Search Volume' } },
              y: {
                title: {
                  display: true,
                  text:
                    GROWTH_METRICS.find(m => m.id === growthMetric)?.name ||
                    'Growth',
                },
                ticks: {
                  callback: value =>
                    (value > 0 ? '+' : '') + (value * 100).toFixed(0) + '%',
                },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx =>
                    `${ctx.dataset.label}: Vol ${ctx.raw.x}, Growth ${(ctx.raw.y > 0 ? '+' : '') + (ctx.raw.y * 100).toFixed(1)}%`,
                },
              },
            },
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const index = elements[0].datasetIndex;
                // We need to access the current clusters state here.
                // Since this function is inside useMemo, it will capture 'clusters' from the dependency array.
                if (clusters && clusters[index]) {
                  setSelectedCluster(clusters[index]);
                  setTimeout(() => {
                    document
                      .getElementById('cluster-details')
                      ?.scrollIntoView({ behavior: 'smooth' });
                  }, 100);
                }
              }
            },
          }),
          [growthMetric, clusters]
        );

        // --- Download Helpers ---
        const downloadFile = (content, filename, mimeType) => {
          const blob = new Blob([content], { type: mimeType });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };

        const convertToCSV = (headers, rows) => {
          const headerRow = headers.join(',');
          const bodyRows = rows.map(row =>
            row
              .map(cell => {
                const val = String(cell ?? '').replace(/"/g, '""');
                return `"${val}"`;
              })
              .join(',')
          );
          return [headerRow, ...bodyRows].join('\n');
        };

        const htmlToMarkdown = html => {
          let md = html;
          // Simple replacements for common tags
          md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n');
          md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n');
          md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n');
          md = md.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
          md = md.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
          md = md.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
          md = md.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
          md = md.replace(/<ul[^>]*>/gi, '\n');
          md = md.replace(/<\/ul>/gi, '\n');
          md = md.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n');
          md = md.replace(/<p[^>]*>/gi, '\n\n');
          md = md.replace(/<\/p>/gi, '');
          md = md.replace(/<br\s*\/?>/gi, '\n');
          // Strip remaining tags
          md = md.replace(/<[^>]+>/g, '');
          // Decode entities
          md = md.replace(/&nbsp;/g, ' ');
          md = md.replace(/&amp;/g, '&');
          md = md.replace(/&lt;/g, '<');
          md = md.replace(/&gt;/g, '>');
          return md.trim();
        };

        const handleDownloadExplore = () => {
          if (!clusters) return;
          const headers = [
            'Cluster Topic',
            'Keyword',
            'Latest Search Volume',
            'Cluster Growth YoY',
            'Cluster Growth MoM',
          ];
          const rows = [];

          clusters.forEach(cluster => {
            cluster.keywords.forEach(kw => {
              const history = relevantIdeas[kw];
              const vol = history && history.length > 0 ? history[0] : 0;
              rows.push([
                cluster.topic,
                kw,
                vol,
                (cluster.growthYoY * 100).toFixed(1) + '%',
                (cluster.growthMoM * 100).toFixed(1) + '%',
              ]);
            });
          });

          const csv = convertToCSV(headers, rows);
          downloadFile(csv, 'giga_explore_clusters.csv', 'text/csv');
        };

        const handleDownloadTrends = () => {
          if (!trendsResults || trendsResults.length === 0) return;
          const headers = [
            'Keyword',
            'Latest Volume',
            'Growth YoY',
            'Growth MoM',
            'Competition',
            'Low Bid (USD)',
            'High Bid (USD)',
            'Avg CPC (USD)',
          ];

          const rows = sortedTrendsResults.map(t => [
            t.text,
            t.latestSearchVolume,
            (t.growthYoY * 100).toFixed(1) + '%',
            (t.growthMoM * 100).toFixed(1) + '%',
            t.competition,
            t.low_top_of_page_bid_micros
              ? (t.low_top_of_page_bid_micros / 1000000).toFixed(2)
              : '',
            t.high_top_of_page_bid_micros
              ? (t.high_top_of_page_bid_micros / 1000000).toFixed(2)
              : '',
            t.average_cpc_micros
              ? (t.average_cpc_micros / 1000000).toFixed(2)
              : '',
          ]);

          const csv = convertToCSV(headers, rows);
          downloadFile(csv, 'giga_trends.csv', 'text/csv');
        };

        const handleDownloadInsights = () => {
          if (!insights) return;
          const md = htmlToMarkdown(insights);
          downloadFile(md, 'giga_insights.md', 'text/markdown');
        };

        // --- Render ---

        const handleSettingsSave = async newSettings => {
          setGeminiConfig(newSettings.geminiConfig);
          setMinSearchVolume(newSettings.minSearchVolume);
          setSpreadsheetUrl(newSettings.spreadsheetUrl);

          const promises = [];
          if (newSettings.adsAccountId !== configStatus.adsAccountId) {
            promises.push(
              updateScriptProperty('ADS_ACCOUNT_ID', newSettings.adsAccountId)
            );
          }
          if (newSettings.devToken) {
            promises.push(
              updateScriptProperty('DEVELOPER_TOKEN', newSettings.devToken)
            );
          }

          await Promise.all(promises);

          setModalConfig({ ...modalConfig, isOpen: false });
          if (pendingAction) {
            setTimeout(() => {
              pendingAction();
              setPendingAction(null);
            }, 100);
          }
        };

        const languageModal = (
          <Modal
            isOpen={modalConfig.isOpen && modalConfig.type === 'language'}
            onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
            title="Add Custom Language"
          >
            <div className="modal-body">
              <p className="text-sm text-muted mb-4">
                Enter the numeric Language ID from Google Ads API.
                <a
                  href={LANGUAGE_INFO_URL}
                  target="_blank"
                  rel="noopener noreferrer"
                  style={{ marginLeft: '4px', verticalAlign: 'middle' }}
                >
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '16px' }}
                  >
                    info
                  </span>
                </a>
              </p>
              <div className="input-group">
                <label>Language ID</label>
                <input
                  type="text"
                  value={modalConfig.value}
                  onChange={e =>
                    setModalConfig({ ...modalConfig, value: e.target.value })
                  }
                  placeholder="e.g. 1000"
                  autoFocus
                />
              </div>
              <div className="modal-actions">
                <button
                  className="btn"
                  onClick={() =>
                    setModalConfig({ ...modalConfig, isOpen: false })
                  }
                >
                  Cancel
                </button>
                <button className="btn btn-primary" onClick={submitModal}>
                  Add
                </button>
              </div>
            </div>
          </Modal>
        );

        const alertModal = (
          <Modal
            isOpen={modalConfig.isOpen && modalConfig.type === 'alert'}
            onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
            title="Alert"
            showCloseButton={false}
          >
            <div className="modal-body">
              <p>{modalConfig.message}</p>
              {modalConfig.link && (
                <p>
                  <a
                    href={modalConfig.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    style={{ wordBreak: 'break-all' }}
                  >
                    {modalConfig.link}
                  </a>
                </p>
              )}
              <div className="modal-actions">
                <button
                  className="btn btn-primary"
                  onClick={() =>
                    setModalConfig({ ...modalConfig, isOpen: false })
                  }
                >
                  OK
                </button>
              </div>
            </div>
          </Modal>
        );

        const updateScriptProperty = async (key, value) => {
          try {
            const status = await googleScriptRun.setScriptProperty(key, value);
            setConfigStatus({ ...status, checked: true });
            if (key === 'ADS_ACCOUNT_ID') {
              setAdsAccountId(value);
            }
            return true;
          } catch (e) {
            showError('Error updating property', e);
            return false;
          }
        };

        const handleOpenSettings = () => {
          setModalConfig({
            isOpen: true,
            type: 'settings',
            value: '',
            spreadsheetUrl: spreadsheetUrl,
          });
        };

        const ConfigModal = () => {
          const [localDevToken, setLocalDevToken] = useState('');
          const [localAdsId, setLocalAdsId] = useState('');
          const [isSaving, setIsSaving] = useState(false);

          if (!configStatus.checked) return null;
          if (configStatus.hasDeveloperToken && configStatus.hasAdsAccountId)
            return null;

          const handleSave = async () => {
            setIsSaving(true);
            try {
              if (!configStatus.hasDeveloperToken && localDevToken) {
                await updateScriptProperty('DEVELOPER_TOKEN', localDevToken);
              }
              if (!configStatus.hasAdsAccountId && localAdsId) {
                await updateScriptProperty('ADS_ACCOUNT_ID', localAdsId);
              }
            } finally {
              setIsSaving(false);
            }
          };

          return (
            <Modal
              isOpen={true}
              onClose={() => {}}
              title="Configuration Required"
            >
              <div className="modal-body">
                <p className="text-sm text-muted mb-4">
                  Please provide the following required configuration to
                  proceed.
                </p>
                {!configStatus.hasDeveloperToken && (
                  <div className="input-group">
                    <label>Developer Token</label>
                    <input
                      type="password"
                      value={localDevToken}
                      onChange={e => setLocalDevToken(e.target.value)}
                      placeholder="Enter Developer Token"
                    />
                  </div>
                )}
                {!configStatus.hasAdsAccountId && (
                  <div className="input-group">
                    <label>Ads Account ID</label>
                    <input
                      type="text"
                      value={localAdsId}
                      onChange={e => setLocalAdsId(e.target.value)}
                      placeholder="e.g. 123-456-7890"
                    />
                  </div>
                )}
                <div className="modal-actions">
                  <button
                    className="btn btn-primary"
                    onClick={handleSave}
                    disabled={
                      isSaving ||
                      (!configStatus.hasDeveloperToken && !localDevToken) ||
                      (!configStatus.hasAdsAccountId && !localAdsId)
                    }
                  >
                    {isSaving ? 'Saving...' : 'Save Configuration'}
                  </button>
                </div>
              </div>
            </Modal>
          );
        };

        const locationModal = (
          <Modal
            isOpen={modalConfig.isOpen && modalConfig.type === 'country'}
            onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
            title="Add Custom Location"
          >
            <div className="modal-body">
              <p className="text-sm text-muted mb-4">
                Enter the numeric Location ID from Google Ads API.
                <a
                  href={LOCATION_INFO_URL}
                  target="_blank"
                  rel="noreferrer noopener"
                  style={{ marginLeft: '4px', verticalAlign: 'middle' }}
                >
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '16px' }}
                  >
                    info
                  </span>
                </a>
              </p>
              <div className="input-group">
                <label>Location ID</label>
                <input
                  type="text"
                  value={modalConfig.value}
                  onChange={e =>
                    setModalConfig({ ...modalConfig, value: e.target.value })
                  }
                  placeholder="e.g. 2840"
                  autoFocus
                />
              </div>
              <div className="modal-actions">
                <button
                  className="btn"
                  onClick={() =>
                    setModalConfig({ ...modalConfig, isOpen: false })
                  }
                >
                  Cancel
                </button>
                <button className="btn btn-primary" onClick={submitModal}>
                  Add
                </button>
              </div>
            </div>
          </Modal>
        );

        return (
          <div className="app">
            <div
              style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px',
              }}
            >
              <h1>GIGA</h1>
              <div
                style={{ display: 'flex', alignItems: 'center', gap: '16px' }}
              >
                <button
                  className="btn"
                  onClick={handleOpenSettings}
                  style={{
                    background: 'transparent',
                    color: 'var(--text-secondary)',
                    border: '1px solid var(--border-color)',
                    padding: '8px',
                  }}
                >
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '1.5rem' }}
                  >
                    settings
                  </span>
                </button>
              </div>
            </div>

            <div className="tabs">
              <TabButton
                active={activeTab === 'explore'}
                onClick={() => setActiveTab('explore')}
              >
                Explore
              </TabButton>
              <TabButton
                active={activeTab === 'trends'}
                onClick={() => setActiveTab('trends')}
              >
                Trends
              </TabButton>
              <TabButton
                active={activeTab === 'insights'}
                onClick={() => setActiveTab('insights')}
              >
                Insights
              </TabButton>
              <TabButton
                active={activeTab === 'campaigns'}
                onClick={() => setActiveTab('campaigns')}
              >
                Campaign Suggestions
              </TabButton>
              <TabButton
                active={activeTab === 'creation'}
                onClick={() => setActiveTab('creation')}
              >
                Campaign Creation
              </TabButton>
            </div>

            {activeTab === 'explore' && (
              <div className="card fade-in">
                <h2>Explore Keywords</h2>
                <InputField
                  label="Seed Keywords"
                  value={keywords}
                  onChange={setKeywords}
                  placeholder="e.g. shoes, running shoes"
                  helpText="Comma separated, up to 20"
                  onKeyDown={e => {
                    if (e.key === 'Enter') {
                      runExplore();
                    }
                  }}
                />
                <div className="grid-2">
                  <SelectField
                    label="Language"
                    value={language}
                    onChange={setLanguage}
                    options={[...LANGUAGES, ...customLanguages]}
                    onCustomOption={() => handleCustomOption('language')}
                  />
                  <SelectField
                    label="Location"
                    value={country}
                    onChange={setCountry}
                    options={[...COUNTRIES, ...customCountries]}
                    onCustomOption={() => handleCustomOption('country')}
                  />
                </div>

                <details className="mb-4">
                  <summary className="cursor-pointer text-sm font-medium text-primary">
                    Advanced Config
                  </summary>
                  <div className="mt-4">
                    <div className="mt-4">
                      <InputField
                        type="textarea"
                        label="Clustering Prompt"
                        value={promptTemplate}
                        onChange={setPromptTemplate}
                        rows={6}
                      />
                    </div>
                  </div>
                </details>

                <button
                  className="btn btn-primary"
                  onClick={runExplore}
                  disabled={isExploring}
                >
                  {isExploring ? (
                    <>
                      <div className="spinner"></div>{' '}
                      {exploreStatus || 'Running...'}
                    </>
                  ) : (
                    <>
                      <span className="material-symbols-outlined">
                        rocket_launch
                      </span>{' '}
                      Start
                    </>
                  )}
                </button>

                {seedChartData && (
                  <div
                    className="mt-4 card"
                    style={{ border: '1px solid var(--primary)' }}
                  >
                    <h3>Seed Keywords Search Volume</h3>
                    <div style={{ height: '400px' }}>
                      <ChartComponent
                        type="line"
                        data={seedChartData}
                        options={{
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                            legend: {
                              position: 'bottom',
                              labels: { boxWidth: 10, padding: 10 },
                            },
                            tooltip: { mode: 'index', intersect: false },
                          },
                          interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false,
                          },
                          scales: {
                            y: { beginAtZero: true },
                          },
                        }}
                      />
                    </div>
                  </div>
                )}

                {clusters && (
                  <div
                    className="mt-4"
                    style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'flex-end',
                    }}
                  >
                    <div style={{ maxWidth: '300px' }}>
                      <SelectField
                        label="Growth Metric"
                        value={growthMetric}
                        onChange={setGrowthMetric}
                        options={GROWTH_METRICS}
                      />
                    </div>
                    <div>
                      <button
                        className="btn btn-secondary"
                        onClick={handleDownloadExplore}
                        style={{
                          background: 'white',
                          border: '1px solid var(--border-color)',
                        }}
                        title="Download CSV"
                      >
                        <span className="material-symbols-outlined">
                          download
                        </span>
                      </button>
                      <button
                        className="btn btn-secondary"
                        onClick={handleExportExploreToSheet}
                        style={{
                          background: 'white',
                          border: '1px solid var(--border-color)',
                          marginLeft: '8px',
                        }}
                        disabled={isExporting}
                        title="Export to Sheet"
                      >
                        {isExporting ? (
                          <div
                            className="spinner"
                            style={{
                              borderColor: 'rgba(37, 99, 235, 0.3)',
                              borderTopColor: '#2563eb',
                            }}
                          ></div>
                        ) : (
                          <span className="material-symbols-outlined">
                            table
                          </span>
                        )}
                      </button>
                    </div>
                  </div>
                )}

                {clustersChartData && (
                  <div className="mt-4">
                    <h3>Clusters</h3>
                    <div className="text-sm text-muted mb-2">
                      Click on a bubble to view details
                    </div>
                    <ChartComponent
                      type="bubble"
                      data={clustersChartData}
                      options={bubbleChartOptions}
                    />
                  </div>
                )}

                {selectedCluster && selectedClusterChartData && (
                  <div
                    id="cluster-details"
                    className="mt-4 card"
                    style={{ border: '1px solid var(--primary)' }}
                  >
                    <div
                      style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                      }}
                    >
                      <h3>Details: {selectedCluster.topic}</h3>
                      <button
                        onClick={() => setSelectedCluster(null)}
                        className="btn"
                        style={{ padding: '4px 8px' }}
                      >
                        &times;
                      </button>
                    </div>
                    <div className="grid-2">
                      <div>
                        <strong>Total Volume:</strong>{' '}
                        {selectedCluster.searchVolume.toLocaleString()}
                      </div>
                      <div>
                        <strong>
                          {GROWTH_METRICS.find(m => m.id === growthMetric)
                            ?.name || 'Growth'}
                          :
                        </strong>{' '}
                        {(() => {
                          let val = 0;
                          if (growthMetric === 'yoy')
                            val =
                              selectedCluster.growthYoY ||
                              selectedCluster.yearOverYearGrowth ||
                              0;
                          else if (growthMetric === 'mom')
                            val = selectedCluster.growthMoM || 0;
                          else if (growthMetric === 'latest_vs_avg')
                            val = selectedCluster.growthLatestVsAvg || 0;
                          else if (growthMetric === 'latest_vs_max')
                            val = selectedCluster.growthLatestVsMax || 0;
                          return (val * 100).toFixed(1);
                        })()}
                        %
                      </div>
                    </div>
                    <div className="mt-4">
                      <h4>Cluster Search Volume</h4>
                      <ChartComponent
                        type="line"
                        data={selectedClusterChartData}
                        options={{
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                            legend: { display: false },
                          },
                        }}
                      />
                    </div>
                    <div className="mt-4">
                      <h4>Keyword Search Volume</h4>
                      <div style={{ height: '400px' }}>
                        <ChartComponent
                          type="line"
                          data={{
                            labels: chartLabels,
                            datasets: selectedCluster.keywords.map((k, i) => {
                              const volHistory = relevantIdeas[k]
                                ? relevantIdeas[k]
                                : [];
                              const color =
                                COLOR_PALETTE[i % COLOR_PALETTE.length];
                              return {
                                label: k,
                                data: volHistory.slice(),
                                borderColor: color,
                                backgroundColor: color,
                                fill: false,
                                tension: 0.3,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                              };
                            }),
                          }}
                          options={{
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                              legend: {
                                position: 'bottom',
                                labels: { boxWidth: 10, padding: 10 },
                              },
                              tooltip: { mode: 'index', intersect: false },
                            },
                            interaction: {
                              mode: 'nearest',
                              axis: 'x',
                              intersect: false,
                            },
                            scales: {
                              y: { beginAtZero: true },
                            },
                          }}
                        />
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'trends' && (
              <div className="card fade-in">
                <h2>Trends Analysis</h2>
                <InputField
                  label="Seed Keywords"
                  value={trendsKeywords}
                  onChange={setTrendsKeywords}
                  placeholder="e.g. shoes, running shoes"
                  helpText=""
                  onKeyDown={e => {
                    if (e.key === 'Enter') {
                      runTrends();
                    }
                  }}
                />

                <details className="mb-4">
                  <summary className="cursor-pointer text-sm font-medium text-primary">
                    Advanced Config
                  </summary>
                  <div className="mt-4">
                    <div className="mt-4">
                      <InputField
                        type="textarea"
                        label="Trends Prompt"
                        value={trendsPromptTemplate}
                        onChange={setTrendsPromptTemplate}
                        rows={6}
                      />
                    </div>
                  </div>
                </details>

                <button
                  className="btn btn-primary"
                  onClick={runTrends}
                  disabled={isTrendsRunning}
                >
                  {isTrendsRunning ? (
                    <>
                      <div className="spinner"></div>{' '}
                      {trendsStatus || 'Generating trends keywords...'}
                    </>
                  ) : (
                    <>
                      <span className="material-symbols-outlined">
                        rocket_launch
                      </span>{' '}
                      Start
                    </>
                  )}
                </button>
                {trendsStatus && !isTrendsRunning && (
                  <div className="status-msg">{trendsStatus}</div>
                )}

                {trendsResults && trendsResults.length > 0 && (
                  <div style={{ marginTop: '32px' }}>
                    <div
                      style={{
                        display: 'flex',
                        gap: '16px',
                        alignItems: 'flex-start',
                      }}
                    >
                      <div style={{ flex: 1 }}>
                        <InputField
                          label="Filter by Keyword"
                          value={trendsFilters.keyword}
                          onChange={val =>
                            setTrendsFilters(prev => ({
                              ...prev,
                              keyword: val,
                            }))
                          }
                          placeholder="Search..."
                        />
                      </div>
                      <div style={{ width: '150px' }}>
                        <InputField
                          type="number"
                          label="Min Volume"
                          value={trendsFilters.minVolume}
                          onChange={val =>
                            setTrendsFilters(prev => ({
                              ...prev,
                              minVolume: val,
                            }))
                          }
                          placeholder="e.g. 100"
                        />
                      </div>
                      <div style={{ width: '200px' }}>
                        <SelectField
                          label="Growth Metric"
                          value={growthMetric}
                          onChange={setGrowthMetric}
                          options={GROWTH_METRICS}
                        />
                      </div>
                      <button
                        className="btn"
                        onClick={handleDownloadTrends}
                        style={{
                          background: 'white',
                          border: '1px solid var(--border-color)',
                          height: '42px',
                          marginTop: '24px',
                        }}
                        title="Download CSV"
                      >
                        <span className="material-symbols-outlined">
                          download
                        </span>
                      </button>
                      <button
                        className="btn"
                        onClick={handleExportTrendsToSheet}
                        style={{
                          background: 'white',
                          border: '1px solid var(--border-color)',
                          height: '42px',
                          marginTop: '24px',
                        }}
                        title="Export to Sheet"
                        disabled={isExporting}
                      >
                        {isExporting ? (
                          <div
                            className="spinner"
                            style={{
                              borderColor: 'rgba(37, 99, 235, 0.3)',
                              borderTopColor: '#2563eb',
                            }}
                          ></div>
                        ) : (
                          <span className="material-symbols-outlined">
                            table
                          </span>
                        )}
                      </button>
                    </div>

                    <div style={{ overflowX: 'auto' }}>
                      <table
                        style={{
                          width: '100%',
                          borderCollapse: 'collapse',
                          marginTop: '10px',
                          fontSize: '0.9rem',
                        }}
                      >
                        <thead>
                          <tr
                            style={{
                              borderBottom: '2px solid var(--border-color)',
                              color: 'var(--text-secondary)',
                            }}
                          >
                            <th
                              style={{
                                textAlign: 'left',
                                padding: '8px',
                                cursor: 'pointer',
                              }}
                              onClick={() => requestSort('text')}
                            >
                              Keyword{getSortIndicator('text')}
                            </th>
                            <th
                              style={{
                                textAlign: 'right',
                                padding: '8px',
                                cursor: 'pointer',
                              }}
                              onClick={() => requestSort('latestSearchVolume')}
                            >
                              Search Vol{getSortIndicator('latestSearchVolume')}
                            </th>
                            <th
                              style={{
                                textAlign: 'right',
                                padding: '8px',
                                cursor: 'pointer',
                              }}
                              onClick={() => requestSort('growth')}
                            >
                              Growth{getSortIndicator('growth')}
                            </th>
                            <th
                              style={{
                                textAlign: 'left',
                                padding: '8px',
                                cursor: 'pointer',
                              }}
                              onClick={() => requestSort('competition')}
                            >
                              Competition{getSortIndicator('competition')}
                            </th>
                            <th
                              style={{
                                textAlign: 'right',
                                padding: '8px',
                                cursor: 'pointer',
                              }}
                              onClick={() =>
                                requestSort('low_top_of_page_bid_micros')
                              }
                            >
                              Low Bid
                              {getSortIndicator('low_top_of_page_bid_micros')}
                            </th>
                            <th
                              style={{
                                textAlign: 'right',
                                padding: '8px',
                                cursor: 'pointer',
                              }}
                              onClick={() =>
                                requestSort('high_top_of_page_bid_micros')
                              }
                            >
                              High Bid
                              {getSortIndicator('high_top_of_page_bid_micros')}
                            </th>
                            <th
                              style={{
                                textAlign: 'right',
                                padding: '8px',
                                cursor: 'pointer',
                              }}
                              onClick={() => requestSort('average_cpc_micros')}
                            >
                              Avg CPC{getSortIndicator('average_cpc_micros')}
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          {sortedTrendsResults.map((item, index) => {
                            const text = item.text;
                            const vol = item.latestSearchVolume;
                            const comp = item.competition;
                            const idx = item.competition_index;
                            const low = item.low_top_of_page_bid_micros;
                            const high = item.high_top_of_page_bid_micros;
                            const cpc = item.average_cpc_micros;

                            let growth = 0;
                            if (growthMetric === 'yoy')
                              growth = item.growthYoY || 0;
                            else if (growthMetric === 'mom')
                              growth = item.growthMoM || 0;
                            else if (growthMetric === 'latest_vs_avg')
                              growth = item.growthLatestVsAvg || 0;
                            else if (growthMetric === 'latest_vs_max')
                              growth = item.growthLatestVsMax || 0;

                            const formatMoney = micros =>
                              micros != null
                                ? (micros / 1000000).toLocaleString('en-US', {
                                    style: 'currency',
                                    currency: 'USD',
                                  })
                                : '-';

                            return (
                              <React.Fragment key={index}>
                                <tr
                                  style={{
                                    borderBottom:
                                      '1px solid var(--border-color)',
                                    cursor: 'pointer',
                                    backgroundColor:
                                      selectedTrend?.text === text
                                        ? 'rgba(37, 99, 235, 0.05)'
                                        : 'transparent',
                                  }}
                                  onClick={() =>
                                    setSelectedTrend(
                                      selectedTrend?.text === text ? null : item
                                    )
                                  }
                                >
                                  <td style={{ padding: '8px' }}>
                                    <div
                                      style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                      }}
                                    >
                                      <span
                                        className="material-symbols-outlined"
                                        style={{
                                          fontSize: '1.2rem',
                                          color: 'var(--primary)',
                                          transition: 'transform 0.2s',
                                          transform:
                                            selectedTrend?.text === text
                                              ? 'rotate(90deg)'
                                              : 'rotate(0deg)',
                                        }}
                                      >
                                        chevron_right
                                      </span>
                                      {text}
                                    </div>
                                  </td>
                                  <td
                                    style={{
                                      padding: '8px',
                                      textAlign: 'right',
                                    }}
                                  >
                                    {vol != null ? vol.toLocaleString() : '-'}
                                  </td>
                                  <td
                                    style={{
                                      padding: '8px',
                                      textAlign: 'right',
                                      color:
                                        growth > 0
                                          ? 'var(--success)'
                                          : growth < 0
                                            ? 'var(--error)'
                                            : 'inherit',
                                    }}
                                  >
                                    {growth > 0 ? '+' : ''}
                                    {(growth * 100).toFixed(1)}%
                                  </td>
                                  <td style={{ padding: '8px' }}>
                                    {comp ? `${comp} (${idx ?? '-'})` : '-'}
                                  </td>
                                  <td
                                    style={{
                                      padding: '8px',
                                      textAlign: 'right',
                                    }}
                                  >
                                    {formatMoney(low)}
                                  </td>
                                  <td
                                    style={{
                                      padding: '8px',
                                      textAlign: 'right',
                                    }}
                                  >
                                    {formatMoney(high)}
                                  </td>
                                  <td
                                    style={{
                                      padding: '8px',
                                      textAlign: 'right',
                                    }}
                                  >
                                    {formatMoney(cpc)}
                                  </td>
                                </tr>
                                {selectedTrend?.text === text && (
                                  <tr
                                    style={{
                                      backgroundColor:
                                        'rgba(37, 99, 235, 0.05)',
                                    }}
                                  >
                                    <td colSpan={7} style={{ padding: '16px' }}>
                                      <div className="grid-2 mb-4">
                                        <div>
                                          <strong>Total Volume:</strong>{' '}
                                          {selectedTrend.latestSearchVolume?.toLocaleString() ??
                                            '-'}
                                        </div>
                                        <div>
                                          <strong>
                                            {GROWTH_METRICS.find(
                                              m => m.id === growthMetric
                                            )?.name || 'Growth'}
                                            :
                                          </strong>{' '}
                                          {(() => {
                                            let val = 0;
                                            if (growthMetric === 'yoy')
                                              val =
                                                selectedTrend.growthYoY || 0;
                                            else if (growthMetric === 'mom')
                                              val =
                                                selectedTrend.growthMoM || 0;
                                            else if (
                                              growthMetric === 'latest_vs_avg'
                                            )
                                              val =
                                                selectedTrend.growthLatestVsAvg ||
                                                0;
                                            else if (
                                              growthMetric === 'latest_vs_max'
                                            )
                                              val =
                                                selectedTrend.growthLatestVsMax ||
                                                0;
                                            return (val * 100).toFixed(1);
                                          })()}
                                          %
                                        </div>
                                      </div>
                                      {selectedTrendChartData ? (
                                        <ChartComponent
                                          type="line"
                                          data={selectedTrendChartData}
                                          options={{
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: {
                                              legend: { display: false },
                                            },
                                          }}
                                        />
                                      ) : (
                                        <div
                                          className="text-muted"
                                          style={{
                                            padding: '20px',
                                            background: '#f1f5f9',
                                            borderRadius: '8px',
                                            textAlign: 'center',
                                          }}
                                        >
                                          No historical data available for this
                                          keyword. <br />
                                          Please re-run the analysis to fetch
                                          the latest data.
                                        </div>
                                      )}
                                    </td>
                                  </tr>
                                )}
                              </React.Fragment>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                    <div
                      className="text-sm text-muted mt-4"
                      style={{ textAlign: 'right' }}
                    >
                      Trends Keywords ({sortedTrendsResults.length} /{' '}
                      {trendsResults.length})
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'insights' && (
              <div className="card fade-in">
                <h2>Insights</h2>
                <div
                  className="mb-4"
                  dangerouslySetInnerHTML={{ __html: insights }}
                />
                <div
                  style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginTop: '16px',
                  }}
                >
                  <button
                    className="btn btn-primary"
                    onClick={generateInsights}
                    disabled={isGeneratingInsights}
                  >
                    {isGeneratingInsights ? (
                      <>
                        <div className="spinner"></div> Generating Insights...
                      </>
                    ) : (
                      <>
                        <span className="material-symbols-outlined">
                          lightbulb
                        </span>{' '}
                        Generate Insights
                      </>
                    )}
                  </button>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {insights && (
                      <button
                        className="btn btn-secondary"
                        onClick={handleDownloadInsights}
                        style={{
                          background: 'white',
                          border: '1px solid var(--border-color)',
                        }}
                        title="Download Markdown"
                      >
                        <span className="material-symbols-outlined">
                          download
                        </span>
                      </button>
                    )}
                    {insights && (
                      <button
                        className="btn btn-secondary"
                        onClick={handleExportInsightsToSheet}
                        style={{
                          background: 'white',
                          border: '1px solid var(--border-color)',
                        }}
                        disabled={isExporting}
                        title="Export to Sheet"
                      >
                        {isExporting ? (
                          <div
                            className="spinner"
                            style={{
                              borderColor: 'rgba(37, 99, 235, 0.3)',
                              borderTopColor: '#2563eb',
                            }}
                          ></div>
                        ) : (
                          <span className="material-symbols-outlined">
                            table
                          </span>
                        )}
                      </button>
                    )}
                  </div>
                </div>
                {insightsStatus && (
                  <div className="status-msg">{insightsStatus}</div>
                )}
              </div>
            )}

            {activeTab === 'campaigns' && (
              <div className="card fade-in">
                <h2>Campaign Suggestions</h2>
                <div className="grid-2">
                  <InputField
                    label={
                      <span
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '4px',
                        }}
                      >
                        Google Ads Account ID
                        <a
                          href={GOOGLE_ADS_ID_HELP_URL}
                          target="_blank"
                          rel="noopener noreferrer"
                          style={{
                            textDecoration: 'none',
                            color: 'inherit',
                            display: 'flex',
                          }}
                          title="Find your Google Ads customer ID"
                        >
                          <span
                            className="material-symbols-outlined"
                            style={{ fontSize: '16px', cursor: 'pointer' }}
                          >
                            info
                          </span>
                        </a>
                      </span>
                    }
                    value={adsAccountId}
                    onChange={setAdsAccountId}
                    placeholder="123-456-7890"
                  />
                  <InputField
                    label="Brand Name"
                    value={brandName}
                    onChange={setBrandName}
                    placeholder="My Brand"
                  />
                </div>
                <div
                  className="mb-4 mt-4"
                  dangerouslySetInnerHTML={{ __html: campaignSuggestions }}
                />
                <div
                  style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginTop: '16px',
                  }}
                >
                  <button
                    className="btn btn-primary"
                    onClick={generateCampaignSuggestions}
                    disabled={isGeneratingCampaigns}
                  >
                    {isGeneratingCampaigns ? (
                      <>
                        <div className="spinner"></div>{' '}
                        {campaignStatus || 'Generating...'}
                      </>
                    ) : (
                      <>
                        <span className="material-symbols-outlined">
                          campaign
                        </span>{' '}
                        Generate Suggestions
                      </>
                    )}
                  </button>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {campaignSuggestions && (
                      <button
                        className="btn btn-secondary"
                        onClick={handleDownloadCampaigns}
                        style={{
                          background: 'white',
                          border: '1px solid var(--border-color)',
                        }}
                        title="Download Markdown"
                      >
                        <span className="material-symbols-outlined">
                          download
                        </span>
                      </button>
                    )}
                    {campaignSuggestions && (
                      <button
                        className="btn btn-secondary"
                        onClick={handleExportCampaignsToSheet}
                        style={{
                          background: 'white',
                          border: '1px solid var(--border-color)',
                        }}
                        disabled={isExporting}
                        title="Export to Sheet"
                      >
                        {isExporting ? (
                          <div
                            className="spinner"
                            style={{
                              borderColor: 'rgba(37, 99, 235, 0.3)',
                              borderTopColor: '#2563eb',
                            }}
                          ></div>
                        ) : (
                          <span className="material-symbols-outlined">
                            table
                          </span>
                        )}
                      </button>
                    )}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'creation' && (
              <div className="card fade-in">
                <h2>Campaign Creation</h2>
                <InputField
                  label={
                    <span
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '4px',
                      }}
                    >
                      Google Ads Account ID
                      <a
                        href={GOOGLE_ADS_ID_HELP_URL}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{
                          textDecoration: 'none',
                          color: 'inherit',
                          display: 'flex',
                        }}
                        title="Find your Google Ads customer ID"
                      >
                        <span
                          className="material-symbols-outlined"
                          style={{ fontSize: '16px', cursor: 'pointer' }}
                        >
                          info
                        </span>
                      </a>
                    </span>
                  }
                  value={creationAccountId}
                  onChange={setCreationAccountId}
                />

                <div className="grid-2">
                  <div className="mt-4">
                    <button
                      className="btn btn-primary"
                      onClick={generatePrompt}
                    >
                      Generate Pre-Prompt
                    </button>
                  </div>
                </div>

                <InputField
                  type="textarea"
                  label="Prompt Template"
                  value={creationPromptTemplate}
                  onChange={setCreationPromptTemplate}
                  rows={6}
                />
                <InputField
                  type="textarea"
                  label="Style Guide"
                  value={creationStyleGuide}
                  onChange={setCreationStyleGuide}
                  rows={6}
                />
                <InputField
                  type="textarea"
                  label="Instructions"
                  value={creationInstructions}
                  onChange={setCreationInstructions}
                  rows={3}
                />
                <InputField
                  label="Campaign Keywords"
                  value={creationKeywords}
                  onChange={setCreationKeywords}
                  placeholder="keyword1, keyword2"
                />

                <div className="mt-4">
                  <button
                    className="btn btn-primary"
                    onClick={generateNewCampaigns}
                    disabled={isCreatingCampaign}
                  >
                    {isCreatingCampaign ? 'Creating...' : 'Generate Ad'}
                    <span className="material-symbols-outlined">
                      add_circle
                    </span>
                  </button>
                </div>

                {creationResult && (
                  <pre className="mt-4 p-4 bg-gray-100 rounded overflow-auto">
                    {creationResult}
                  </pre>
                )}
              </div>
            )}

            {languageModal}
            {locationModal}
            <SettingsModal
              isOpen={modalConfig.isOpen && modalConfig.type === 'settings'}
              onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
              modalConfig={modalConfig}
              geminiConfig={geminiConfig}
              minSearchVolume={minSearchVolume}
              configStatus={configStatus}
              onSave={handleSettingsSave}
              onClearCache={clearCache}
            />
            {alertModal}
            <ErrorModal
              isOpen={errorState.isOpen}
              onClose={() => setErrorState({ ...errorState, isOpen: false })}
              error={errorState}
            />
            {isDemoMode && isRandomized && (
              <div className="warning-footer">
                ⚠ Search volume and other metrics are randomized for
                demonstration ⚠
              </div>
            )}
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        const [resetKey, setResetKey] = useState(0);
        const [isDemoMode, setIsDemoMode] = useState(false);
        const [isReady, setIsReady] = useState(false);

        useEffect(() => {
          const checkDemo = () => {
            if (
              typeof google !== 'undefined' &&
              google.script &&
              google.script.url
            ) {
              try {
                google.script.url.getLocation(location => {
                  const demo = location.parameter['demo'] === 'true';
                  console.log('Demo Mode:', demo);
                  setIsDemoMode(demo);
                  setIsReady(true);
                });
              } catch (e) {
                console.warn('Error checking location:', e);
                setIsReady(true);
              }
            } else {
              setIsReady(true);
            }
          };

          checkDemo();

          // Safety timeout
          const timer = setTimeout(() => {
            if (!isReady) setIsReady(true);
          }, 2000);
          return () => clearTimeout(timer);
        }, [isReady]);

        const handleReset = () => setResetKey(prev => prev + 1);

        if (!isReady) {
          return (
            <div
              style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                height: '100vh',
                fontFamily: 'sans-serif',
                color: '#64748b',
              }}
            >
              Loading GIGA...
            </div>
          );
        }

        return (
          <GigaApp
            key={resetKey}
            onReset={handleReset}
            isDemoMode={isDemoMode}
          />
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
