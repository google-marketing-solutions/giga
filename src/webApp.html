<!--
Copyright 2025 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!doctype html>
<html>
  <head>
    <title>GIGA</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js & React Chart.js 2 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --secondary: #64748b;
        --bg-color: #f8fafc;
        --surface-color: #ffffff;
        --text-main: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
        --success: #10b981;
        --error: #ef4444;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md:
          0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg:
          0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      }

      [data-theme='dark'] {
        --primary: #60a5fa;
        --primary-dark: #3b82f6;
        --secondary: #94a3b8;
        --bg-color: #0f172a;
        --surface-color: #1e293b;
        --text-main: #f1f5f9;
        --text-secondary: #94a3b8;
        --border-color: #334155;
        --success: #34d399;
        --error: #f87171;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Outfit', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
      }

      #root {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Premium UI Components */
      .card {
        background: var(--surface-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid var(--border-color);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .chips-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-color);
        min-height: 42px;
        align-items: center;
        cursor: text;
        transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
      }
      .chips-container:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        background: white;
      }
      .chip {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--primary);
        padding: 4px 8px 4px 12px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        font-size: 0.95rem;
        font-weight: 500;
      }
      .chip .close-icon {
        font-size: 16px;
        margin-left: 4px;
        cursor: pointer;
        color: var(--primary);
        opacity: 0.7;
        border-radius: 50%;
        padding: 2px;
      }
      .chip .close-icon:hover {
        opacity: 1;
        background-color: rgba(37, 99, 235, 0.1);
      }
      input.chips-input-field {
        border: none;
        border-radius: 0;
        outline: none;
        background: transparent;
        box-shadow: none;
        flex: 1;
        min-width: 60px;
        font-size: 1rem;
        padding: 4px;
        color: var(--text-main);
      }
      input.chips-input-field:focus {
        box-shadow: none;
        border: none;
        background: transparent;
      }


      .card:hover {
        box-shadow: var(--shadow-lg);
      }

      h1,
      h2,
      h3 {
        margin-top: 0;
        font-weight: 600;
        color: var(--text-main);
      }

      h1 {
        font-size: 3rem;
        letter-spacing: -0.025em;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 1.5rem;
      }
      h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }
      h3 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
      }

      /* Inputs */
      .input-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--text-secondary);
      }

      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        padding: 10px 14px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s;
        box-sizing: border-box;
        color: var(--text-main);
      }

      input[type='text']:focus,
      input[type='number']:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        background: var(--surface-color);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.4);
      }

      .btn-primary:active:not(:disabled) {
        transform: translateY(0);
      }

      .btn-secondary {
        background: transparent;
        color: var(--text-main);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover:not(:disabled) {
        background: var(--bg-color);
        border-color: var(--primary);
        color: var(--primary);
      }

      .btn-icon {
        cursor: pointer;
        padding: 8px;
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid transparent;
        border-radius: 8px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-icon:hover {
        background: var(--bg-color);
        border-color: var(--border-color);
        color: var(--text-main);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        filter: grayscale(1);
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: var(--surface-color);
        padding: 6px;
        border-radius: var(--radius-lg);
        backdrop-filter: blur(8px);
        border: 1px solid var(--border-color);
        overflow-x: auto;
      }

      .tab-btn {
        padding: 10px 20px;
        border-radius: var(--radius-md);
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .tab-btn.active {
        background: var(--bg-color);
        color: var(--primary);
        box-shadow: var(--shadow-sm);
        font-weight: 600;
      }

      .tab-btn:hover:not(.active) {
        background: var(--bg-color);
        color: var(--text-main);
      }

      /* Loading & Status */
      .status-msg {
        margin-top: 12px;
        padding: 12px;
        border-radius: var(--radius-md);
        background: #eff6ff;
        color: #1e40af;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Helper classes */
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .text-sm {
        font-size: 0.875rem;
      }
      .text-muted {
        color: var(--text-secondary);
      }

      /* Chart Container */
      .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-top: 20px;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease-out;
      }
      .modal-content {
        background: var(--surface-color);
        color: var(--text-main);
        padding: 2rem;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-lg);
        width: 90%;
        max-width: 500px;
        animation: slideUp 0.2s ease-out;
        max-height: 90vh;
        overflow-y: auto;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .error-message {
        word-break: break-word;
        margin-bottom: 1rem;
      }

      .error-details {
        font-family: monospace;
        font-size: 0.875rem;
        white-space: pre;
        color: #991b1b;
        max-height: 200px;
        overflow: auto;
        padding: 8px;
        background: rgba(153, 27, 27, 0.05);
        border-radius: 4px;
      }

      .error-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: auto;
      }

      .error-actions .btn {
        height: 42px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      /* Spinner */
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      @keyframes bounceHorizontal {
        0%,
        100% {
          transform: translateX(0) translateY(-50%);
        }
        50% {
          transform: translateX(-10px) translateY(-50%);
        }
      }

      /* Toggle Switch */
      .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: '';
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--primary);
      }
      input:focus + .slider {
        box-shadow: 0 0 1px var(--primary);
      }
      input:checked + .slider:before {
        transform: translateX(16px);
      }

      /* Warning Footer */
      .warning-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #ef5350;
        color: white;
        text-align: center;
        padding: 10px;
        font-weight: bold;
        z-index: 2000;
      }

      /* Header Action Button (Reset) */
      .header-action-btn {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .header-action-btn:hover {
        background: #f3f4f6;
        border-color: #e5e7eb;
        color: var(--text-main);
      }

      /* Ad Preview */
      .ad-preview {
        font-family: arial, sans-serif;
        padding: 16px;
        background: #fff;
        border: 1px solid #dfe1e5;
        border-radius: 8px;
        margin-top: 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .ad-label {
        font-weight: bold;
        color: #202124;
        font-size: 12px;
        margin-right: 8px;
      }
      .ad-url {
        color: #202124;
        font-size: 12px;
        display: inline-block;
      }
      .ad-headline {
        color: #1a0dab;
        font-size: 20px;
        line-height: 1.3;
        cursor: pointer;
        margin: 4px 0 2px 0;
        display: flex;
        align-items: center;
      }
      .ad-headline:hover {
        text-decoration: underline;
      }
      .ad-description {
        color: #4d5156;
        font-size: 14px;
        line-height: 1.58;
        display: flex;
        align-items: center;
      }
      .preview-controls {
        display: flex;
        gap: 4px;
        margin-left: 8px;
        opacity: 0.3;
        transition: opacity 0.2s;
      }
      .ad-headline:hover .preview-controls,
      .ad-description:hover .preview-controls {
        opacity: 1;
        text-decoration: none;
      }
      .control-btn {
        background: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        padding: 0 4px;
        display: flex;
        align-items: center;
        color: #555;
      }
      .control-btn:hover {
        background: #f1f1f1;
        color: #000;
      }
      .error-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
      }
      .error-title {
        margin: 0;
        font-size: 1.5rem;
        color: #dc2626;
      }
      .error-icon {
        font-size: 2rem;
        color: #dc2626;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      const USER_EMAIL = <?= userEmail ?>;
    </script>

    <!-- Backend Proxy -->
    <script>
      const googleScriptRun = new Proxy(
        {},
        {
          get:
            (target, prop) =>
            (...args) => {
              console.log(`Running ${prop} in AppsScript backend...`);
              return new Promise((resolve, reject) => {
                if (!google.script.run) {
                  // Mock for local dev if needed, or just fail
                  reject(new Error('google.script.run not available'));
                  return;
                }
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  [prop](...args);
              });
            },
        }
      );
    </script>

    <?!= include('utils'); ?> <?!= include('components'); ?> <?!=
    include('tabExplore'); ?> <?!= include('tabInsights'); ?> <?!=
    include('tabCampaigns'); ?>

    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo } = React;

      // Load Globals from Window
      const {
        COLOR_PALETTE,
        LANGUAGES,
        COUNTRIES,
        DEFAULT_PROMPT,
        DEFAULT_TRENDS_PROMPT,
        LANGUAGE_INFO_URL,
        LOCATION_INFO_URL,
        GOOGLE_ADS_ID_HELP_URL,
        GROWTH_METRICS,
        useStickyState,
        formatMicrosToCurrency,
        htmlToMarkdown,
        convertToCSV,
        downloadFile,
        APP_VERSION,
        compareVersions,
      } = window;

      const {
        TabButton,
        InputField,
        Modal,
        ErrorModal,
        SelectField,
        ChartComponent,
        SettingsModal,
        AdPreview,
      } = window;

      const { ExploreTab, InsightsTab, CampaignsTab } = window;

      // --- Main App ---

      // eslint-disable-next-line no-unused-vars
      const GigaApp = ({ onReset, isDemoMode }) => {
        const [activeTab, setActiveTab] = useStickyState(
          'explore',
          'giga_activeTab'
        );

        // Version State
        const [showVersionModal, setShowVersionModal] = useState(false);
        const [versionUpdateType, setVersionUpdateType] = useState(''); // 'major', 'minor', 'patch'

        // Theme State
        const [theme, setTheme] = useStickyState('light', 'giga_theme');

        useEffect(() => {
          document.documentElement.setAttribute('data-theme', theme);

          // Update Chart.js defaults
          const isDark = theme === 'dark';
          const textColor = isDark ? '#f1f5f9' : '#1e293b';
          const gridColor = isDark ? '#334155' : '#e2e8f0';

          Chart.defaults.color = textColor;
          Chart.defaults.borderColor = gridColor;
          Chart.defaults.scale.grid.color = gridColor;
        }, [theme]);

        const toggleTheme = () => {
          setTheme(prev => (prev === 'light' ? 'dark' : 'light'));
        };

        // Version Check Effect
        useEffect(() => {
          const checkVersion = () => {
            const cachedVersion = localStorage.getItem('giga_version');
            if (!cachedVersion) {
              // First run or no version set, just set it
              localStorage.setItem('giga_version', APP_VERSION);
              return;
            }

            const diff = compareVersions(cachedVersion, APP_VERSION);
            if (diff === 'major' || diff === 'minor') {
              setVersionUpdateType(diff);
              setShowVersionModal(true);
            } else if (diff === 'patch') {
              // Silent update for patch
              localStorage.setItem('giga_version', APP_VERSION);
            }
          };
          checkVersion();
        }, []);

        const handleVersionUpdate = shouldClearCache => {
          if (shouldClearCache) {
            clearCache();
          } else {
            // Update version without clearing cache
            localStorage.setItem('giga_version', APP_VERSION);
            // Force reload to ensure fresh state if needed, or just close modal
            // Ideally we might want to reload, but for now just updating version is enough to stop modal
          }
          setShowVersionModal(false);
        };

        // Explore State
        const [keywords, setKeywords] = useStickyState('', 'giga_keywords');
        const [language, setLanguage] = useStickyState('1000', 'giga_language');
        const [country, setCountry] = useStickyState('', 'giga_country');
        const [customLanguages, setCustomLanguages] = useStickyState(
          [],
          'giga_customLanguages'
        );
        const [customCountries, setCustomCountries] = useStickyState(
          [],
          'giga_customCountries'
        );
        const [promptTemplate, setPromptTemplate] = useStickyState(
          DEFAULT_PROMPT,
          'giga_promptTemplate'
        );
        const [geminiPrompt, setGeminiPrompt] = useStickyState(
          DEFAULT_TRENDS_PROMPT,
          'giga_geminiPrompt'
        );
        const [useKeywordPlanner, setUseKeywordPlanner] = useStickyState(
          true,
          'giga_useKeywordPlanner'
        );
        const [useGemini, setUseGemini] = useStickyState(
          true,
          'giga_useGemini'
        );
        const [useClustering, setUseClustering] = useStickyState(
          true,
          'giga_useClustering'
        );
        const [exploreStatus, setExploreStatus] = useState('');
        const [isExploring, setIsExploring] = useState(false);
        const [ideasData, setIdeasData] = useStickyState(
          null,
          'giga_ideasData',
          isDemoMode
        );
        const [clusters, setClusters] = useStickyState(
          null,
          'giga_clusters',
          isDemoMode
        );
        const [relevantIdeas, setRelevantIdeas] = useStickyState(
          {},
          'giga_relevantIdeas',
          isDemoMode
        );
        const [selectedCluster, setSelectedCluster] = useState(null);
        const [chartLabels, setChartLabels] = useStickyState(
          [],
          'giga_chartLabels',
          isDemoMode
        );
        const [minSearchVolume, setMinSearchVolume] = useStickyState(
          100,
          'giga_minSearchVolume'
        );
        const [highlightKeywordSources, setHighlightKeywordSources] =
          useState(false);

        const [spreadsheetUrl, setSpreadsheetUrl] = useStickyState(
          '',
          'giga_spreadsheetUrl'
        );

        // Insights State
        const [insights, setInsights] = useStickyState(
          '',
          'giga_insights',
          isDemoMode
        );
        const [insightsLanguage, setInsightsLanguage] = useStickyState(
          'English',
          'giga_insightsLanguage'
        );
        const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);
        const [insightsStatus, setInsightsStatus] = useState('');

        // Campaigns State
        const [adsAccountId, setAdsAccountId] = useStickyState(
          '',
          'giga_adsAccountId'
        );
        const [brandName, setBrandName] = useStickyState('', 'giga_brandName');
        const [campaignSuggestions, setCampaignSuggestions] = useStickyState(
          '',
          'giga_campaignSuggestions'
        );
        const [isGeneratingCampaigns, setIsGeneratingCampaigns] =
          useState(false);
        const [campaignStatus, setCampaignStatus] = useState('');
        const [showIdInfo, setShowIdInfo] = useState(false);
        const [showBrandInfo, setShowBrandInfo] = useState(false);

        // Demo Mode Randomization
        const [isRandomized, setIsRandomized] = useState(true);

        // --- Sheet Export Helper ---
        const [isExporting, setIsExporting] = useState(false);

        const handleSheetExport = async (
          sheetName,
          header,
          rows,
          columnFormats = []
        ) => {
          setIsExporting(true);
          try {
            let targetUrl = spreadsheetUrl;
            let isNewSheet = false;
            if (!targetUrl) {
              targetUrl =
                await googleScriptRun.createSpreadsheet('Giga Export');
              setSpreadsheetUrl(targetUrl);
              isNewSheet = true;
            }
            await googleScriptRun.exportToSheet(
              targetUrl,
              sheetName,
              header,
              rows,
              columnFormats
            );
            if (isNewSheet) {
              showAlert(
                `Successfully exported to a new spreadsheet. You can change the destination URL in Settings. Note: The user (${USER_EMAIL}) must have edit access to this spreadsheet for future exports.`,
                targetUrl
              );
            } else {
              showAlert('Successfully exported to:', targetUrl);
            }
          } catch (e) {
            showError('Export Failed', e);
          } finally {
            setIsExporting(false);
          }
        };

        const handleExportExploreToSheet = () => {
          if (!clusters) return;
          const headers = [
            'Cluster Topic',
            'Keyword',
            'Latest Search Volume',
            'Cluster Growth YoY',
            'Cluster Growth MoM',
            'Competition',
            'Low Bid (Micros)',
            'High Bid (Micros)',
            'Avg CPC (Micros)',
          ];
          const rows = [];

          clusters.forEach(cluster => {
            cluster.keywords.forEach(kw => {
              const history = relevantIdeas[kw];
              const vol = history && history.length > 0 ? history[0] : 0;
              const idea = ideasData
                ? ideasData.find(i => i.text === kw)
                : null;

              rows.push([
                cluster.topic,
                kw,
                vol,
                cluster.growthYoY,
                cluster.growthMoM,
                idea ? idea.competition : '',
                idea ? idea.low_top_of_page_bid_micros : '',
                idea ? idea.high_top_of_page_bid_micros : '',
                idea ? idea.average_cpc_micros : '',
              ]);
            });
          });

          const columnFormats = [
            { colIndex: 2, numberFormat: '#,##0' },
            { colIndex: 3, numberFormat: '0.00%' },
            { colIndex: 4, numberFormat: '0.00%' },
            {
              colIndex: 6,
              numberFormat: '"$"#,##0.00',
              scale: 0.000001,
              headerRename: 'Low Bid (USD)',
            },
            {
              colIndex: 7,
              numberFormat: '"$"#,##0.00',
              scale: 0.000001,
              headerRename: 'High Bid (USD)',
            },
            {
              colIndex: 8,
              numberFormat: '"$"#,##0.00',
              scale: 0.000001,
              headerRename: 'Avg CPC (USD)',
            },
          ];

          handleSheetExport('Explore', headers, rows, columnFormats);
        };

        const handleExportInsightsToSheet = () => {
          if (!insights) return;
          // Just put the markdown text in one cell
          const rows = [[htmlToMarkdown(insights)]];
          handleSheetExport('Insights', ['Insights Content'], rows);
        };

        const formatCampaignsForExport = campaigns => {
          if (!campaigns) return '';
          if (typeof campaigns === 'string') return htmlToMarkdown(campaigns);
          if (!Array.isArray(campaigns))
            return JSON.stringify(campaigns, null, 2);

          return campaigns
            .map(c => {
              let text = `Campaign: ${c.campaignName}\n`;
              if (c.adGroups) {
                c.adGroups.forEach(ag => {
                  text += `\nAd Group: ${ag.name}\n`;
                  if (ag.keywords)
                    text += `Keywords: ${ag.keywords.join(', ')}\n`;
                  if (ag.ads) {
                    ag.ads.forEach((ad, i) => {
                      text += `\nAd ${i + 1}:\n`;
                      if (ad.headlines)
                        text += `  Headlines: ${ad.headlines.join(' | ')}\n`;
                      if (ad.descriptions)
                        text += `  Descriptions: ${ad.descriptions.join(' | ')}\n`;
                    });
                  }
                });
              }
              return text;
            })
            .join('\n\n' + '-'.repeat(40) + '\n\n');
        };

        const handleExportCampaignsToSheet = () => {
          if (!campaignSuggestions) return;
          const text = formatCampaignsForExport(campaignSuggestions);
          const rows = [[text]];
          handleSheetExport('Campaign Suggestions', ['Campaign Content'], rows);
        };

        const handleDownloadCampaigns = () => {
          if (!campaignSuggestions) return;
          const text = formatCampaignsForExport(campaignSuggestions);
          downloadFile(text, 'giga_campaign_suggestions.md', 'text/markdown');
        };

        const loadExploreDemoData = async (randomize, delay = 0) => {
          if (!isDemoMode) return false;
          try {
            const cachedIdeas = localStorage.getItem('giga_ideasData');
            const cachedClusters = localStorage.getItem('giga_clusters');
            const cachedRelevantIdeas =
              localStorage.getItem('giga_relevantIdeas');
            const cachedLaels = localStorage.getItem('giga_chartLabels');

            if (cachedIdeas && cachedClusters) {
              if (delay > 0) {
                await new Promise(resolve => setTimeout(resolve, delay));
              }

              let parsedIdeas = JSON.parse(cachedIdeas);
              let parsedClusters = JSON.parse(cachedClusters);
              let parsedRelevant = cachedRelevantIdeas
                ? JSON.parse(cachedRelevantIdeas)
                : {};

              if (randomize) {
                const generateSmoothSeries = originalSeries => {
                  const length = Array.isArray(originalSeries)
                    ? originalSeries.length
                    : 12;
                  const series = [];
                  // Start between 10 and 100
                  let current = Math.floor(Math.random() * 90) + 10;
                  series.push(current);

                  for (let i = 1; i < length; i++) {
                    const volatility = Math.max(5, Math.round(current * 0.2));
                    const change =
                      Math.floor(Math.random() * (volatility * 2 + 1)) -
                      volatility;
                    current = Math.max(0, current + change);
                    series.push(current);
                  }

                  if (Math.random() < 0.2) {
                    const lastIdx = series.length - 1;
                    series[lastIdx] = Math.round(
                      series[lastIdx] * (2 + Math.random() * 3)
                    );
                  }
                  return series;
                };

                const randomizeGrowth = val =>
                  typeof val === 'number' ? val + (Math.random() - 0.5) : val;

                parsedIdeas = parsedIdeas.map(idea => ({
                  ...idea,
                  searchVolume: Array.isArray(idea.searchVolume)
                    ? generateSmoothSeries(idea.searchVolume)
                    : idea.searchVolume,
                }));

                parsedClusters = parsedClusters.map(c => {
                  const newHistory = Array.isArray(c.searchVolumeHistory)
                    ? generateSmoothSeries(c.searchVolumeHistory)
                    : c.searchVolumeHistory;
                  // Calculate avg for scalar volume
                  const avgVol =
                    Array.isArray(newHistory) && newHistory.length > 0
                      ? Math.round(
                          newHistory.reduce((a, b) => a + b, 0) /
                            newHistory.length
                        )
                      : 0;

                  return {
                    ...c,
                    searchVolume: avgVol,
                    searchVolumeHistory: newHistory,
                    growthYoY: randomizeGrowth(c.growthYoY),
                    growthMoM: randomizeGrowth(c.growthMoM),
                    growthLatestVsAvg: randomizeGrowth(c.growthLatestVsAvg),
                    growthLatestVsMax: randomizeGrowth(c.growthLatestVsMax),
                  };
                });

                Object.keys(parsedRelevant).forEach(k => {
                  if (Array.isArray(parsedRelevant[k])) {
                    parsedRelevant[k] = generateSmoothSeries(parsedRelevant[k]);
                  }
                });
              } else {
                // Explicitly reload original data to be safe
                parsedIdeas = JSON.parse(cachedIdeas);
                parsedClusters = JSON.parse(cachedClusters);
                parsedRelevant = cachedRelevantIdeas
                  ? JSON.parse(cachedRelevantIdeas)
                  : {};
              }

              setIdeasData(parsedIdeas);
              setClusters(parsedClusters);
              setRelevantIdeas(parsedRelevant);
              if (cachedLaels) setChartLabels(JSON.parse(cachedLaels));

              setExploreStatus('');
              setIsExploring(false);
              return true;
            }
          } catch (e) {
            console.warn('Failed to load demo cache', e);
          }
          return false;
        };

        const loadInsightsDemoData = async (randomize, delay = 0) => {
          if (!isDemoMode) return;
          try {
            const key = randomize ? 'giga_insights_random' : 'giga_insights';
            const cached = localStorage.getItem(key);

            if (delay > 0) {
              await new Promise(resolve => setTimeout(resolve, delay));
            }

            if (cached) {
              setInsights(JSON.parse(cached));
            } else {
              // If no specific cache exists, clear to avoid mismatch
              setInsights('');
            }
          } catch (e) {
            console.warn(e);
          }
        };

        useEffect(() => {
          const updateData = async () => {
            if (isDemoMode) {
              if (ideasData) {
                // setIsExploring(true);
                // setExploreStatus('Updating demo data...');
                await loadExploreDemoData(isRandomized, 0);
              }
              if (insights) {
                await loadInsightsDemoData(isRandomized, 0);
              }
            }
          };
          updateData();
        }, [isRandomized]);

        useEffect(() => {
          const handleKeyDown = e => {
            if (!isDemoMode) return;
            // Toggle on Shift + Alt + R
            if (e.shiftKey && e.altKey && e.code === 'KeyR') {
              console.log('Shortcut triggered: Toggling Randomization');
              e.preventDefault();
              setIsRandomized(prev => !prev);
            }
          };
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, [isDemoMode]);

        // Campaign Creation State
        const [creationAccountId, setCreationAccountId] = useStickyState(
          '',
          'giga_creationAccountId'
        );
        const [creationPromptTemplate, setCreationPromptTemplate] =
          useState('');
        const [creationStyleGuide, setCreationStyleGuide] = useStickyState(
          '<?= DEFAULT_STYLE_GUIDE ?>',
          'giga_creationStyleGuide'
        );
        const [creationInstructions, setCreationInstructions] = useStickyState(
          '',
          'giga_creationInstructions'
        );
        const [creationKeywords, setCreationKeywords] = useStickyState(
          '',
          'giga_creationKeywords'
        );
        const [growthMetric, setGrowthMetric] = useStickyState(
          'three_months_vs_avg',
          'growthMetric'
        );

        // Campaign Creation Settings
        const [creationLookbackDays, setCreationLookbackDays] = useStickyState(
          30,
          'giga_creationLookbackDays'
        );
        const [creationMetric, setCreationMetric] = useStickyState(
          'clicks',
          'giga_creationMetric'
        );

        // Gemini Configuration
        const [errorState, setErrorState] = useState({
          isOpen: false,
          title: '',
          message: '',
          stack: '',
        });

        const [configStatus, setConfigStatus] = useState({
          hasDeveloperToken: false,
          hasAdsAccountId: false,
          adsAccountId: '',
          checked: false,
        });

        // Sorting State
        const [sortConfig, setSortConfig] = useState({
          key: 'growth',
          direction: 'descending',
        });

        const requestSort = key => {
          let direction = 'descending';
          if (sortConfig.key === key && sortConfig.direction === 'descending') {
            direction = 'ascending';
          }
          setSortConfig({ key, direction });
        };

        const getSortIndicator = key => {
          if (sortConfig.key !== key) return null;
          return sortConfig.direction === 'ascending' ? ' ↑' : ' ↓';
        };

        useEffect(() => {
          googleScriptRun
            .getScriptPropertiesConfiguration()
            .then(status => {
              setConfigStatus({ ...status, checked: true });
              if (status.adsAccountId) {
                setAdsAccountId(status.adsAccountId);
              }
              if (status.spreadsheetUrl) {
                setSpreadsheetUrl(status.spreadsheetUrl);
              }
            })
            .catch(console.error);
        }, []);

        const showError = (title, error) => {
          console.error(error);
          setErrorState({
            isOpen: true,
            title: title,
            message: error.message || String(error),
            stack: error.stack || '',
          });
        };

        const [geminiConfig, setGeminiConfig] = useStickyState(
          {
            projectId: '',
            modelId: 'gemini-2.5-pro',
            temperature: 0.7,
            topP: 0.9,
          },
          'giga_geminiConfig'
        );

        // Migration for renamed keys
        useEffect(() => {
          if (
            geminiConfig.modelID !== undefined ||
            geminiConfig.projectID !== undefined
          ) {
            console.log('Migrating legacy geminiConfig keys...');
            setGeminiConfig(prev => {
              const newConfig = { ...prev };
              if (prev.modelID !== undefined) {
                newConfig.modelId = prev.modelID;
                delete newConfig.modelID;
              }
              if (prev.projectID !== undefined) {
                newConfig.projectId = prev.projectID;
                delete newConfig.projectID;
              }
              return newConfig;
            });
          }
        }, [geminiConfig]);
        const [creationResult, setCreationResult] = useStickyState(
          '',
          'giga_creationResult'
        );
        const [isCreatingCampaign, setIsCreatingCampaign] = useState(false);
        const [isGeneratingPrompt, setIsGeneratingPrompt] = useState(false);
        const [pendingAction, setPendingAction] = useState(null);
        const [devTokenInput, setDevTokenInput] = useState('*****');

        const clearCache = () => {
          localStorage.clear();
          onReset();
        };

        // Handlers
        const [modalConfig, setModalConfig] = useState({
          isOpen: false,
          type: '',
          value: '',
          message: '',
          link: '',
        });

        const showAlert = (message, link = '') => {
          setModalConfig({
            isOpen: true,
            type: 'alert',
            message: message,
            value: '',
            link: link,
          });
        };

        const handleCustomOption = type => {
          setModalConfig({ isOpen: true, type, value: '' });
        };

        const submitModal = () => {
          const { type, value } = modalConfig;
          if (value && !isNaN(Number(value))) {
            if (type === 'language') {
              setCustomLanguages([
                ...customLanguages,
                { id: value, name: value },
              ]);
              setLanguage(value);
            } else {
              setCustomCountries([
                ...customCountries,
                { id: value, name: value },
              ]);
              setCountry(value);
            }
            setModalConfig({ isOpen: false, type: '', value: '' });
          } else {
            showAlert('Only Number IDs are allowed.');
          }
        };

        useEffect(() => {
          if (configStatus.checked) {
            setDevTokenInput('');
          }
        }, [configStatus]);

        const runExplore = async overrideKeywords => {
          if (!useKeywordPlanner && !useGemini) {
            setHighlightKeywordSources(true);
            showAlert('At least one source needs to be selected.');
            return;
          }
          setHighlightKeywordSources(false);
          const keywordsToUse =
            typeof overrideKeywords === 'string' ? overrideKeywords : keywords;
          if (!keywordsToUse.trim()) {
            showAlert('Please enter at least one seed keyword.');
            return;
          }
          const seedKeywords = keywordsToUse
            .split(',')
            .map(k => k.trim())
            .filter(Boolean);
          if (seedKeywords.length > 20) {
            showAlert('Maximum 20 keywords allowed.');
            return;
          }

          setIsExploring(true);

          if (isDemoMode) {
            setExploreStatus('Getting keyword ideas...');

            if (await loadExploreDemoData(isRandomized, 1500)) {
              return;
            }
          }

          setExploreStatus('Verifying configuration...');
          let currentStatus = configStatus;
          try {
            const status = await googleScriptRun.getScriptPropertiesConfiguration();
            setConfigStatus({ ...status, checked: true });
            if (status.adsAccountId) {
              setAdsAccountId(status.adsAccountId);
            }
            currentStatus = status;
          } catch (e) {
            console.error('Failed to check script properties:', e);
            if (!configStatus.checked) {
              setIsExploring(false);
              showAlert(
                'Failed to verify configuration. Please check your connection and try again.'
              );
              return;
            }
          }

          if (!currentStatus.hasDeveloperToken && !currentStatus.adsAccountId) {
            setIsExploring(false);
            setPendingAction(() => runExplore);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'BOTH',
              message:
                'Please configure your Developer Token and Ads Account ID to proceed.',
            });
            return;
          }

          if (!currentStatus.hasDeveloperToken) {
            setIsExploring(false);
            setPendingAction(() => runExplore);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'DEVELOPER_TOKEN',
              message: 'Please configure your Developer Token to proceed.',
            });
            return;
          }
          if (!currentStatus.adsAccountId) {
            setIsExploring(false);
            setPendingAction(() => runExplore);
            setModalConfig({
              isOpen: true,
              type: 'settings',
              highlight: 'ADS_ACCOUNT_ID',
              message: 'Please configure your Ads Account ID to proceed.',
            });
            return;
          }

          setExploreStatus('Getting keyword ideas...');
          setIdeasData(null);
          setClusters(null);
          setSelectedCluster(null);

          try {
            let processedIdeas = [];

            if (useKeywordPlanner) {
              const ideas = await googleScriptRun.generateKeywordIdeas(
                seedKeywords,
                country || undefined,
                language || undefined,
                5000
              );

              const validIdeas = ideas.filter(
                res => res.keywordIdeaMetrics !== undefined
              );

              const plannerIdeas = validIdeas
                .flatMap(idea =>
                  (idea.closeVariants || [])
                    .concat(idea.text)
                    .map(k => [k, idea])
                )
                .map(([k, res]) => {
                  const metrics = res.keywordIdeaMetrics;
                  const volumes = metrics.monthlySearchVolumes.map(item =>
                    Number(item.monthlySearches)
                  );

                  const len = volumes.length;
                  const latest = len > 0 ? volumes[len - 1] : 0;
                  const prevMonth = len > 1 ? volumes[len - 2] : 0;
                  const prevYear = len > 12 ? volumes[len - 13] : 0;

                  const growthYoY =
                    prevYear !== 0 ? (latest - prevYear) / prevYear : 0;
                  const growthMoM =
                    prevMonth !== 0 ? (latest - prevMonth) / prevMonth : 0;

                  const totalSum = volumes.reduce((a, b) => a + b, 0);
                  const avg = len > 0 ? totalSum / len : 0;
                  const growthLatestVsAvg =
                    avg !== 0 ? (latest - avg) / avg : 0;

                  const max = Math.max(...volumes);
                  const growthLatestVsMax =
                    max !== 0 ? (latest - max) / max : 0;

                  const last3Months = volumes.slice(-3);
                  const prevMonths = volumes.slice(-24, -3);
                  const avgLast3 =
                    last3Months.length > 0
                      ? last3Months.reduce((a, b) => a + b, 0) /
                        last3Months.length
                      : 0;
                  const avgPrev =
                    prevMonths.length > 0
                      ? prevMonths.reduce((a, b) => a + b, 0) /
                        prevMonths.length
                      : 0;
                  const growthThreeMonthsVsAvg =
                    avgPrev !== 0 ? (avgLast3 - avgPrev) / avgPrev : 0;

                  return {
                    text: k,
                    searchVolume: volumes,
                    months: metrics.monthlySearchVolumes.map(
                      item => `${item.month} ${item.year}`
                    ),
                    latestSearchVolume: latest,
                    growthYoY,
                    growthMoM,
                    growthLatestVsAvg,
                    growthLatestVsMax,
                    growthThreeMonthsVsAvg,
                    competition: metrics.competition,
                    competition_index: metrics.competitionIndex,
                    low_top_of_page_bid_micros: metrics.lowTopOfPageBidMicros,
                    high_top_of_page_bid_micros: metrics.highTopOfPageBidMicros,
                    average_cpc_micros: metrics.averageCpcMicros,
                  };
                });
              processedIdeas = processedIdeas.concat(plannerIdeas);
            }

            if (useGemini) {
              setExploreStatus('Generating Gemini keywords...');

              let finalGeminiPrompt = geminiPrompt;
              const langName = [...LANGUAGES, ...customLanguages].find(
                l => l.id === language
              )?.name;
              if (langName) {
                finalGeminiPrompt += `\n\nOutput in ${langName}`;
              }
              const countryName = [...COUNTRIES, ...customCountries].find(
                c => c.id === country
              )?.name;
              if (countryName) {
                finalGeminiPrompt += `\nLocation: ${countryName}`;
              }

              const geminiKeywords =
                await googleScriptRun.generateTrendsKeywords(
                  seedKeywords,
                  finalGeminiPrompt,
                  geminiConfig
                );

              if (geminiKeywords && geminiKeywords.length > 0) {
                setExploreStatus('Fetching metrics for Gemini keywords...');
                const metrics = await googleScriptRun.getHistoricalMetrics(
                  geminiKeywords,
                  country || undefined
                );

                const geminiIdeas = metrics
                  .filter(m => m && m.text && m.keywordMetrics)
                  .map(metric => {
                    const hist = metric.keywordMetrics;
                    const volumes = (hist.monthlySearchVolumes || []).map(m =>
                      Number(m.monthlySearches)
                    );

                    const len = volumes.length;
                    const latest = len > 0 ? volumes[len - 1] : 0;
                    const prevMonth = len > 1 ? volumes[len - 2] : 0;
                    const prevYear = len > 12 ? volumes[len - 13] : 0;

                    const growthYoY =
                      prevYear !== 0 ? (latest - prevYear) / prevYear : 0;
                    const growthMoM =
                      prevMonth !== 0 ? (latest - prevMonth) / prevMonth : 0;

                    const totalSum = volumes.reduce((a, b) => a + b, 0);
                    const avg = len > 0 ? totalSum / len : 0;
                    const growthLatestVsAvg =
                      avg !== 0 ? (latest - avg) / avg : 0;

                    const max = Math.max(...volumes);
                    const growthLatestVsMax =
                      max !== 0 ? (latest - max) / max : 0;

                    const last3Months = volumes.slice(-3);
                    const prevMonths = volumes.slice(-24, -3);
                    const avgLast3 =
                      last3Months.length > 0
                        ? last3Months.reduce((a, b) => a + b, 0) /
                          last3Months.length
                        : 0;
                    const avgPrev =
                      prevMonths.length > 0
                        ? prevMonths.reduce((a, b) => a + b, 0) /
                          prevMonths.length
                        : 0;
                    const growthThreeMonthsVsAvg =
                      avgPrev !== 0 ? (avgLast3 - avgPrev) / avgPrev : 0;

                    return {
                      text: metric.text,
                      searchVolume: volumes,
                      months: (hist.monthlySearchVolumes || []).map(
                        m => `${m.month} ${m.year}`
                      ),
                      latestSearchVolume: latest,
                      growthYoY,
                      growthMoM,
                      growthLatestVsAvg,
                      growthLatestVsMax,
                      growthThreeMonthsVsAvg,
                      competition: hist.competition,
                      competition_index: hist.competitionIndex,
                      low_top_of_page_bid_micros: hist.lowTopOfPageBidMicros,
                      high_top_of_page_bid_micros: hist.highTopOfPageBidMicros,
                      average_cpc_micros: hist.averageCpcMicros,
                    };
                  });
                processedIdeas = processedIdeas.concat(geminiIdeas);
              }
            }

            // Deduplicate by text
            const uniqueIdeas = [];
            const seen = new Set();
            for (const idea of processedIdeas) {
              if (!seen.has(idea.text.toLowerCase())) {
                seen.add(idea.text.toLowerCase());
                uniqueIdeas.push(idea);
              }
            }
            processedIdeas = uniqueIdeas;

            if (processedIdeas.length > 0) {
              setChartLabels(processedIdeas[0].months.slice());
            }

            setIdeasData(processedIdeas);

            // Filter relevant ideas
            const relevant = {};
            processedIdeas.forEach(idea => {
              if (idea.searchVolume.at(0) >= minSearchVolume) {
                relevant[idea.text] = idea.searchVolume;
              }
            });
            setRelevantIdeas(relevant);

            if (useClustering) {
              setExploreStatus(`Clustering ${processedIdeas.length} ideas...`);

              const clusterResult = await googleScriptRun.getClusters(
                relevant,
                promptTemplate,
                geminiConfig
              );
              setClusters(clusterResult);
              setExploreStatus(
                `Done. Clustered ${processedIdeas.length} keywords.`
              );
            } else {
              setExploreStatus(
                `Done. Found ${processedIdeas.length} keywords (Clustering skipped).`
              );
            }
          } catch (e) {
            console.error(e);
            setExploreStatus(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsExploring(false);
          }
        };

        const generateInsights = async (language = 'English') => {
          if (Object.keys(relevantIdeas).length === 0) {
            showAlert('Please generate keywords in Explore tab first.');
            return;
          }
          setIsGeneratingInsights(true);

          if (isDemoMode) {
            const key = isRandomized ? 'giga_insights_random' : 'giga_insights';
            const cached = localStorage.getItem(key);

            if (cached) {
              await new Promise(resolve => setTimeout(resolve, 1500));
              setInsights(JSON.parse(cached));
              setIsGeneratingInsights(false);
              setInsightsStatus('');
              return;
            }
          }

          setInsightsStatus('');
          try {
            const seedKeywords = keywords
              .split(',')
              .map(k => k.trim())
              .filter(Boolean);
            const result = await googleScriptRun.getInsights(
              relevantIdeas,
              seedKeywords,
              growthMetric,
              geminiConfig,
              language
            );
            setInsights(result);

            if (isDemoMode) {
              const key = isRandomized
                ? 'giga_insights_random'
                : 'giga_insights';
              localStorage.setItem(key, JSON.stringify(result));
            }

            setInsightsStatus('');
          } catch (e) {
            setInsightsStatus(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsGeneratingInsights(false);
          }
        };

        const generateCampaignSuggestions = async () => {
          if (!relevantIdeas || Object.keys(relevantIdeas).length === 0) {
            showAlert('Please generate keywords in Explore tab first.');
            return;
          }
          setIsGeneratingCampaigns(true);
          setCampaignStatus('Generating suggestions...');
          try {
            let adExamples = '';
            let template = creationPromptTemplate;

            // If prompt template is missing but account ID is present, try to generate it first
            if (!template && creationAccountId.length >= 10) {
              setCampaignStatus('Generating Prompt Template...');
              template = await generatePrompt();
            }

            if (creationAccountId.length >= 10 && template) {
              adExamples = template;
            } else if (adsAccountId) {
              const ads = await googleScriptRun.getTopPerformingAdsAndKeywords(
                adsAccountId.replaceAll('-', '').trim(),
                10
              );
              adExamples = ads.map(ad => JSON.stringify(ad)).join('\n');
            }

            setCampaignStatus('Generating suggestions...');
            const langName =
              [...LANGUAGES, ...customLanguages].find(l => l.id === language)
                ?.name || language;
            const result = await googleScriptRun.getCampaigns(
              relevantIdeas,
              growthMetric,
              langName,
              brandName,
              adExamples,
              creationStyleGuide,
              geminiConfig
            );
            setCampaignSuggestions(result);
            setCampaignStatus('');
          } catch (e) {
            setCampaignStatus(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsGeneratingCampaigns(false);
          }
        };

        const generatePrompt = async () => {
          const id = creationAccountId.replaceAll('-', '').trim();
          if (!id) return null;

          setIsGeneratingPrompt(true);
          try {
            const result = await googleScriptRun.createCampaignPrompt(
              id,
              creationLookbackDays,
              creationMetric
            );
            setCreationPromptTemplate(result);
            setCreationResult('');
            return result;
          } catch (e) {
            setCreationResult(`Error: ${e.message}`);
            showError('Error', e);
            return null;
          } finally {
            setIsGeneratingPrompt(false);
          }
        };

        const generateNewCampaigns = async () => {
          setIsCreatingCampaign(true);
          try {
            let template = creationPromptTemplate;
            if (!template && creationAccountId.length >= 10) {
              setCreationResult('Generating Prompt Template...');
              template = await generatePrompt();
            }

            setCreationResult('Generating Ad Suggestions...');
            const kws = creationKeywords
              .split(',')
              .map(k => k.trim())
              .filter(Boolean);
            const prompt = `${creationStyleGuide}\n${creationInstructions}\n${template || ''}`;
            const result = await googleScriptRun.createAdSuggestion(
              prompt,
              kws,
              geminiConfig
            );
            setCreationResult(JSON.stringify(result, null, 2));
          } catch (e) {
            setCreationResult(`Error: ${e.message}`);
            showError('Error', e);
          } finally {
            setIsCreatingCampaign(false);
          }
        };

        // Charts Data Preparation
        const clustersChartData = useMemo(() => {
          if (!clusters) return null;
          const maxVol = Math.max(...clusters.map(c => c.searchVolume), 1);

          return {
            datasets: clusters.map((c, i) => {
              let yValue = 0;

              if (growthMetric === 'yoy') {
                yValue = c.growthYoY || c.yearOverYearGrowth || 0;
              } else if (growthMetric === 'mom') {
                yValue = c.growthMoM || 0;
              } else if (growthMetric === 'latest_vs_avg') {
                yValue = c.growthLatestVsAvg || 0;
              } else if (growthMetric === 'latest_vs_max') {
                yValue = c.growthLatestVsMax || 0;
              } else if (growthMetric === 'three_months_vs_avg') {
                yValue = c.growthThreeMonthsVsAvg || 0;
              }

              return {
                label: c.topic,
                data: [
                  {
                    x: c.searchVolume || 0,
                    y: yValue,
                    r: 5 + ((c.searchVolume || 0) / maxVol) * 45,
                  },
                ],
                backgroundColor: COLOR_PALETTE[i % COLOR_PALETTE.length],
              };
            }),
          };
        }, [clusters, growthMetric]);

        const selectedClusterChartData = useMemo(() => {
          if (!selectedCluster || !chartLabels.length) return null;
          const data = selectedCluster.searchVolumeHistory.slice();

          return {
            labels: chartLabels,
            datasets: [
              {
                label: `Search Volume: ${selectedCluster.topic}`,
                data: data,
                borderColor: COLOR_PALETTE[4],
                backgroundColor: COLOR_PALETTE[4] + '1A',
                fill: true,
                tension: 0.3,
              },
            ],
          };
        }, [selectedCluster, chartLabels]);

        const seedChartData = useMemo(() => {
          if (!ideasData || !keywords || !chartLabels.length) return null;
          const seeds = keywords
            .split(',')
            .map(k => k.trim().toLowerCase())
            .filter(Boolean);
          const seedIdeas = ideasData.filter(idea =>
            seeds.includes(idea.text.toLowerCase())
          );

          if (seedIdeas.length === 0) return null;

          return {
            labels: chartLabels,
            datasets: seedIdeas.map((idea, index) => {
              const color = COLOR_PALETTE[index % COLOR_PALETTE.length];

              return {
                label: idea.text,
                data: idea.searchVolume,
                borderColor: color,
                backgroundColor: color, // Same as border for legend
                fill: false, // No fill
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
              };
            }),
          };
        }, [ideasData, keywords, chartLabels]);

        const bubbleChartOptions = useMemo(() => {
          const textColor = theme === 'dark' ? '#f1f5f9' : '#1e293b';
          const gridColor = theme === 'dark' ? '#334155' : '#e2e8f0';
          return {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Search Volume',
                  color: textColor,
                },
                ticks: { color: textColor },
                grid: { color: gridColor },
              },
              y: {
                title: {
                  display: true,
                  text:
                    GROWTH_METRICS.find(m => m.id === growthMetric)?.name ||
                    'Growth',
                  color: textColor,
                },
                ticks: {
                  color: textColor,
                  callback: value =>
                    (value > 0 ? '+' : '') + (value * 100).toFixed(0) + '%',
                },
                grid: { color: gridColor },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx =>
                    `${ctx.dataset.label}: Vol ${ctx.raw.x}, Growth ${(ctx.raw.y > 0 ? '+' : '') + (ctx.raw.y * 100).toFixed(1)}%`,
                },
              },
            },
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const index = elements[0].datasetIndex;
                if (clusters && clusters[index]) {
                  setSelectedCluster(clusters[index]);
                  setTimeout(() => {
                    document
                      .getElementById('cluster-details')
                      ?.scrollIntoView({ behavior: 'smooth' });
                  }, 100);
                }
              }
            },
          };
        }, [growthMetric, clusters, theme]);

        const handleDownloadExplore = () => {
          if (!clusters) return;
          const headers = [
            'Cluster Topic',
            'Keyword',
            'Latest Search Volume',
            'Cluster Growth YoY',
            'Cluster Growth MoM',
            'Competition',
            'Low Bid (USD)',
            'High Bid (USD)',
            'Avg CPC (USD)',
          ];
          const rows = [];

          clusters.forEach(cluster => {
            cluster.keywords.forEach(kw => {
              const history = relevantIdeas[kw];
              const vol = history && history.length > 0 ? history[0] : 0;
              const idea = ideasData
                ? ideasData.find(i => i.text === kw)
                : null;

              rows.push([
                cluster.topic,
                kw,
                vol,
                (cluster.growthYoY * 100).toFixed(1) + '%',
                (cluster.growthMoM * 100).toFixed(1) + '%',
                idea ? idea.competition : '',
                idea
                  ? formatMicrosToCurrency(idea.low_top_of_page_bid_micros)
                  : '',
                idea
                  ? formatMicrosToCurrency(idea.high_top_of_page_bid_micros)
                  : '',
                idea ? formatMicrosToCurrency(idea.average_cpc_micros) : '',
              ]);
            });
          });

          const csv = convertToCSV(headers, rows);
          downloadFile(csv, 'giga_explore_clusters.csv', 'text/csv');
        };

        const handleDownloadInsights = () => {
          if (!insights) return;
          const md = htmlToMarkdown(insights);
          downloadFile(md, 'giga_insights.md', 'text/markdown');
        };

        // --- Render ---

        const handleSettingsSave = async newSettings => {
          setGeminiConfig(newSettings.geminiConfig);
          setMinSearchVolume(newSettings.minSearchVolume);
          setSpreadsheetUrl(newSettings.spreadsheetUrl);

          const promises = [];
          if (newSettings.adsAccountId !== configStatus.adsAccountId) {
            promises.push(
              updateScriptProperty('ADS_ACCOUNT_ID', newSettings.adsAccountId)
            );
          }
          if (newSettings.devToken) {
            promises.push(
              updateScriptProperty('DEVELOPER_TOKEN', newSettings.devToken)
            );
          }

          await Promise.all(promises);

          setModalConfig({ ...modalConfig, isOpen: false });
          if (pendingAction) {
            setTimeout(() => {
              pendingAction();
              setPendingAction(null);
            }, 100);
          }
        };

        const languageModal = (
          <Modal
            isOpen={modalConfig.isOpen && modalConfig.type === 'language'}
            onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
            title="Add Custom Language"
          >
            <div className="modal-body">
              <p className="text-sm text-muted mb-4">
                Enter the numeric Language ID from Google Ads API.
                <a
                  href={LANGUAGE_INFO_URL}
                  target="_blank"
                  rel="noopener noreferrer"
                  style={{ marginLeft: '4px', verticalAlign: 'middle' }}
                >
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '16px' }}
                  >
                    info
                  </span>
                </a>
              </p>
              <div className="input-group">
                <label>Language ID</label>
                <input
                  type="text"
                  value={modalConfig.value}
                  onChange={e =>
                    setModalConfig({ ...modalConfig, value: e.target.value })
                  }
                  placeholder="e.g. 1000"
                  autoFocus
                />
              </div>
              <div className="modal-actions">
                <button
                  className="btn"
                  onClick={() =>
                    setModalConfig({ ...modalConfig, isOpen: false })
                  }
                >
                  Cancel
                </button>
                <button className="btn btn-primary" onClick={submitModal}>
                  Add
                </button>
              </div>
            </div>
          </Modal>
        );

        const alertModal = (
          <Modal
            isOpen={modalConfig.isOpen && modalConfig.type === 'alert'}
            onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
            title="Alert"
            showCloseButton={false}
          >
            <div className="modal-body">
              <p>{modalConfig.message}</p>
              {modalConfig.link && (
                <p>
                  <a
                    href={modalConfig.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    style={{ wordBreak: 'break-all' }}
                  >
                    {modalConfig.link}
                  </a>
                </p>
              )}
              <div className="modal-actions">
                <button
                  className="btn btn-primary"
                  onClick={() =>
                    setModalConfig({ ...modalConfig, isOpen: false })
                  }
                >
                  OK
                </button>
              </div>
            </div>
          </Modal>
        );

        const updateScriptProperty = async (key, value) => {
          try {
            const status = await googleScriptRun.setScriptProperty(key, value);
            setConfigStatus({ ...status, checked: true });
            if (key === 'ADS_ACCOUNT_ID') {
              setAdsAccountId(value);
            }
            return true;
          } catch (e) {
            showError('Error updating property', e);
            return false;
          }
        };

        const handleOpenSettings = () => {
          setModalConfig({
            isOpen: true,
            type: 'settings',
            value: '',
            spreadsheetUrl: spreadsheetUrl,
          });
        };

        const locationModal = (
          <Modal
            isOpen={modalConfig.isOpen && modalConfig.type === 'country'}
            onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
            title="Add Custom Location"
          >
            <div className="modal-body">
              <p className="text-sm text-muted mb-4">
                Enter the numeric Location ID from Google Ads API.
                <a
                  href={LOCATION_INFO_URL}
                  target="_blank"
                  rel="noreferrer noopener"
                  style={{ marginLeft: '4px', verticalAlign: 'middle' }}
                >
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '16px' }}
                  >
                    info
                  </span>
                </a>
              </p>
              <div className="input-group">
                <label>Location ID</label>
                <input
                  type="text"
                  value={modalConfig.value}
                  onChange={e =>
                    setModalConfig({ ...modalConfig, value: e.target.value })
                  }
                  placeholder="e.g. 2840"
                  autoFocus
                />
              </div>
              <div className="modal-actions">
                <button
                  className="btn"
                  onClick={() =>
                    setModalConfig({ ...modalConfig, isOpen: false })
                  }
                >
                  Cancel
                </button>
                <button className="btn btn-primary" onClick={submitModal}>
                  Add
                </button>
              </div>
            </div>
          </Modal>
        );

        return (
          <div className="app">
            <div
              style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '20px',
              }}
            >
              <h1>GIGA</h1>
              <div
                style={{ display: 'flex', alignItems: 'center', gap: '16px' }}
              >
                <button
                  className="btn"
                  onClick={handleOpenSettings}
                  style={{
                    background: 'transparent',
                    color: 'var(--text-secondary)',
                    border: '1px solid var(--border-color)',
                    padding: '8px',
                  }}
                >
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '1.5rem' }}
                  >
                    settings
                  </span>
                </button>
                <button
                  className="btn"
                  onClick={toggleTheme}
                  style={{
                    background: 'transparent',
                    color: 'var(--text-secondary)',
                    border: '1px solid var(--border-color)',
                    padding: '8px',
                  }}
                  title={
                    theme === 'light'
                      ? 'Switch to Dark Mode'
                      : 'Switch to Light Mode'
                  }
                >
                  <span
                    className="material-symbols-outlined"
                    style={{ fontSize: '1.5rem' }}
                  >
                    {theme === 'light' ? 'dark_mode' : 'light_mode'}
                  </span>
                </button>
              </div>
            </div>

            <div className="tabs">
              <TabButton
                active={activeTab === 'explore'}
                onClick={() => setActiveTab('explore')}
              >
                Explore
              </TabButton>
              <TabButton
                active={activeTab === 'insights'}
                onClick={() => setActiveTab('insights')}
              >
                Insights
              </TabButton>
              <TabButton
                active={activeTab === 'campaigns'}
                onClick={() => setActiveTab('campaigns')}
              >
                Campaigns
              </TabButton>
            </div>

            {activeTab === 'explore' && (
              <ExploreTab
                keywords={keywords}
                setKeywords={setKeywords}
                runExplore={runExplore}
                isExploring={isExploring}
                exploreStatus={exploreStatus}
                ideasData={ideasData}
                setIdeasData={setIdeasData}
                setClusters={setClusters}
                setRelevantIdeas={setRelevantIdeas}
                setChartLabels={setChartLabels}
                setSelectedCluster={setSelectedCluster}
                language={language}
                setLanguage={setLanguage}
                country={country}
                setCountry={setCountry}
                customLanguages={customLanguages}
                customCountries={customCountries}
                handleCustomOption={handleCustomOption}
                promptTemplate={promptTemplate}
                setPromptTemplate={setPromptTemplate}
                seedChartData={seedChartData}
                clusters={clusters}
                growthMetric={growthMetric}
                setGrowthMetric={setGrowthMetric}
                handleDownloadExplore={handleDownloadExplore}
                handleExportExploreToSheet={handleExportExploreToSheet}
                isExporting={isExporting}
                clustersChartData={clustersChartData}
                bubbleChartOptions={bubbleChartOptions}
                selectedCluster={selectedCluster}
                selectedClusterChartData={selectedClusterChartData}
                chartLabels={chartLabels}
                relevantIdeas={relevantIdeas}
                useKeywordPlanner={useKeywordPlanner}
                setUseKeywordPlanner={setUseKeywordPlanner}
                useGemini={useGemini}
                setUseGemini={setUseGemini}
                geminiPrompt={geminiPrompt}
                setGeminiPrompt={setGeminiPrompt}
                useClustering={useClustering}
                setUseClustering={setUseClustering}
                highlightKeywordSources={highlightKeywordSources}
                setHighlightKeywordSources={setHighlightKeywordSources}
                theme={theme}
              />
            )}

            {activeTab === 'insights' && (
              <InsightsTab
                insights={insights}
                setInsights={setInsights}
                setInsightsStatus={setInsightsStatus}
                generateInsights={generateInsights}
                isGeneratingInsights={isGeneratingInsights}
                handleDownloadInsights={handleDownloadInsights}
                handleExportInsightsToSheet={handleExportInsightsToSheet}
                isExporting={isExporting}
                insightsStatus={insightsStatus}
                language={insightsLanguage}
                setLanguage={setInsightsLanguage}
              />
            )}

            {activeTab === 'campaigns' && (
              <CampaignsTab
                campaignSuggestions={campaignSuggestions}
                setCampaignSuggestions={setCampaignSuggestions}
                setCampaignStatus={setCampaignStatus}
                brandName={brandName}
                setBrandName={setBrandName}
                creationKeywords={creationKeywords}
                setCreationKeywords={setCreationKeywords}
                creationResult={creationResult}
                setCreationResult={setCreationResult}
                creationAccountId={creationAccountId}
                setCreationAccountId={setCreationAccountId}
                creationInstructions={creationInstructions}
                setCreationInstructions={setCreationInstructions}
                creationPromptTemplate={creationPromptTemplate}
                setCreationPromptTemplate={setCreationPromptTemplate}
                creationStyleGuide={creationStyleGuide}
                setCreationStyleGuide={setCreationStyleGuide}
                showIdInfo={showIdInfo}
                setShowIdInfo={setShowIdInfo}
                showBrandInfo={showBrandInfo}
                setShowBrandInfo={setShowBrandInfo}
                isGeneratingPrompt={isGeneratingPrompt}
                isCreatingCampaign={isCreatingCampaign}
                generatePrompt={generatePrompt}
                generateNewCampaigns={generateNewCampaigns}
                campaignStatus={campaignStatus}
                isGeneratingCampaigns={isGeneratingCampaigns}
                generateCampaignSuggestions={generateCampaignSuggestions}
                handleDownloadCampaigns={handleDownloadCampaigns}
                handleExportCampaignsToSheet={handleExportCampaignsToSheet}
                isExporting={isExporting}
                GOOGLE_ADS_ID_HELP_URL={GOOGLE_ADS_ID_HELP_URL}
                creationLookbackDays={creationLookbackDays}
                setCreationLookbackDays={setCreationLookbackDays}
                creationMetric={creationMetric}
                setCreationMetric={setCreationMetric}
              />
            )}

            {languageModal}
            {locationModal}

            <SettingsModal
              isOpen={modalConfig.isOpen && modalConfig.type === 'settings'}
              onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
              modalConfig={modalConfig}
              geminiConfig={geminiConfig}
              minSearchVolume={minSearchVolume}
              configStatus={configStatus}
              onSave={handleSettingsSave}
              onClearCache={clearCache}
            />
            {alertModal}

            <Modal
              isOpen={showVersionModal}
              onClose={() => {}}
              title={`Update Available (${APP_VERSION})`}
              showCloseButton={false}
            >
              <div className="modal-body">
                <div
                  className="alert alert-warning mb-4"
                  style={{
                    background: '#eff6ff',
                    border: '1px solid #bfdbfe',
                    color: '#1e40af',
                    padding: '15px',
                    borderRadius: '8px',
                  }}
                >
                  <h3 style={{ marginTop: 0, fontSize: '1.1rem' }}>
                    New Version Detected
                  </h3>
                  <p>
                    A new version of GIGA is available. It is recommended to
                    clear your local cache to ensure compatibility with new
                    features.
                  </p>
                  <p className="text-sm mt-2">
                    <strong>Update Type:</strong>{' '}
                    {versionUpdateType.toUpperCase()}
                  </p>
                </div>

                <div className="modal-actions">
                  <button
                    className="btn"
                    onClick={() => handleVersionUpdate(false)}
                  >
                    Keep Cache (Risk of Errors)
                  </button>
                  <button
                    className="btn btn-primary"
                    onClick={() => handleVersionUpdate(true)}
                  >
                    Clear Cache & Update
                  </button>
                </div>
              </div>
            </Modal>

            <ErrorModal
              isOpen={errorState.isOpen}
              onClose={() => setErrorState({ ...errorState, isOpen: false })}
              error={errorState}
            />
            {isDemoMode && isRandomized && (
              <div className="warning-footer">
                ⚠ Search volume and other metrics are randomized for
                demonstration ⚠
              </div>
            )}
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        const [resetKey, setResetKey] = useState(0);
        const [isDemoMode, setIsDemoMode] = useState(false);
        const [isReady, setIsReady] = useState(false);

        useEffect(() => {
          const checkDemo = () => {
            if (
              typeof google !== 'undefined' &&
              google.script &&
              google.script.url
            ) {
              try {
                google.script.url.getLocation(location => {
                  const demo = location.parameter['demo'] === 'true';
                  console.log('Demo Mode:', demo);
                  setIsDemoMode(demo);
                  setIsReady(true);
                });
              } catch (e) {
                console.warn('Error checking location:', e);
                setIsReady(true);
              }
            } else {
              setIsReady(true);
            }
          };

          checkDemo();

          // Safety timeout
          const timer = setTimeout(() => {
            if (!isReady) setIsReady(true);
          }, 2000);
          return () => clearTimeout(timer);
        }, [isReady]);

        const handleReset = () => setResetKey(prev => prev + 1);

        if (!isReady) {
          return (
            <div
              style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                height: '100vh',
                fontFamily: 'sans-serif',
                color: '#64748b',
              }}
            >
              Loading GIGA...
            </div>
          );
        }

        return (
          <GigaApp
            key={resetKey}
            onReset={handleReset}
            isDemoMode={isDemoMode}
          />
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
