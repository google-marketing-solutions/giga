<!--
Copyright 2025 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!doctype html>
<html>
  <header>
    <link href="https://fonts.cdnfonts.com/css/google-sans" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        background: #f8f9fa;
        font-family: 'Product Sans', sans-serif;

        width: 100%;
        max-width: 1000px;
        margin: 1em auto;
      }

      button {
        margin-top: 10px;
        background-color: #027ad6;
        font-weight: bold;
        border-radius: 2px;
        outline: none;
        border: 1px solid #027ad6;
        color: white;
        transition: background-color 150ms linear;
        cursor: pointer;
      }

      button:not(.flat-button) {
        padding: 15px;
      }

      button:hover:not(:disabled),
      button.back {
        background-color: white;
        border: 1px solid #027ad6;
        color: #027ad6;
      }

      button.back:hover {
        background-color: #027ad6;
        border: 1px solid #027ad6;
        color: white;
      }

      button:disabled,
      button[disabled] {
        cursor: auto;
        background-color: #ccc !important;
        border-color: #bbb !important;
        color: white !important;
      }

      #advanced-config {
        background-color: lavender;
        border-radius: 1em;
        margin: 0.5em;
        padding: 1em;
      }

      .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
      }

      .tab button {
        background-color: rgb(5 122 215);
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 17px;
      }

      .tab button:hover {
        background-color: #ddd;
      }

      .tab button.active {
        background-color: #ccc;
      }

      .tabcontent {
        display: none;
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-top: none;
      }
    </style>
  </header>

  <body id="appsScriptWebAppBody">
    <h1>GIGA - Gemini Insights Generation Analysis</h1>

    <div class="tab">
      <button class="tablinks" onclick="openTab(event, 'Explore-Tab')">
        Explore
      </button>
      <button class="tablinks" onclick="openTab(event, 'Insights-Tab')">
        Insights
      </button>
      <button class="tablinks" onclick="openTab(event, 'Campaigns-Tab')">
        Campaign Suggestions
      </button>
      <button class="tablinks" onclick="openTab(event, 'CampaignCreation-Tab')">
        Campaign Creation
      </button>
    </div>

    <div id="Explore-Tab" class="tabcontent">
      <br /><br /><br />
      <div><strong>Keywords</strong></div>
      <div>Comma separated, up to 20</div>
      <input type="text" value="" id="topics" size="50" />

      <br />
      <br />

      <div><strong>Language</strong></div>
      <div>Language of generated keyword ideas</div>
      <div>
        To add a custom language please see
        <a
          href="https://developers.google.com/google-ads/api/data/codes-formats#languages"
          target="_blank"
          rel="noopener noreferrer"
          >Codes and formats
        </a>
        for details
      </div>

      <select
        id="language"
        onchange="addOption(this, 'Please enter your numeric ID for the language of the keyword Ideas (e.g. 1000 for English or 1001 for German, please see see https://developers.google.com/google-ads/api/data/codes-formats#languages for the correct ID):')"
      >
        <option value="1000">English</option>
        <option value="1001">German</option>
        <option value="1002">French</option>
        <option value="1003">Spanish</option>
        <option value="1004">Italian</option>
        <option value="1009">Danish</option>
        <option value="1010">Dutch</option>
        <option value="1011">Finnish</option>
        <option value="1015">Swedish</option>
        <option value="1020">Bulgarian</option>
        <option value="1021">Czech</option>
        <option value="1022">Greek</option>
        <option value="1024">Hungarian</option>
        <option value="1028">Latvian</option>
        <option value="1029">Lithuanian</option>
        <option value="1030">Polish</option>
        <option value="1031">Russian</option>
        <option value="1032">Romanian</option>
        <option value="1033">Slovak</option>
        <option value="1034">Slovenian</option>
        <option value="1036">Ukrainian</option>
        <option value="1038">Catalan</option>
        <option value="1039">Croatian</option>
        <option value="1043">Estonian</option>
        <option value="1064">Persian</option>
        <option value="">Enter custom ID...</option>
      </select>

      <br />
      <br />

      <div><strong>Location</strong></div>
      <div>Where the search was issued</div>
      <div>
        To add custom country please see
        <a
          href="https://developers.google.com/google-ads/api/data/geotargets"
          target="_blank"
          rel="noopener noreferrer"
          >Geo targets</a
        >
        for details
      </div>
      <select
        id="country"
        onchange="addOption(this, 'Please enter your numeric ID for your target (e.g. 2276 for Germany or 2826 for UK, please see see https://developers.google.com/google-ads/api/data/geotargets for the correct ID):')"
      >
        <option value="">Worldwide</option>

        <option value="2276">Germany</option>
        <option value="2826">UK</option>
        <option value="2250">France</option>
        <option value="2380">Italy</option>
        <option value="2756">Switzerland</option>
        <option value="2724">Spain</option>
        <option value="2616">Poland</option>
        <option value="2642">Romania</option>
        <option value="2528">Netherlands</option>
        <option value="2056">Belgium</option>
        <option value="2203">Czechia</option>
        <option value="2300">Greece</option>
        <option value="2620">Portugal</option>
        <option value="2752">Sweden</option>
        <option value="2348">Hungary</option>
        <option value="2040">Austria</option>
        <option value="2100">Bulgaria</option>
        <option value="2208">Denmark</option>
        <option value="2703">Slovakia</option>
        <option value="2246">Finland</option>
        <option value="2372">Ireland</option>
        <option value="2191">Croatia</option>
        <option value="2440">Lithuania</option>
        <option value="2705">Slovenia</option>
        <option value="2428">Latvia</option>
        <option value="2233">Estonia</option>
        <option value="2196">Cyprus</option>
        <option value="2442">Luxembourg</option>
        <option value="2470">Malta</option>
        <option value="">Enter custom ID...</option>
      </select>

      <br />
      <br />

      <script>
        function addOption(select, text) {
          if (select.value === '') {
            let id = prompt(text);
            if (!id) {
              select.selectedIndex = 0;
            } else if (isNaN(Number(id))) {
              alert('Only Number IDs are allowed.');
              select.selectedIndex = 0;
            } else {
              select.add(new Option(id, id));
              select.value = id;
            }
          }
        }
      </script>

      <section id="config_section">
        <details>
          <summary>Advanced Config</summary>
          <div id="advanced-config">
            <div><strong>Clustering prompt</strong></div>
            <textarea id="promptTemplate" rows="8" cols="80">
You are given a list of Google Ads keyword ideas.
Your task is to create 10 clusters. For each cluster use only up to 20 keywords that are most representative of that cluster.
Make sure to only assign the keywords provided to the cluster and do not invent new keywords.
All keywords assigned to a cluster must be exactly the same (e.g. same case, same spacing, same accents).

The Google Ads keyword ideas are:

          </textarea
            >
            <!-- </p> -->
          </div>
        </details>
      </section>

      <button id="run-button" onclick="run()">Start</button>

      <div>
        <canvas
          id="ideasChart"
          style="display: none; width: 100%; max-width: 1440px"
        ></canvas>
      </div>

      <br />

      <div id="clusters">
        <canvas
          id="clustersChart"
          style="display: none; width: 100%; max-width: 1440px"
        ></canvas>
      </div>

      <div>
        <canvas
          id="clusterChart"
          style="display: none; width: 100%; max-width: 1440px"
        ></canvas>
      </div>

      <div>
        <canvas
          id="cluserKeywordsChart"
          style="display: none; width: 100%; max-width: 1440px"
        ></canvas>
      </div>
      <div id="explore-status"></div>
    </div>

    <div id="Insights-Tab" class="tabcontent">
      <br /><br /><br />
      <div id="insights"></div>
      <br />
      <br /><button id="generateInsights-button" onclick="generateInsights()">
        Generate Insights
      </button>
      <div id="insights-status"></div>
    </div>

    <div id="Campaigns-Tab" class="tabcontent">
      <br /><br /><br />

      <div><strong>Tailor ads to account style</strong></div>
      <div>ID for the Google Ads account</div>
      <input type="text" value="" id="ads-account-id" size="15" />
      <br />

      <div>Brand name</div>
      <input type="text" value="" id="brand-name" size="15" />
      <br />

      <br /><br /><br />

      <div id="campaigns"></div>
      <br />
      <br /><button
        id="generateCampaigns-button"
        onclick="generateCampaignSuggestions()"
      >
        Generate Campaigns
      </button>
      <div id="campaign-status"></div>
    </div>

    <div id="CampaignCreation-Tab" class="tabcontent">
      <br /><br /><br />
      <div><strong>Google Ads Account ID</strong></div>
      <div>ID for the Google Ads Account</div>
      <input
        type="text"
        value="111-222-3333"
        id="google-ads-account-id"
        size="15"
      />
      <br /><br /><br />

      <textarea id="newCampaignpromptTemplate" rows="8" cols="80"> </textarea>
      <br />

      <br /><button
        id="generateNewCampaignsPrompt-button"
        onclick="generateNewCampaignsPrompt()"
      >
        Generate Pre-Prompt for best performing ads
      </button>
      <br /><br /><br />

      <div><strong>Style guide for creating ads</strong></div>
      <textarea id="adCreationStyleGuideDefault" rows="10" cols="80">
<?= DEFAULT_STYLE_GUIDE ?>
      </textarea>
      <br /><br /><br />

      <div><strong>Additional instructions (optional)</strong></div>
      <textarea id="adCreationStyleGuideUser" rows="4" cols="80">
    Created ads must be in German.
    </textarea
      >

      <br /><br /><br />
      <div><strong>Campaign Keywords</strong></div>
      <div>
        Based on those keywords a new campaign will be created. Input them comma
        separated.
      </div>
      <input type="text" value="" id="campaign-keywords" size="100" />
      <br /><br /><br />

      <pre id="campaigns-creation-result"></pre>
      <br /><button
        id="generateNewCampaigns-button"
        onclick="generateNewCampaigns()"
      >
        Generate
      </button>
      <div id="campaign-status"></div>
    </div>
    <br />
  </body>
</html>

<script>
  const googleScriptRun = new Proxy(
    {},
    {
      get:
        (target, prop, receiver) =>
        (...args) => {
          console.log(`Running ${prop} in AppsScript backend...`);
          if (prop in google.script.run) {
            return new Promise((resolve, reject) =>
              google.script.run
                .withSuccessHandler(res => resolve(res))
                .withFailureHandler(err => {
                  throw err;
                })
                [prop](...args)
            );
          } else {
            throw new Error(`No function in AppScript named '${prop}'`);
          }
        },
    }
  );

  const containsStringIgnoreCase = (array, str) => {
    const lowerStr = str.toLowerCase();
    return array.some(item => item.toLowerCase() === lowerStr);
  };

  const setInnerHtml = (elementId, text) =>
    (document.getElementById(elementId).innerHTML = text);

  const rgbaToRgb = rgba => {
    const [_, r, g, b] = rgba.match(
      /rgba?\((\d+),\s*(\d+),\s*(\d+),?\s*([0-9.]+)?\)/
    );
    return `rgb(${r}, ${g}, ${b})`;
  };

  const zip = (a, b) => a.map((item, index) => [item, b[index]]);
</script>

<script>
  const reset = () => {
    [
      'cluserKeywordsChart',
      'clustersChart',
      'clusterChart',
      'ideasChart',
    ].forEach(id => (document.getElementById(id).style.display = 'none'));
    ['campaigns', 'insights'].forEach(id => setInnerHtml(id, ''));
  };

  const showClusterKeywordsChart = cluster => {
    const element = document.getElementById('cluserKeywordsChart');
    // remove previous chart
    Chart.getChart(element)?.destroy();
    element.style.display = '';

    const datasets = zip(cluster.keywords, cluster.searchVolumes).map(
      ([keywordText, searchVolume]) => ({
        label: keywordText,
        data: searchVolume,
      })
    );
    new Chart(element, {
      type: 'line',
      data: {
        labels: ideasChart.data.labels,
        datasets,
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Search Volume',
            },
          },
        },
        plugins: {
          legend: {
            display: true,
            labels: {
              color: 'rgb(255, 99, 132)',
            },
          },
        },
      },
    });
  };

  const showClustersChart = clusters => {
    const element = document.getElementById('clustersChart');
    // remove previous chart
    Chart.getChart(element)?.destroy();
    element.style.display = '';

    const maxSearchVolume = clusters.reduce(
      (max, cluster) => Math.max(max, cluster.searchVolume),
      0
    );
    const maxRadiusPixels = 50;
    const minRadiusPixel = 5;
    const datasets = clusters.map(cluster => ({
      label: cluster.topic,
      data: [
        {
          x: cluster.searchVolume,
          y: cluster.yearOverYearGrowth,
          r:
            minRadiusPixel +
            (cluster.searchVolume / maxSearchVolume) *
              (maxRadiusPixels - minRadiusPixel),
          label: cluster.topic,
        },
      ],
    }));

    const chart = new Chart(element, {
      type: 'bubble',
      data: {
        labels: clusters.map(cluster => cluster.searchVolume),
        datasets,
      },
      options: {
        onClick: function (evt) {
          const points = chart.getElementsAtEventForMode(
            evt,
            'nearest',
            { intersect: true },
            false
          );
          if (points.length > 0) {
            const datasetIndex = points[0].datasetIndex;
            const cluster = clusters[datasetIndex];
            const color = chart.data.datasets[datasetIndex].backgroundColor;

            showIdeasChart(
              [
                {
                  text: cluster.topic,
                  searchVolume: cluster.searchVolumeHistory,
                  months: ideasChart.data.labels,
                },
              ],
              'clusterChart',
              rgbaToRgb(color)
            );

            showClusterKeywordsChart(cluster);
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'YoY Growth',
            },
          },
          x: {
            title: {
              display: true,
              text: 'Search Volume',
            },
          },
        },
      },
    });
  };

  var ideasChart;

  const showIdeasChart = (ideas, elementId, color) => {
    const element = document.getElementById(elementId);
    // remove previous chart
    Chart.getChart(element)?.destroy();
    element.style.display = '';

    const datasets = ideas.map(idea => ({
      label: idea.text,
      data: idea.searchVolume,
      backgroundColor: color,
    }));
    ideasChart = new Chart(element, {
      type: 'line',
      data: {
        labels: ideas[0].months,
        datasets,
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Search Volume',
            },
          },
        },
      },
    });
  };

  const getSelectedLanguage = () => {
    var select = document.getElementById('language');
    return select.options[select.selectedIndex].text;
  };

  const getSeedKeywords = () => {
    const seedKeywordsUserInput = document.getElementById('topics').value;
    if (seedKeywordsUserInput === '') {
      alert(`Please enter at least one seed keyword (Explore Tab).`);
      return [];
    }
    return seedKeywordsUserInput.split(', ').map(k => k.trim());
  };

  const generateNewCampaignsPrompt = async () => {
    const status = document.getElementById('newCampaignpromptTemplate');
    status.value = 'Generating prompt...';
    const adsAccountID = document
      .getElementById('google-ads-account-id')
      .value.replaceAll('-', '')
      .trim();
    const topN = 10;
    const prompt = await googleScriptRun.getTopPerformingAdsPrompt(
      adsAccountID,
      topN
    );
    status.value = prompt;
  };

  const generateNewCampaigns = async () => {
    const campaignKeywords = document
      .getElementById('campaign-keywords')
      .value.split(',')
      .map(keyword => keyword.trim());
    const status = document.getElementById('campaigns-creation-result');
    status.innerHTML = 'generating ad...';
    const promptTemplate = document.getElementById(
      'newCampaignpromptTemplate'
    ).value;

    const adCreationStyleGuideDefault = document.getElementById(
      'adCreationStyleGuideDefault'
    ).value;
    const adCreationStyleGuideUser = document.getElementById(
      'adCreationStyleGuideUser'
    ).value;

    const prompt = `${adCreationStyleGuideDefault}
      ${adCreationStyleGuideUser}
      ${promptTemplate}`;

    console.log(prompt);

    const newCampaign = await googleScriptRun.createAdSuggestion(
      prompt,
      campaignKeywords
    );
    console.log(newCampaign);
    status.innerHTML = JSON.stringify(newCampaign, null, 2);
  };

  const generateCampaignSuggestions = async () => {
    if (insights.length === 0) {
      alert('Please first generate Insights.');
      return;
    }

    document.getElementById('generateCampaigns-button').disabled = true;

    // todo check if relevant ideas is empty
    const status = document.getElementById('campaign-status');
    status.innerHTML = 'Generating campaign suggestions...';
    const languageSelector = document.getElementById('language');
    const language =
      languageSelector.options[languageSelector.selectedIndex].text;
    const adsAccountID = document
      .getElementById('ads-account-id')
      .value.replaceAll('-', '')
      .trim();

    let adExamples = '';

    if (adsAccountID) {
      const topN = 10;
      const adsWithKeywords =
        await googleScriptRun.getTopPerformingAdsAndKeywords(
          adsAccountID,
          topN
        );

      adExamples = adsWithKeywords.map(ad => JSON.stringify(ad)).join('\n');
      console.log(adExamples);
    }

    const brandName = document.getElementById('brand-name').value;
    console.log({ adsWithKeywords });

    const campaigns = await googleScriptRun.getCampaigns(
      insights,
      language,
      brandName,
      adExamples
    );
    setInnerHtml('campaigns', campaigns + '<br><br>');
    status.innerHTML = '';
    document.getElementById('generateCampaigns-button').disabled = false;
  };

  const generateInsights = async () => {
    if (relevantIdeas.length === 0) {
      alert(
        'Please first enter seed keywords in the Explore Tab and hit the start button.'
      );
      return;
    }

    document.getElementById('generateInsights-button').disabled = true;

    // todo check if relevant ideas is empty
    const status = document.getElementById('insights-status');
    status.innerHTML = 'Generating insights...';
    insights = await googleScriptRun.getInsights(
      relevantIdeas,
      getSeedKeywords()
    );
    setInnerHtml('insights', insights);
    document.getElementById('generateInsights-button').disabled = false;
    status.innerHTML = '';
  };

  let relevantIdeas = [];
  let insights = '';

  const run = async () => {
    reset();

    try {
      const status = document.getElementById('explore-status');
      status.innerHTML = 'Get keyword ideas...';

      const MAX_SEED_KEYWORDS = 20;

      const seedKeywords = getSeedKeywords();
      console.log({ seedKeywords });
      if (seedKeywords.length === 0) return;

      if (seedKeywords.length > MAX_SEED_KEYWORDS) {
        alert(`Please enter a maximum of ${MAX_SEED_KEYWORDS} keywords only.`);
        return;
      }

      document.getElementById('run-button').disabled = true;

      const geoID = document.getElementById('country').value || undefined;
      const languageID = document.getElementById('language').value || undefined;
      console.log('geoID:', geoID, 'languageID', languageID);

      const MAX_IDEAS = 5000;
      const MIN_SEARCH_VOLUME_THREASHOLD_FOR_LATEST_MONTH = 0;

      const ideas = (
        await googleScriptRun.generateKeywordIdeas(
          seedKeywords,
          geoID,
          languageID,
          MAX_IDEAS
        )
      ).filter(res => res.keywordIdeaMetrics !== undefined);

      const expandIdeaWithCloseVariants = idea =>
        (idea.closeVariants || [])
          .concat(idea.text)
          .map(keyword => [keyword, idea]);

      const ideasData = ideas
        .flatMap(expandIdeaWithCloseVariants)
        .map(([keyword, res]) => ({
          text: keyword,
          searchVolume: res.keywordIdeaMetrics.monthlySearchVolumes.map(item =>
            Number(item.monthlySearches)
          ),
          months: res.keywordIdeaMetrics.monthlySearchVolumes.map(
            item => `${item.month} ${item.year}`
          ),
        }));

      console.log(ideasData);

      const seedKeywordsChartData = ideasData.filter(res =>
        seedKeywords.map(k => k.toLowerCase()).includes(res.text)
      );
      console.log({ seedKeywordsChartData });
      showIdeasChart(seedKeywordsChartData, 'ideasChart');

      relevantIdeas = Object.fromEntries(
        ideasData
          .filter(
            idea =>
              idea.searchVolume.at(-1) >
              MIN_SEARCH_VOLUME_THREASHOLD_FOR_LATEST_MONTH
          )
          .map(idea => [idea.text, idea.searchVolume])
      );

      console.log({ relevantIdeas });

      status.innerHTML = `Generating clusters of <strong> ${ideasData.length} keyword ideas </strong> related to: ${seedKeywords.join(',')} ...`;

      const promptTemplate = document.getElementById('promptTemplate').value;
      console.log('promptTemplate:', promptTemplate);

      try {
        const clusters = await googleScriptRun.getClusters(
          relevantIdeas,
          promptTemplate
        );
        console.log({ clusters });
        showClustersChart(clusters);
      } catch (clusterError) {
        console.log('Error during clustering', clusterError.message);
        console.log(clusterError);
      }

      status.innerHTML = `Done. Clustered <strong> ${ideasData.length} keyword ideas </strong> related to: ${seedKeywords.join(',')}.`;
    } catch (e) {
      alert(e.message);
    } finally {
      document.getElementById('run-button').disabled = false;
    }
  };
</script>

<script>
  function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName('tabcontent');
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = 'none';
    }
    tablinks = document.getElementsByClassName('tablinks');
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(' active', '');
    }
    document.getElementById(tabName).style.display = 'block';
    evt.currentTarget.className += ' active';
  }
</script>
